<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>
  // Point pdf.js to the correct worker file
  pdfjsLib.GlobalWorkerOptions.workerSrc = 
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
  </script>

  <style>
    body {
  font-family: 'Poppins', sans-serif;
  margin: 0;
  background: url('https://storage.googleapis.com/flutterflow-io-6f20.appspot.com/projects/sfproject7-oqutkl/assets/5mw1e2xel6k6/BG1.webp') 
              no-repeat center center fixed;
  background-size: cover;
  color: #333;
  padding-bottom: 90px;
}


/* Header + Search */
.header {
  padding: 12px;
  background: #fff;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  position: sticky;
  top: 0;
  z-index: 1000;
}
.search-bar {
  width: 100%;
  padding: 12px;
  border: 1px solid #ddd;
  border-radius: 25px;
  font-size: 14px;
  outline: none;
}

.banner {
  width: 100%;
  height: 160px;       /* fixed height */
  border-radius: 14px;
  margin: 12px 0;
  overflow: hidden;
}

.banner img {
  width: 100%;
  height: 100%;
  object-fit: cover;   /* crop to fill box */
  display: block;
}


/* Section Header */
.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 14px;
  margin-top: 10px;
}
.section-title {
  font-weight: 600;
  font-size: 16px;
}
.see-all {
  font-size: 13px;
  color: #3498db;
  cursor: pointer;
}

/* Horizontal scroll list */
.h-scroll {
  display: flex;
  overflow-x: auto;
  gap: 16px;
  padding: 22px 14px;
}

.circle-btn {
  flex: 0 0 auto;
  cursor: pointer;
  position: relative;
}
.circle-shape {
  width: 70px;
  height: 70px;
  border-radius: 50%;
  background: #fff;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  display: flex;
  justify-content: center;
  align-items: center;
  transition: 0.2s;
  overflow: hidden;
  position: relative;
}
.circle-shape img {
  width: 60%;
  height: 60%;
  object-fit: contain;
}
.circle-shape:hover {
  transform: scale(1.05);
  background: #f0f8ff;
}

/* Tooltip for names */
.circle-btn:hover::after {
  content: attr(data-name);
  position: absolute;
  bottom: -25px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 12px;
  color: #333;
  background: #fff;
  padding: 3px 6px;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  white-space: nowrap;
}

/* Badge container (handles positioning + stacking) */
.badges-wrapper {
  position: absolute;
  top: 8px;
  right: 8px;
  display: flex;
  flex-direction: row;   /* ‚¨Ö make horizontal */
  gap: 6px;              /* space between badges */
  flex-wrap: wrap;       /* if too many, they wrap to next line */
  align-items: flex-start;
}


/* Badge (base style) */
.badge {
  position: relative;   /* stacked inside wrapper */
  color: #fff;
  font-size: 11px;
  padding: 3px 8px;
  border-radius: 12px;   /* pill shape */
  font-weight: 600;
  box-shadow: 0 1px 4px rgba(0,0,0,0.15);
  white-space: nowrap;
  border: 2px solid transparent; /* default border */
}

/* Variants */
.badge-sale { background: darkred; }
.badge-new { background: darkgreen; }
.badge-hot { background: orangered; }
.badge-featured { background: darkblue; }



/* Products wrapper with scroll */
.products-wrapper {
  max-height: 420px;
  overflow-y: auto;
  margin: 0 14px 24px;
  padding-right: 6px;
  border-radius: 12px;
  background: #fafafa;
  padding-bottom: 90px; 
}

/* Products grid */
.products {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 14px;
  padding: 10px;
}
.product-card {
  position: relative; 
  background: #fff;
  border-radius: 12px;
  padding: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transition: 0.2s;
  cursor: pointer;
  position: relative;
  border: 2px solid transparent; /* default border */
}

.product-card {
  position: relative;
  overflow: hidden;   /* ‚¨Ö confetti & text will stay inside */
}

.product-card .card-content {
  position: relative;
  z-index: 3; /* product details above flames */
}
.product-card .flame-confetti {
  position: absolute;
  top: -4px;
  left: -4px;
  width: calc(100% + 8px);
  height: calc(100% + 8px);
  pointer-events: none;
  border-radius: 12px;
  z-index: 2; /* flames behind content */
}




.product-card:hover {
  transform: translateY(-3px);
}
.product-card img {
  width: 100%;
  border-radius: 10px;
  object-fit: cover;
  height: 140px;
}
.product-info {
  margin-top: 8px;
  font-size: 14px;
}
.price {
  font-weight: bold;
  color: #e67e22;
  margin-top: 4px;
}

/* Bottom Navigation */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: #fff;
  display: flex;
  justify-content: space-around;
  padding: 10px 0;
  box-shadow: 0 -2px 6px rgba(0,0,0,0.08);
}
.nav-item {
  text-align: center;
  font-size: 12px;
  cursor: pointer;
  color: #555;
  transition: 0.2s;
}
.nav-item:hover {
  color: #3498db;
}
.nav-item span {
  display: block;
  font-size: 20px;
}

/* Floating subcategory panel */
.subcategory-panel {
  position: fixed;
  top: 0;
  right: -100%;
  width: 80%;
  height: 100%;
  background: #fff;
  box-shadow: -2px 0 10px rgba(0,0,0,0.15);
  transition: right 0.35s ease;
  z-index: 2000;
  display: flex;
  flex-direction: column;
}
.subcategory-panel.active { right: 0; }
.subcategory-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px;
  font-weight: 600;
  border-bottom: 1px solid #eee;
}
.subcategory-list {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
}
.subcategory-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
}
.subcategory-btn img {
  width: 60px;
  height: 60px;
  object-fit: contain;
  border-radius: 50%;
  background: #f9f9f9;
  padding: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  transition: transform 0.2s;
}
.subcategory-btn img:hover { transform: scale(1.05); }
.subcategory-btn span {
  font-size: 13px;
  margin-top: 6px;
  text-align: center;
}

/* Borders by type */
#onSaleWrapper .product-card {
  border-color: #8b0000;   /* dark red for sale */
}

/* Keep product card borders as they are */
#onSaleWrapper .product-card {
  border-color: #8b0000;   /* dark red for sale */
}
#featuredWrapper .product-card {
  border-color: #0d1b2a;   /* dark blue for featured */
}
#newArrivalsWrapper .product-card {
  border-color: #006400;   /* dark green for new arrivals */
}
#bestSellerWrapper .product-card {
  border-color: #b3541e;   /* dark orange/red for best sellers */
}
#productsWrapper .product-card {
  border-color: #b8860b;   /* dark goldenrod (dark yellow) */
}

/* Make only the section wrappers transparent */
#onSaleWrapper,
#newArrivalsWrapper,
#featuredWrapper,
#bundlesWrapper {
  background: transparent !important;
  box-shadow: none;  /* optional: remove wrapper shadow */
}




@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.9); }
  to { opacity: 1; transform: scale(1); }
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.animate-fadeIn {
  animation: fadeIn 0.3s ease-out;
}

/* Success modal (plain CSS ‚Äî no Tailwind) */
#cartSuccessModal {
  display: none;               /* hidden by default */
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.44);
  z-index: 9000;
  align-items: center;
  justify-content: center;
  padding: 20px;
  box-sizing: border-box;
}

#cartSuccessCard {
  width: 100%;
  max-width: 360px;
  background: #fff;
  border-radius: 14px;
  padding: 18px;
  text-align: center;
  box-shadow: 0 14px 40px rgba(0,0,0,0.18);
  transform: translateY(8px);
  opacity: 0;
  transition: transform .28s ease, opacity .28s ease;
}

#cartSuccessModal.show #cartSuccessCard {
  transform: translateY(0);
  opacity: 1;
}

#cartSuccessCard .check {
  width:64px;
  height:64px;
  border-radius:50%;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  background:#e6fbef;
  margin: 0 auto 10px;
}

#cartSuccessCard h2 {
  margin: 6px 0 6px;
  font-size:18px;
  color:#1f2937;
}

#cartSuccessCard p { margin:0; color:#4b5563; font-size:14px; }

/* Toast */
.toast-message {
  position: fixed;
  left: 50%;
  transform: translateX(-50%) translateY(6px);
  bottom: 26px;
  background: rgba(0,0,0,0.82);
  color: #fff;
  padding: 8px 14px;
  border-radius: 10px;
  font-size: 13px;
  opacity: 0;
  transition: opacity .22s ease, transform .22s ease;
  z-index: 9200;
  pointer-events: none;
}
.toast-message.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

.status-tab {
  padding:8px 14px;
  border-radius:6px;
  border:none;
  background:#eee;
  cursor:pointer;
  font-weight:600;
}
.status-tab.active { background:#3498db; color:#fff; }

.order-card {
  background:#fff;
  border:1px solid #ddd;
  border-radius:8px;
  padding:12px;
  margin-bottom:12px;
  box-shadow:0 2px 5px rgba(0,0,0,0.05);
}
.order-card h4 { margin:0 0 6px; font-size:15px; }
.order-actions button {
  margin-right:8px;
  padding:6px 10px;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
.btn-cancel { background:#c0392b; color:#fff; }
.btn-view { background:#3498db; color:#fff; }
.btn-buyagain { background:#27ae60; color:#fff; }

.purchase-tab {
  background: #f5f5f5;
  border: none;
  padding: 10px 14px;
  margin-right: 5px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s, color 0.2s;
}

.purchase-tab:hover {
  background: #e0e0e0;
}

.purchase-tab.active {
  background: #3498db;
  color: #fff;
  font-weight: 600;
}

/* Input focus glow */
#checkoutModal input:focus,
#checkoutModal select:focus {
  border-color:#3498db;
  box-shadow:0 0 0 2px rgba(52,152,219,0.2);
}

/* Button hover & click feedback */
#checkoutModal button:hover {
  filter:brightness(1.1);
  transform:translateY(-2px);
}
#checkoutModal button:active {
  transform:scale(0.96);
}

/* Status tabs styling */
.status-tab {
  padding:10px 16px;
  border:none;
  border-radius:8px;
  background:#f0f0f0;
  cursor:pointer;
  font-weight:600;
  color:#333;
  transition:background 0.2s, color 0.2s, transform 0.1s, box-shadow 0.2s;
}

.status-tab:hover {
  background:#e2e8f0;
  transform:translateY(-2px);
}

.status-tab:active {
  transform:scale(0.95);
}

.status-tab.active {
  background:linear-gradient(135deg,#3498db,#217dbb);
  color:#fff;
  box-shadow:0 4px 12px rgba(52,152,219,0.2);
}

/* Orders container */
#ordersList {
  animation:fadeIn 0.3s ease;
}

/* Nav-item click feedback */
.nav-item:active {
  transform: scale(0.9);
  background: rgba(52, 152, 219, 0.15);
  border-radius: 12px;
}

/* Optional: add a short highlight flash */
.nav-item.flash {
  animation: flashHighlight 0.3s;
}
@keyframes flashHighlight {
  0%   { background: rgba(52,152,219,0.2); }
  100% { background: transparent; }
}

.status-tab.active {
  background:#3b82f6;
  color:#fff;
  border-radius:6px;
}


@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
.animate-fadeIn {
  animation: fadeIn 0.35s ease-out;
}

@keyframes spin { 100% { transform: rotate(360deg); } }
.download-btn { background:#10b981; color:#fff; border:none; border-radius:8px; padding:8px 10px; cursor:pointer; font-weight:600; }
.download-btn:active { transform:scale(0.98); }

#bundleDetailsModal {
  visibility: hidden;
  opacity: 0;
  transition: opacity 0.25s ease;
}
#bundleDetailsModal.show {
  visibility: visible;
  opacity: 1;
  display: flex; /* keep layout */
}

.carousel {
  display: flex;
  overflow-x: auto;
  gap: 6px;
  scroll-snap-type: x mandatory;
}
.carousel img {
  flex: 0 0 auto;
  scroll-snap-align: start;
}

#splash {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;      /* full device width */
  height: 100vh;     /* full device height */
  background: #ffffff; /* or your brand color */
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

#splash img {
  width: 100%;
  height: 100%;
  object-fit: cover;  /* fill screen without distortion */
}

/* Fix buyNow modal when JS toggles Tailwind 'flex' */
#buyNowModal.flex {
  display: flex !important;
  flex-direction: column;
  align-items: stretch;
  justify-content: flex-start;
}

/* make top bar full width and keep close button top-right */
#buyNowModal.flex > div:first-child {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  width: 100%;
  box-sizing: border-box;
}

/* ensure the button doesn't get positioned strangely by other rules */
#buyNowModal.flex > div:first-child button {
  position: static;
  margin: 0;
  line-height: 1;
}


#onSaleWrapper {
  padding-bottom: 100px;
}

#onSaleWrapper .product-card {
  overflow: hidden;
}

.bottom-nav {
  z-index: 3000;
}

html, body {
  touch-action: manipulation; /* disables double-tap zoom */
}

.section { display: none; }
.section.active { display: block; }


.product-img-wrapper {
  position: relative;   /* anchor point for the heart */
}

.product-img-wrapper img {
  pointer-events: none; /* ‚úÖ clicks pass through image */
}

.wishlist-btn {
  position: absolute;
  bottom: 10px;
  right: 10px;
  background: #fff;
  border: none;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  z-index: 10;   /* ‚úÖ make it clickable above the image */
}


.wishlist-btn:hover {
  transform: scale(1.1);
}



@keyframes blinkDots {
  0%   { opacity: 0.2; }
  50%  { opacity: 1; }
  100% { opacity: 0.2; }
}

#aiTypingIndicator .dots::after {
  content: "‚Ä¶";
  animation: blinkDots 1s infinite;
}

.tab-btn {
  background:none;
  border:none;
  padding:8px 14px;
  margin-right:6px;
  font-weight:bold;
  cursor:pointer;
  color:#fff;
  border-bottom:2px solid transparent;
}
.tab-btn.active {
  border-bottom:2px solid #fff;
}

.serviceFilterBtn {
    padding: 6px 12px;
    margin: 0 4px;
    border: none;
    border-radius: 6px;
    background: #eee;
    cursor: pointer;
    font-weight: 600;
  }
  .serviceFilterBtn.active {
    background: #3498db;
    color: white;
  }

  /* Desktop Pasuyo modal */
#pasuyoModal > div {
  max-width: 600px;
  margin: 0 auto;
}

/* üì± Full screen on mobile */
@media (max-width: 600px) {
  #pasuyoModal {
    width: 100vw;
    height: 100vh;
    margin: 0;
    border-radius: 0;
  }
  #pasuyoModal > div {
    max-width: 100%;
    margin: 0;
  }
}



  </style>
</head>

<!-- Announcement Modal -->
<div id="announcementModal" 
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.7); z-index:5000; display:flex; justify-content:center; align-items:center;">
  <div style="position:relative; background:#fff; border-radius:12px; padding:10px; max-width:90%; max-height:90%;">
    <button onclick="closeAnnouncementModal()" 
            style="position:absolute; top:5px; right:5px; background:red; color:white;
                   border:none; border-radius:50%; width:30px; height:30px; font-size:16px; cursor:pointer;">‚úñ</button>
    <img id="announcementImage" src="" style="max-width:100%; max-height:70vh; border-radius:10px; display:block; margin:auto;">
  </div>
</div>


<body>
   <!-- Splash Screen -->
<div id="splash">
  <img src="https://storage.googleapis.com/flutterflow-io-6f20.appspot.com/projects/sfproject7-oqutkl/assets/n6nnnltu9yvp/Untitled_design_(9).png" alt="Get Started">
</div>

<!-- Header -->
<div class="header flex items-center justify-between px-4 py-3 bg-white shadow-md">
  <!-- Logo / Title -->
  <div class="flex items-center space-x-2">
    <img src="https://storage.googleapis.com/flutterflow-io-6f20.appspot.com/projects/sfproject7-oqutkl/assets/xn3ny9z31htb/THE_YELLOW_CART_(2).png" 
         alt="BizMart Logo" class="h-8 w-8 object-contain">
    <div class="logo text-xl font-bold text-gray-800">BizMart</div>
  </div>

  <!-- Placeholder for future AI search or spacing -->
  <div class="flex-1 max-w-md mx-4"></div>

  <!-- ‚úÖ Header Right Section: Login / Sign Up -->
<div id="authControls">
  <button id="loginBtn" onclick="openLoginModal()" 
          style="background:linear-gradient(135deg, #4facfe, #00f2fe);
                 color:#fff; border:none; padding:10px 20px; 
                 border-radius:30px; font-size:14px; font-weight:600; 
                 letter-spacing:0.5px; cursor:pointer; 
                 box-shadow:0 4px 12px rgba(0,0,0,0.2), inset 0 1px 2px rgba(255,255,255,0.4);
                 transition:all 0.3s ease;">
    üîê Login / Sign Up
  </button>
</div>


</div>

<!-- Preload Banners -->
<link rel="preload" as="image" href="https://storage.googleapis.com/flutterflow-io-6f20.appspot.com/projects/sfproject7-oqutkl/assets/twecpa65pj4n/BIZMART1.webp">
<link rel="preload" as="image" href="https://storage.googleapis.com/flutterflow-io-6f20.appspot.com/projects/sfproject7-oqutkl/assets/s7b13h01dqsl/15_February_2025_(16).webp">
<link rel="preload" as="image" href="https://storage.googleapis.com/flutterflow-io-6f20.appspot.com/projects/sfproject7-oqutkl/assets/f3jjjzz5tz59/15_February_2025_(17).webp">
<link rel="preload" as="image" href="https://storage.googleapis.com/flutterflow-io-6f20.appspot.com/projects/sfproject7-oqutkl/assets/vd6laatw72s3/15_February_2025_(19).webp">

<!-- Swiper CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />

<!-- Banner Carousel -->
<div class="swiper banner-swiper" id="bannerContainer">
  <div class="swiper-wrapper">
    <div class="swiper-slide">
      <img src="https://storage.googleapis.com/flutterflow-io-6f20.appspot.com/projects/sfproject7-oqutkl/assets/twecpa65pj4n/BIZMART1.webp" 
           alt="Banner 1" class="w-full h-[160px] object-cover rounded-xl">
    </div>
    <div class="swiper-slide">
      <img src="https://storage.googleapis.com/flutterflow-io-6f20.appspot.com/projects/sfproject7-oqutkl/assets/s7b13h01dqsl/15_February_2025_(16).webp" 
           alt="Banner 2" class="w-full h-[160px] object-cover rounded-xl">
    </div>
    <div class="swiper-slide">
      <img src="https://storage.googleapis.com/flutterflow-io-6f20.appspot.com/projects/sfproject7-oqutkl/assets/f3jjjzz5tz59/15_February_2025_(17).webp" 
           alt="Banner 3" class="w-full h-[160px] object-cover rounded-xl">
    </div>
    <div class="swiper-slide">
      <img src="https://storage.googleapis.com/flutterflow-io-6f20.appspot.com/projects/sfproject7-oqutkl/assets/vd6laatw72s3/15_February_2025_(19).webp" 
           alt="Banner 4" class="w-full h-[160px] object-cover rounded-xl">
    </div>
    <div class="swiper-slide">
      <img src="https://storage.googleapis.com/flutterflow-io-6f20.appspot.com/projects/sfproject7-oqutkl/assets/vd6laatw72s3/15_February_2025_(19).webp" 
           alt="Banner 5" class="w-full h-[160px] object-cover rounded-xl">
    </div>
  </div>
</div>


<!-- Swiper JS -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    new Swiper(".banner-swiper", {
      loop: true,
      autoplay: { delay: 3000 },
      pagination: { el: ".swiper-pagination", clickable: true },
      // navigation removed for automatic swipe only
    });
  });
</script>



  <!-- Categories -->
<div class="section-header">
  <div class="section-title">Categories</div>
</div>
<div class="h-scroll" id="categoryList"></div>


<!-- üìÇ Categories Modal -->
<div id="categoriesModal"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:#fff; z-index:6000; overflow-y:auto;">

  <!-- Header -->
  <div style="display:flex; justify-content:space-between; align-items:center;
              padding:14px; background:#3498db; color:#fff; font-weight:600;
              box-shadow:0 2px 6px rgba(0,0,0,0.1);">
    <span>üìÇ All Categories</span>
    <button onclick="closeCategoriesModal()" 
            style="background:none; border:none; font-size:22px; color:#fff; cursor:pointer;">‚úñ</button>
  </div>

  <!-- Categories Grid -->
  <div id="categoriesGrid" 
       style="padding:14px; display:grid; grid-template-columns:repeat(3, 1fr); gap:16px;">
    <!-- dynamically cloned categories -->
  </div>
</div>


  <!-- Subcategories -->
  <div class="section-header" id="subHeader" style="display:none;">
    <div class="section-title">Subcategories</div>
  </div>
  <div class="h-scroll" id="subCategoryList" style="display:none;"></div>

  <!-- Products -->
  <div class="section-header" id="prodHeader" style="display:none;">
    <div class="section-title">Products</div>
  </div>
  <div class="products-wrapper" id="productsWrapper" style="display:none;">
    <div class="products" id="productList"></div>
  </div>



  <!-- On Sale -->
<div class="section-header" id="onSaleHeader">
  <div class="section-title">üî• On Sale</div>
  <div class="see-all" onclick="openSectionProductsModal('onSaleWrapper','üî• On Sale')">See All</div>
</div>
<div class="products-wrapper" id="onSaleWrapper">
  <div class="products" id="onSaleList"></div>
</div>


<!-- New Arrivals (always at bottom) -->
<div class="section-header" id="newArrivalsHeader">
  <div class="section-title">üÜï New Arrivals</div>
  <div class="see-all" onclick="openSectionProductsModal('newArrivalsWrapper','üÜï New Arrivals')">See All</div>
</div>
<div class="products-wrapper" id="newArrivalsWrapper">
  <div class="products" id="newArrivalsList"></div>
</div>


<!-- Featured -->
<div class="section-header" id="featuredHeader">
  <div class="section-title">‚≠ê Featured</div>
  <div class="see-all" onclick="openSectionProductsModal('featuredWrapper','‚≠ê Featured')">See All</div>
</div>
<div class="products-wrapper" id="featuredWrapper">
  <div class="products" id="featuredList"></div>
</div>


<!-- Study Bundles -->
<div class="section-header" id="bundlesHeader">
  <div class="section-title">üéí Study Bundles</div>
  <div class="see-all" onclick="openSectionProductsModal('bundlesWrapper','üéí Study Bundles')">See All</div>
</div>
<div class="products-wrapper" id="bundlesWrapper">
  <div class="products" id="bundlesList"></div>
</div>



<!-- Product Detail Modal -->
<div id="productDetailModal" 
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:#fff; z-index:4000; overflow:auto;">

  <!-- Header -->
  <div style="display:flex; justify-content:flex-end; padding:10px; 
              background:#f5f5f5; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
    <button onclick="closeProductDetail()" 
            style="font-size:20px; padding:5px 10px; cursor:pointer; border:none; background:none;">‚úñ</button>
  </div>

  <!-- Content -->
  <div style="padding:14px; font-family:sans-serif;">

    <!-- Image -->
    <img id="detailImage" src="" 
         style="width:100%; max-height:300px; object-fit:contain; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1);">

    <!-- Title -->
    <h2 id="detailName" 
        style="margin-top:10px; font-size:1.25rem; font-weight:600; color:#333;"></h2>

    <!-- Price + Stock Badge -->
    <div style="display:flex; align-items:center; justify-content:space-between; margin-top:6px;">
      <div id="detailPrice" style="font-weight:700; color:#e67e22; font-size:1.1rem;"></div>
      <span id="detailStock" 
            style="font-size:0.85rem; background:#d1fae5; color:#065f46; padding:4px 8px; border-radius:12px;">
        In Stock
      </span>
    </div>

    <!-- Brand Badge -->
    <div id="detailBrand" 
         style="margin-top:6px; display:inline-block; background:#eef2ff; color:#4338ca;
                padding:3px 8px; border-radius:8px; font-size:0.85rem;"></div>

    <!-- Product Info -->
    <div style="margin-top:10px; font-size:0.95rem; color:#555; line-height:1.4;">
      <div id="detailDescription"></div>
      <div id="detailWeight" style="margin-top:4px;"></div>
      <div id="detailDimensions" style="margin-top:4px;"></div>
      <div id="detailColor" style="margin-top:4px;"></div>
      <div id="detailMaterial" style="margin-top:4px;"></div>
    </div>

    <!-- Quantity Selector -->
    <div style="margin-top:15px;">
      <label for="detailQty" style="font-weight:600; display:block; margin-bottom:4px;">Quantity:</label>
      <div style="display:inline-flex; border:1px solid #ccc; border-radius:6px; overflow:hidden;">
        <button type="button" onclick="changeQty(-1)" 
                style="background:#f5f5f5; border:none; width:30px; cursor:pointer; font-size:18px;">‚àí</button>
        <input id="detailQty" type="number" min="1" value="1" 
               style="width:60px; padding:5px; text-align:center; border:none; font-size:1rem;">
        <button type="button" onclick="changeQty(1)" 
                style="background:#f5f5f5; border:none; width:30px; cursor:pointer; font-size:18px;">+</button>
      </div>
    </div>

    <!-- Action Buttons -->
    <div style="margin-top:20px; display:flex; gap:10px;">
      <button onclick="addToCart()" 
              style="flex:1; padding:10px; background:#3498db; color:#fff; border:none; border-radius:6px; 
                     cursor:pointer; font-weight:600; transition:background .2s;">
        üõí Add to Cart
      </button>
      <button onclick="buyNow()" 
              style="flex:1; padding:10px; background:#e67e22; color:#fff; border:none; border-radius:6px; 
                     cursor:pointer; font-weight:600; transition:background .2s;">
        ‚ö° Buy Now
      </button>
    </div>
  </div>
</div>



<!-- Cart Modal -->
<div id="cartModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#fff; z-index:5000; overflow:auto;">
  <div style="display:flex; justify-content:flex-end; padding:10px; background:#f5f5f5; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
    <button onclick="closeCartModal()" style="font-size:20px; padding:5px 10px; cursor:pointer;">‚úñ</button>
  </div>
  <div id="cartContent" style="padding:20px;">
    <h2>Your Cart</h2>
    <div id="cartItemsContainer" style="margin-top:15px;"></div>
    <div style="margin-top:20px; font-weight:bold;" id="cartTotal"></div>
    <div style="margin-top:20px; display:flex; gap:10px;">
      <!-- ‚úÖ Renamed button -->
      <button onclick="saveCartToSheet()" style="flex:1; padding:10px; background:#27ae60; color:#fff; border:none; border-radius:6px; cursor:pointer;">
        Add to Cart
      </button>
      <button onclick="clearCartItems()" style="flex:1; padding:10px; background:#c0392b; color:#fff; border:none; border-radius:6px; cursor:pointer;">
        Clear Cart
      </button>
    </div>
  </div>
</div>

<!-- Purchases Modal -->
<div id="purchasesModal" 
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
            background:#fff; z-index:3500; overflow:auto;">

  <!-- Top bar -->
  <div style="display:flex; justify-content:flex-end; padding:10px; background:#f5f5f5; 
              box-shadow:0 2px 5px rgba(0,0,0,0.1);">
    <button onclick="closePurchasesModal()" 
            style="font-size:20px; padding:5px 10px; cursor:pointer; border:none; background:none;">‚úñ</button>
  </div>

  <!-- Content -->
  <div style="padding:24px; max-width:800px; margin:0 auto; font-family:sans-serif;">
    <h2 style="margin-bottom:18px; font-size:1.6rem; font-weight:700; color:#2c3e50;">üõçÔ∏è My Purchases</h2>

    <!-- Order Status Tabs -->
    <div style="display:flex; gap:10px; margin:18px 0; flex-wrap:wrap;">
      <button class="status-tab active" data-status="Pending">‚è≥ Pending</button>
      <button class="status-tab" data-status="Ready">üì¶ Ready</button>
      <button class="status-tab" data-status="Completed">‚úÖ Completed</button>
      <button class="status-tab" data-status="Cancelled">‚ùå Cancelled</button>
    </div>

    <!-- Orders List -->
    <div id="ordersList" 
         style="margin-top:14px; background:#fafafa; border:1px solid #e5e7eb; border-radius:10px; 
                padding:16px; min-height:150px;">
      <!-- dynamically loaded orders go here -->
    </div>
  </div>
</div>


<!-- Checkout Modal -->
<div id="checkoutModal" 
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:#fff; z-index:5200; overflow:auto;">

  <!-- Header -->
  <div style="display:flex; justify-content:flex-end; padding:10px; background:#f5f5f5; 
              box-shadow:0 2px 5px rgba(0,0,0,0.1);">
    <button onclick="closeCheckoutModal()" 
            style="font-size:20px; padding:5px 10px; cursor:pointer; border:none; background:none;">‚úñ</button>
  </div>

  <!-- Content -->
  <div style="padding:24px; max-width:720px; margin:0 auto; font-family:sans-serif;">
    <h2 style="font-size:1.6rem; font-weight:700; color:#2c3e50; margin-bottom:14px;">üõí Checkout</h2>

    <!-- Cart Items -->
    <div style="margin-top:12px; border-radius:10px; background:#fafafa; padding:14px; 
                border:1px solid #eee; max-height:280px; overflow:auto;">
      <div id="checkoutCartItems"></div>
    </div>

    <!-- Summary -->
    <div style="margin-top:18px; background:#f8fafc; border:1px solid #e5e7eb; border-radius:10px; padding:14px;">
      <div style="font-weight:600; margin-bottom:6px;">
        Subtotal: <span id="checkoutSubtotal">‚Ç±0.00</span>
      </div>
      <div style="font-weight:600;">
        Delivery Fee: <span id="checkoutDeliveryFee">‚Ç±0.00</span>
      </div>
    </div>

    <!-- Customer Info -->
    <div style="margin-top:20px;">
      <h3 style="font-size:1.2rem; font-weight:600; margin-bottom:10px; color:#2c3e50;">üë§ Customer Details</h3>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
        <div>
          <label style="font-weight:600;">Name</label><br>
          <input id="checkoutName" type="text" 
                 style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; outline:none;">
        </div>
        <div>
          <label style="font-weight:600;">Contact No.</label><br>
          <input id="checkoutContact" type="text" 
                 style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; outline:none;">
        </div>
        <div>
          <label style="font-weight:600;">Grade Level</label><br>
          <select id="checkoutGrade" 
                  style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; outline:none;">
            <option value="">Select Grade</option>
            <option>Grade 7</option>
            <option>Grade 8</option>
            <option>Grade 9</option>
            <option>Grade 10</option>
            <option>Grade 11</option>
            <option>Grade 12</option>
          </select>
        </div>
        <div>
          <label style="font-weight:600;">Section</label><br>
          <input id="checkoutSection" type="text" 
                 style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; outline:none;">
        </div>
      </div>
    </div>

    <!-- Delivery Options -->
    <div style="margin-top:20px;">
      <h3 style="font-size:1.2rem; font-weight:600; margin-bottom:8px; color:#2c3e50;">üöö Delivery Options</h3>
      <label style="margin-right:20px; font-weight:500;">
        <input type="radio" id="deliveryOptionPickup" name="deliveryOption" value="Pickup" checked> Pickup
      </label>
      <label style="font-weight:500;">
        <input type="radio" id="deliveryOptionDelivery" name="deliveryOption" value="Delivery"> Delivery
      </label>

      <!-- Delivery-specific fields -->
      <div id="deliveryFields" style="display:none; margin-top:12px;">
        <label style="font-weight:600;">Preferred Delivery Time</label><br>
        <select id="checkoutDeliveryTime" 
                style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; outline:none;">
          <option value="">Loading...</option>
        </select>
      </div>
    </div>

    <!-- Total -->
    <div style="margin-top:22px; font-weight:700; font-size:1.2rem; color:#2c3e50;">
      Total: <span id="checkoutTotal">‚Ç±0.00</span>
    </div>

    <!-- Buttons -->
    <div style="display:flex; gap:14px; margin-top:20px;">
      <button onclick="submitCheckout()" 
              style="flex:1; padding:14px; background:#27ae60; color:#fff; border:none; border-radius:8px; 
                     cursor:pointer; font-weight:600; transition:background .2s, transform .1s;">
        ‚úÖ Confirm Checkout
      </button>
      <button onclick="closeCheckoutModal()" 
              style="flex:1; padding:14px; background:#c0392b; color:#fff; border:none; border-radius:8px; 
                     cursor:pointer; font-weight:600; transition:background .2s, transform .1s;">
        ‚úñ Cancel
      </button>
    </div>
  </div>
</div>

<!-- Order Details Modal (Tailwind) - REPLACE YOUR EXISTING orderModal WITH THIS -->
<div id="orderModal"
     class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center"
     style="z-index:10000;">
  <div class="bg-white p-6 rounded-lg shadow-lg w-96">
    <h2 class="text-lg font-bold mb-4">Order Details</h2>

    <p><b>ID:</b> <span id="orderModalId"></span></p>
    <p><b>Date:</b> <span id="orderModalDate"></span></p>
    <p><b>Status:</b> <span id="orderModalStatus"></span></p>
    <p><b>Total:</b> ‚Ç±<span id="orderModalTotal"></span></p>

    <div id="orderModalProduct" class="mt-4"></div>

    <div class="flex justify-end mt-6">
      <button onclick="closeOrderModal()" 
              class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
        Close
      </button>
    </div>
  </div>
</div>



<!-- Success Add-to-Cart Modal (no Tailwind required) -->
<div id="cartSuccessModal" aria-hidden="true">
  <div id="cartSuccessCard" class="animate-fadeIn" role="dialog" aria-modal="true">
    <div class="check" aria-hidden="true">
      <!-- check icon -->
      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 20 20" fill="none">
        <path d="M7.5 13.2L4.3 10l-1 1.1 4.2 4.2 9-9-1.1-1.1-7.9 7.9z" fill="#059669"/>
      </svg>
    </div>
    <h2>Added to Cart!</h2>
    <p id="cartSuccessMessage">Your item has been added successfully.</p>
  </div>
</div>

<!-- Success Checkout Modal -->
<div id="checkoutSuccessModal" style="display:none; position:fixed; top:0; left:0; 
     width:100%; height:100%; background:rgba(0,0,0,0.44); z-index:9500; 
     align-items:center; justify-content:center; padding:20px; box-sizing:border-box;">
  <div style="width:100%; max-width:360px; background:#fff; border-radius:14px; 
              padding:18px; text-align:center; box-shadow:0 14px 40px rgba(0,0,0,0.18);">
    <div class="check" style="width:64px; height:64px; border-radius:50%; display:inline-flex;
         align-items:center; justify-content:center; background:#e6fbef; margin:0 auto 10px;">
      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 20 20">
        <path d="M7.5 13.2L4.3 10l-1 1.1 4.2 4.2 9-9-1.1-1.1-7.9 7.9z" fill="#059669"/>
      </svg>
    </div>
    <h2>Order Successful!</h2>
    <p id="checkoutSuccessMessage">Your order has been placed successfully.</p>
  </div>
</div>

<!-- Checkout Loading Modal -->
<div id="checkoutLoadingModal" style="display:none; position:fixed; top:0; left:0; 
     width:100%; height:100%; background:rgba(255,255,255,0.7); z-index:9700; 
     align-items:center; justify-content:center; padding:20px; box-sizing:border-box;">
  <div style="width:100%; max-width:280px; background:#fff; border-radius:10px; 
              padding:20px; text-align:center; box-shadow:0 8px 30px rgba(0,0,0,0.15);">
    <div class="spinner" style="width:40px; height:40px; border:4px solid #ccc; 
         border-top:4px solid #27ae60; border-radius:50%; margin:0 auto 12px;
         animation:spin 1s linear infinite;"></div>
    <p style="margin:0; font-weight:500;">Processing your order‚Ä¶</p>
  </div>
</div>


<!-- Buy Now Modal -->
<div id="buyNowModal" 
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:#fff; z-index:5200; overflow:auto;">

  <!-- Header -->
  <div style="display:flex; justify-content:flex-end; padding:10px; background:#f5f5f5; 
              box-shadow:0 2px 5px rgba(0,0,0,0.1);">
    <button onclick="closeBuyNowModal()" 
            style="font-size:20px; padding:5px 10px; cursor:pointer; border:none; background:none;">‚úñ</button>
  </div>

  <!-- Content -->
  <div style="padding:24px; max-width:720px; margin:0 auto; font-family:sans-serif;">
    <h2 style="font-size:1.6rem; font-weight:700; color:#2c3e50; margin-bottom:14px;">‚ö° Confirm Purchase</h2>

    <!-- Selected Product -->
    <div style="margin-top:12px; border-radius:10px; background:#fafafa; padding:14px; 
                border:1px solid #eee; max-height:280px; overflow:auto;">
      <div id="buyNowProductItem"></div>
    </div>

    <!-- Summary -->
    <div style="margin-top:18px; background:#f8fafc; border:1px solid #e5e7eb; border-radius:10px; padding:14px;">
      <div style="font-weight:600; margin-bottom:6px;">
        Subtotal: <span id="buyNowSubtotal">‚Ç±0.00</span>
      </div>
      <div style="font-weight:600;">
        Delivery Fee: <span id="buyNowDeliveryFee">‚Ç±0.00</span>
      </div>
    </div>

    <!-- Customer Info -->
    <div style="margin-top:20px;">
      <h3 style="font-size:1.2rem; font-weight:600; margin-bottom:10px; color:#2c3e50;">üë§ Customer Details</h3>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
        <div>
          <label style="font-weight:600;">Name</label><br>
          <input id="buyNowName" type="text" 
                 style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; outline:none;">
        </div>
        <div>
          <label style="font-weight:600;">Contact No.</label><br>
          <input id="buyNowContact" type="text" 
                 style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; outline:none;">
        </div>
        <div>
          <label style="font-weight:600;">Grade Level</label><br>
          <select id="buyNowGrade" 
                  style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; outline:none;">
            <option value="">Select Grade</option>
            <option>Grade 7</option>
            <option>Grade 8</option>
            <option>Grade 9</option>
            <option>Grade 10</option>
            <option>Grade 11</option>
            <option>Grade 12</option>
          </select>
        </div>
        <div>
          <label style="font-weight:600;">Section</label><br>
          <input id="buyNowSection" type="text" 
                 style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; outline:none;">
        </div>
      </div>
    </div>

    <!-- Delivery Options -->
    <div style="margin-top:20px;">
      <h3 style="font-size:1.2rem; font-weight:600; margin-bottom:8px; color:#2c3e50;">üöö Delivery Options</h3>
      <label style="margin-right:20px; font-weight:500;">
        <input type="radio" id="buyNowPickup" name="buyNowDeliveryOption" value="Pickup" checked> Pickup
      </label>
      <label style="font-weight:500;">
        <input type="radio" id="buyNowDelivery" name="buyNowDeliveryOption" value="Delivery"> Delivery
      </label>

      <!-- Delivery-specific fields -->
      <div id="buyNowDeliveryFields" style="display:none; margin-top:12px;">
        <label style="font-weight:600;">Preferred Delivery Time</label><br>
        <select id="buyNowDeliveryTime" 
                style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; outline:none;">
          <option value="">Loading...</option>
        </select>
      </div>
    </div>

    <!-- Total -->
    <div style="margin-top:22px; font-weight:700; font-size:1.2rem; color:#2c3e50;">
      Total: <span id="buyNowTotal">‚Ç±0.00</span>
    </div>

    <!-- Buttons -->
    <div style="display:flex; gap:14px; margin-top:20px;">
      <button onclick="submitBuyNow()" 
              style="flex:1; padding:14px; background:#27ae60; color:#fff; border:none; border-radius:8px; 
                     cursor:pointer; font-weight:600; transition:background .2s, transform .1s;">
        ‚ö° Confirm Purchase
      </button>
      <button onclick="closeBuyNowModal()" 
              style="flex:1; padding:14px; background:#c0392b; color:#fff; border:none; border-radius:8px; 
                     cursor:pointer; font-weight:600; transition:background .2s, transform .1s;">
        ‚úñ Cancel
      </button>
    </div>
  </div>
</div>



  <div class="bottom-nav">
  <div class="nav-item" id="tab-services" onclick="openServicesModal()">
    <span>üñ®Ô∏è</span>
    <div>Services</div>
  </div>
  <div class="nav-item" id="tab-wishlist" onclick="openWishlistModal()">
    <span>‚ù§Ô∏è</span>
    <div>Wishlist</div>
  </div>
  <div class="nav-item" id="tab-cart" onclick="openCheckoutModal()">
    <span>üõí</span>
    <div>Cart</div>
  </div>
  <div class="nav-item" id="tab-purchases" onclick="openPurchasesModal()">
    <span>üõçÔ∏è</span>
    <div>My Purchases</div>
  </div>
</div>







<!-- Picked Up Success Modal -->
<div id="pickedUpSuccessModal"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.4); z-index:5000; 
            align-items:center; justify-content:center;">

  <div style="background:#fff; padding:24px 30px; border-radius:16px;
              box-shadow:0 4px 10px rgba(0,0,0,0.2); text-align:center;
              max-width:300px; font-family:sans-serif;">
    <div style="font-size:40px; margin-bottom:10px; color:#16a34a;">‚úÖ</div>
    <h3 style="margin:0; font-size:18px; color:#2c3e50;">Order Completed</h3>
    <p style="margin:10px 0 20px; font-size:14px; color:#555;">
      Your order has been marked as <b>Completed</b> and <b>Paid</b>.
    </p>
    <button onclick="closePickedUpSuccessModal()"
            style="background:#16a34a; color:#fff; border:none; 
                   padding:10px 18px; border-radius:10px; font-size:14px; cursor:pointer;">
      OK
    </button>
  </div>
</div>

<!-- Picked Up Confirmation Modal -->
<div id="pickupConfirmModal"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.4); z-index:6000; 
            align-items:center; justify-content:center;">

  <div style="background:#fff; padding:24px 30px; border-radius:16px;
              box-shadow:0 4px 10px rgba(0,0,0,0.2); text-align:center;
              max-width:300px; font-family:sans-serif;">
    <h3 style="margin:0 0 15px; font-size:18px; color:#2c3e50;">Confirm</h3>
    <p style="margin:10px 0 20px; font-size:14px; color:#555;">
      Confirm you picked up and paid this order?
    </p>
    <div style="margin-top:10px; display:flex; justify-content:space-around;">
      <button onclick="closePickupConfirm()"
              style="background:#ccc; color:#000; border:none; 
                     padding:8px 16px; border-radius:10px; font-size:14px; cursor:pointer;">
        Cancel
      </button>
      <button id="confirmPickupBtn"
              style="background:#16a34a; color:#fff; border:none; 
                     padding:8px 16px; border-radius:10px; font-size:14px; cursor:pointer;">
        Yes, Confirm
      </button>
    </div>
  </div>
</div>

<!-- Cancel Confirmation Modal -->
<div id="cancelConfirmModal"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.4); z-index:6000; 
            align-items:center; justify-content:center;">

  <div style="background:#fff; padding:24px 30px; border-radius:16px;
              box-shadow:0 4px 10px rgba(0,0,0,0.2); text-align:center;
              max-width:300px; font-family:sans-serif;">
    <h3 style="margin:0 0 15px; font-size:18px; color:#2c3e50;">Confirm Cancel</h3>
    <p style="margin:10px 0 20px; font-size:14px; color:#555;">
      Are you sure you want to cancel this order?
    </p>
    <div style="margin-top:10px; display:flex; justify-content:space-around;">
      <button onclick="closeCancelConfirm()"
              style="background:#ccc; color:#000; border:none; 
                     padding:8px 16px; border-radius:10px; font-size:14px; cursor:pointer;">
        No
      </button>
      <button id="confirmCancelBtn"
              style="background:#dc2626; color:#fff; border:none; 
                     padding:8px 16px; border-radius:10px; font-size:14px; cursor:pointer;">
        Yes, Cancel
      </button>
    </div>
  </div>
</div>

<!-- Cancel Success Modal -->
<div id="cancelSuccessModal"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.4); z-index:5000; 
            align-items:center; justify-content:center;">

  <div style="background:#fff; padding:24px 30px; border-radius:16px;
              box-shadow:0 4px 10px rgba(0,0,0,0.2); text-align:center;
              max-width:300px; font-family:sans-serif;">
    <div style="font-size:40px; margin-bottom:10px; color:#e74c3c;">‚ùå</div>
    <h3 style="margin:0; font-size:18px; color:#2c3e50;">Order Cancelled</h3>
    <p style="margin:10px 0 20px; font-size:14px; color:#555;">
      Your order has been <b>cancelled successfully</b>.
    </p>
    <button onclick="closeCancelSuccessModal()"
            style="background:#e74c3c; color:#fff; border:none; 
                   padding:10px 18px; border-radius:10px; font-size:14px; cursor:pointer;">
      OK
    </button>
  </div>
</div>

<div id="deliveryConfirmModal" class="modal hidden">
  <div class="modal-content">
    <p>üöö Confirm this order has been delivered?</p>
    <button id="confirmDeliveryBtn">‚úÖ Yes</button>
    <button onclick="closeDeliveryConfirm()">‚ùå No</button>
  </div>
</div>


<!-- üîê Login Modal -->
<div id="loginModal"
     class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-[99999] transition-opacity duration-300">
  <div class="bg-white rounded-2xl shadow-2xl p-6 w-96 max-w-[90%] text-center relative animate-fadeIn">

    <!-- Close Button -->
    <button onclick="closeLoginModal()" 
            class="absolute top-3 right-3 text-gray-400 hover:text-gray-700 text-2xl font-bold transition-colors">
      &times;
    </button>

    <!-- Title -->
    <h2 class="text-2xl font-extrabold mb-2 text-gray-800">Login to Continue</h2>
    <p class="text-sm text-gray-500 mb-6">Login securely with Telegram</p>

    <!-- ‚úÖ Telegram Login Widget -->
    <script async src="https://telegram.org/js/telegram-widget.js?22"
            data-telegram-login="abmstore_bot"  <!-- üîë Replace with your bot username (without @) -->
            data-size="large"
            data-userpic="true"
            data-request-access="write"
            data-onauth="handleLogin(user)">
    </script>

    <!-- Profile Link -->
    <p class="mt-5 text-sm text-gray-600">
      Want to add school info?
      <a href="#"
         onclick="event.preventDefault(); closeLoginModal(); openSignup();"
         class="font-semibold text-blue-600 hover:text-blue-700">
        Complete your profile
      </a>
    </p>
  </div>
</div>


<!-- üìù Profile Completion Modal -->
<div id="signupModal"
     class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-[99999] transition-opacity duration-300">
  <div class="bg-white rounded-xl p-6 w-96 text-center relative animate-fadeIn">

    <!-- Close -->
    <button onclick="closeSignupModal()" 
            class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 text-xl font-bold">&times;</button>

    <!-- Title -->
    <h2 class="text-xl font-bold mb-4">Complete Your Profile</h2>
    <p class="text-sm text-gray-500 mb-4">We need this info for school transactions.</p>

    <!-- üü¢ Extra School Info Only -->
    <input id="signupContact" placeholder="üì± Contact No" class="border p-2 w-full mb-2 rounded" />
    <input id="signupEmail" placeholder="üìß Email" class="border p-2 w-full mb-2 rounded" />
    <input id="signupGrade" placeholder="üéì Grade" class="border p-2 w-full mb-2 rounded" />
    <input id="signupSection" placeholder="üè´ Section" class="border p-2 w-full mb-2 rounded" />

    <!-- Save Button -->
    <button onclick="handleSignup()" 
            class="bg-green-600 text-white px-4 py-2 rounded w-full shadow-md hover:bg-green-700 transition">
      Save Profile
    </button>

    <!-- Back -->
    <p class="mt-3 text-sm">
      Already updated? 
      <a href="#" 
         onclick="event.preventDefault(); backToLogin();" 
         class="text-blue-600 hover:text-blue-700">Back to Login</a>
    </p>
  </div>
</div>



<!-- ‚úÖ Message Modal -->
<div id="messageModal"
     class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-[99999]">
  <div class="bg-white rounded-xl p-6 w-80 text-center shadow-xl">
    <h2 id="messageModalText" class="text-lg font-semibold mb-4"></h2>
    <button onclick="closeMessageModal()" 
            class="bg-blue-600 text-white px-4 py-2 rounded w-full">OK</button>
  </div>
</div>





<!-- Hidden Receipt Template (off-screen when not in use) -->
<div id="receipt-capture-wrapper" style="position:fixed; left:-9999px; top:-9999px; z-index:99999;">
  <div id="receipt-template" style="width:360px; padding:20px; background:#fff; font-family:'Courier New', monospace; color:#111; border:2px solid #000; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.15);">

    <!-- Logo & Store Header -->
    <div style="text-align:center; margin-bottom:10px;">
      <img src="https://storage.googleapis.com/flutterflow-io-6f20.appspot.com/projects/sfproject7-oqutkl/assets/xn3ny9z31htb/THE_YELLOW_CART_(2).png" 
           alt="Bizmart Logo" 
           style="max-width:120px; height:auto; margin-bottom:8px; display:block; margin-left:auto; margin-right:auto;">
      <div style="font-weight:700; font-size:18px; letter-spacing:1px;">BIZMART</div>
      <div style="font-size:12px; color:#444;">ABM Club Online School Store</div>
      <div style="font-size:11px; color:#777; font-style:italic;">Study Smarter, Shop Easier</div>
    </div>

    <hr style="border:none; border-top:2px dashed #000; margin:10px 0;">

    <!-- Order Info -->
    <div style="font-size:13px; line-height:1.5; margin-bottom:10px;">
      <div><b>Order ID:</b> <span id="r-orderId"></span></div>
      <div><b>Date:</b> <span id="r-date"></span></div>
      <div><b>Customer:</b> <span id="r-customer"></span></div>
      <div><b>Contact:</b> <span id="r-contact"></span></div>
    </div>

    <hr style="border:none; border-top:2px dashed #000; margin:10px 0;">

    <!-- Product Details -->
    <div style="display:flex; gap:12px; align-items:center; margin-bottom:10px;">
      <img id="r-image" src="" alt="product" 
           style="width:70px; height:70px; object-fit:cover; border:1px solid #ccc; border-radius:6px;">
      <div style="flex:1;">
        <div id="r-product" style="font-weight:700; font-size:14px; margin-bottom:4px;"></div>
        <div id="r-qty-price" style="font-size:12px; color:#555;"></div>
      </div>
    </div>

    <hr style="border:none; border-top:2px dashed #000; margin:10px 0;">

    <!-- Totals -->
    <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:4px;">
      <div>Subtotal</div>
      <div>‚Ç±<span id="r-total"></span></div>
    </div>
    <div style="display:flex; justify-content:space-between; font-weight:700; font-size:15px; margin-top:6px;">
      <div>Total</div>
      <div>‚Ç±<span id="r-total"></span></div>
    </div>

    <hr style="border:none; border-top:2px dashed #000; margin:12px 0;">

    <!-- Footer -->
    <div style="text-align:center; font-size:12px; color:#555; margin-top:8px;">
      <div>‚úÖ Thank you for shopping with Bizmart!</div>
      <div style="font-size:11px; margin-top:4px;">Keep this receipt for your records</div>
    </div>

  </div>
</div>

<!-- Spinner while receipt is being prepared -->
<div id="receipt-spinner" style="display:none; position:fixed; inset:0; align-items:center; justify-content:center; z-index:12000; background:rgba(255,255,255,0.6);">
  <div style="background:#fff; padding:18px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,0.12); text-align:center;">
    <div class="spinner" style="width:36px; height:36px; border:4px solid #eee; border-top-color:#3b82f6; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 10px;"></div>
    <div style="font-weight:600;">Preparing receipt...</div>
  </div>
</div>


<!-- üåü Bundle Details Modal -->
<div id="bundleDetailsModal" 
     class="fixed inset-0 hidden bg-black/60 z-[10000] flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl overflow-hidden animate-fadeIn relative">

    <!-- Header -->
    <div class="flex justify-between items-center px-6 py-4 bg-gradient-to-r from-indigo-500 to-blue-600">
      <h2 class="text-white text-xl font-bold">üì¶ Bundle Contents</h2>
      <button onclick="closeBundleDetails()" 
              class="text-white text-2xl font-bold hover:scale-110 transition">&times;</button>
    </div>

    <!-- Content -->
    <div id="bundleDetailsList" class="p-6 space-y-6 max-h-[70vh] overflow-y-auto">
      <!-- dynamically injected bundle items -->
    </div>

    <!-- Footer -->
    <div class="px-6 py-4 bg-gray-50 flex justify-end">
      <button onclick="closeBundleDetails()" 
              class="px-5 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow-md font-semibold transition">
        Close
      </button>
    </div>
  </div>
</div>


<!-- üì¶ Section Products Modal -->
<div id="sectionProductsModal"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:#fff; z-index:6000; overflow-y:auto;">

  <!-- Header -->
  <div style="display:flex; justify-content:space-between; align-items:center;
              padding:14px; background:#3498db; color:#fff; font-weight:600;
              box-shadow:0 2px 6px rgba(0,0,0,0.1);">
    <span id="sectionProductsTitle">Products</span>
    <button onclick="closeSectionProductsModal()" 
            style="background:none; border:none; font-size:22px; color:#fff; cursor:pointer;">‚úñ</button>
  </div>

  <!-- Product Grid -->
  <div id="sectionProductsList" 
       style="padding:14px; display:grid; grid-template-columns:repeat(2, 1fr); gap:14px;">
    <!-- dynamically inserted products -->
  </div>
</div>


<!-- ‚ù§Ô∏è Wishlist Modal -->
<div id="wishlistModal" 
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:#fff; z-index:3600; overflow:auto;">

  <!-- Header -->
  <div style="display:flex; justify-content:flex-end; padding:10px; background:#f5f5f5;
              box-shadow:0 2px 5px rgba(0,0,0,0.1);">
    <button onclick="closeWishlistModal()" 
            style="font-size:20px; padding:5px 10px; cursor:pointer; border:none; background:none;">‚úñ</button>
  </div>

  <!-- Content -->
  <div style="padding:24px; max-width:800px; margin:0 auto; font-family:sans-serif;">
    <h2 style="margin-bottom:18px; font-size:1.6rem; font-weight:700; color:#2c3e50;">‚ù§Ô∏è My Wishlist</h2>

    <!-- Wishlist List -->
    <div id="wishlistList" 
         style="margin-top:14px; background:#fafafa; border:1px solid #e5e7eb; border-radius:10px; 
                padding:16px; min-height:150px;">
      <!-- dynamically loaded wishlist items go here -->
    </div>
  </div>
</div>


<!-- ü§ñ BizMart AI Chat Assistant -->
<div id="aiChatModal" 
     style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);
            width:90%; max-width:750px; height:85%; max-height:750px;
            background:#fff; border-radius:20px; box-shadow:0 8px 30px rgba(0,0,0,0.35);
            display:none; flex-direction:column; z-index:4000; overflow:hidden;
            opacity:0; transition:opacity 0.3s ease, transform 0.3s ease;">

  <!-- Header -->
  <div style="background:linear-gradient(135deg, #3498db, #2ecc71); color:#fff; padding:16px; font-weight:600;
              display:flex; justify-content:space-between; align-items:center; font-size:18px;">
    <div style="display:flex; align-items:center; gap:10px;">
      <div style="width:32px; height:32px; border-radius:50%; background:#fff; display:flex; align-items:center; justify-content:center; color:#3498db; font-size:18px;">ü§ñ</div>
      <span>BizMart AI Assistant</span>
    </div>
    <button onclick="closeAIChat()" 
            style="background:none; border:none; color:#fff; font-size:22px; cursor:pointer;">‚úñ</button>
  </div>

  <!-- Chat Content -->
  <div id="aiChatBox" 
       style="flex:1; padding:16px; overflow-y:auto; font-size:15px; line-height:1.6; background:#f4f6f9;">
    <!-- Messages appear here -->
  </div>

  <!-- Input Area -->
  <div style="display:flex; align-items:center; gap:8px; padding:12px; border-top:1px solid #ddd; background:#fff;">
    <input id="aiChatInput" type="text" placeholder="Type a message..." 
           style="flex:1; border:1px solid #ccc; border-radius:20px; padding:10px 14px; font-size:15px; outline:none; transition:0.2s;">
    <button onclick="sendAIMessage()" 
            style="background:#3498db; color:#fff; border:none; border-radius:50%; width:40px; height:40px; font-size:18px; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.2); transition:0.2s;">
      ‚û§
    </button>
    <button onclick="startVoiceInput()" 
            style="background:#f1f1f1; border:none; border-radius:50%; width:40px; height:40px; font-size:18px; cursor:pointer; transition:0.2s;">
      üé§
    </button>
  </div>
</div>

<!-- ‚úÖ Floating AI Button Widget -->
<div id="aiWidgetContainer" 
     style="position:fixed; bottom:100px; right:20px; z-index:4000; display:inline-block;">

  <!-- Wrapper: contains ü§ñ + X -->
  <div id="aiButtonWrapper" style="position:relative; display:inline-block;">
    <!-- BizMart AI Button -->
    <button id="aiOpenBtn" onclick="openAIChat()" 
            style="width:40px; height:40px; border-radius:50%;
                   background:linear-gradient(135deg, #3498db, #2ecc71);
                   color:#fff; font-size:18px; border:none;
                   display:flex; align-items:center; justify-content:center;
                   box-shadow:0 4px 14px rgba(0,0,0,0.3); cursor:pointer;">
      ü§ñ
    </button>

    <!-- Close (X) Button -->
    <button id="aiCloseBtn" onclick="hideAIBizmart()" 
            style="position:absolute; top:-8px; right:-8px;
                   background:#ef4444; color:#fff; border:none;
                   width:18px; height:18px; border-radius:50%;
                   font-size:12px; line-height:1;
                   display:flex; align-items:center; justify-content:center;
                   cursor:pointer; box-shadow:0 1px 4px rgba(0,0,0,0.3);">
      ‚úñ
    </button>
  </div>

  <!-- ‚úÖ Single Speech Bubble -->
  <div id="aiPopupMessage" 
       style="position:absolute; top:50%; right:110%; transform:translateY(-50%);
              background:#fff; color:#333; padding:8px 14px; border-radius:8px;
              box-shadow:0 3px 8px rgba(0,0,0,0.2); font-size:12px;
              width:220px; line-height:1.3; display:none; opacity:0; transition:opacity 0.3s ease;">
  </div>

  <!-- ‚úÖ Single Show AI Button -->
  <button id="aiShowBtn" onclick="showAIBizmart()" 
          style="margin-top:6px; padding:3px 8px; border-radius:6px;
                 background:#f3f4f6; border:1px solid #ccc;
                 color:#333; font-size:12px; cursor:pointer;
                 box-shadow:0 2px 4px rgba(0,0,0,0.15); display:none;">
    Show AI
  </button>
</div>


<!-- üõ† Services Modal -->
<div id="servicesModal"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:#fff; z-index:6000; overflow-y:auto;">

  <!-- Header with Tabs -->
  <div style="display:flex; justify-content:space-between; align-items:center;
              padding:14px; background:#3498db; color:#fff; font-weight:600;
              box-shadow:0 2px 6px rgba(0,0,0,0.1);">
    <div style="flex:1; display:flex; gap:8px;">
      <button id="servicesTab" class="tab-btn active" onclick="showServicesTab()">üõ† Services</button>
      <button id="myServicesTab" class="tab-btn" onclick="showMyServicesTab()">üìë My Service Orders</button>
    </div>
    <button onclick="closeServicesModal()" 
            style="background:none; border:none; font-size:22px; color:#fff; cursor:pointer;">‚úñ</button>
  </div>

  <!-- Services Section -->
  <div id="servicesSection" style="padding:14px; display:block;">
    <div id="servicesList" style="display:grid; grid-template-columns:1fr; gap:14px;">
      <!-- dynamically loaded services -->
    </div>
  </div>

  <!-- My Services Section -->
<div id="myServicesSection" style="padding:14px; display:none;">

  <!-- ‚úÖ Filter buttons -->
  <div id="serviceOrdersFilters" style="margin-bottom:12px; text-align:center;">
    <button class="serviceFilterBtn active" data-status="Pending"   onclick="filterServiceOrders('Pending')">‚è≥ Pending</button>
    <button class="serviceFilterBtn"        data-status="Ready"     onclick="filterServiceOrders('Ready')">üì¶ Ready</button>
    <button class="serviceFilterBtn"        data-status="Completed" onclick="filterServiceOrders('Completed')">‚úÖ Completed</button>
    <button class="serviceFilterBtn"        data-status="Cancelled" onclick="filterServiceOrders('Cancelled')">‚ùå Cancelled</button>
  </div>

  <!-- ‚úÖ Orders container -->
  <div id="myServicesList">Loading...</div>
</div>

<!-- ‚ùå Cancel Service Confirmation Modal -->
<div id="cancelServiceModal"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.6); z-index:7001; align-items:center; justify-content:center;">
  <div style="background:#fff; padding:20px; border-radius:10px; max-width:420px; width:90%;
              box-shadow:0 4px 12px rgba(0,0,0,0.3); text-align:center;">
    <h3 style="margin-bottom:12px; font-size:18px; font-weight:600; color:#e74c3c;">
      ‚ùå Cancel Service Order
    </h3>
    <p style="color:#444; margin-bottom:14px;">
      We‚Äôre sorry to see you cancel this order.<br>
      Please share a reason so we can improve our service.
    </p>

    <!-- Reason input -->
    <textarea id="cancelReasonInput"
              placeholder="Enter reason for cancellation..."
              style="width:100%; min-height:70px; resize:vertical; padding:8px;
                     border:1px solid #ccc; border-radius:6px; margin-bottom:16px;"></textarea>

    <!-- Buttons -->
    <div style="display:flex; justify-content:center; gap:10px;">
      <button onclick="closeCancelServiceModal()"
              style="padding:8px 16px; border:none; border-radius:6px;
                     background:#7f8c8d; color:white; cursor:pointer;">
        ‚úñ No, Keep
      </button>
      <button id="confirmCancelServiceBtn"
              style="padding:8px 16px; border:none; border-radius:6px;
                     background:#e74c3c; color:white; cursor:pointer;">
        ‚úÖ Yes, Cancel
      </button>
    </div>
  </div>
</div>

<!-- ‚úÖ Service Done Confirmation Modal -->
<div id="serviceDoneModal"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.6); z-index:7002; align-items:center; justify-content:center;">
  <div style="background:#fff; padding:20px; border-radius:10px; max-width:420px; width:90%;
              box-shadow:0 4px 12px rgba(0,0,0,0.3); text-align:center;">
    <h3 style="margin-bottom:12px; font-size:18px; font-weight:600; color:#16a34a;">
      ‚úÖ Service Done
    </h3>
    <p style="color:#444; margin-bottom:14px;">
      Please confirm you have received your service request.
    </p>

    <!-- Buttons -->
    <div style="display:flex; justify-content:center; gap:10px;">
      <button onclick="closeServiceDoneModal()"
              style="padding:8px 16px; border:none; border-radius:6px;
                     background:#7f8c8d; color:white; cursor:pointer;">
        ‚úñ No
      </button>
      <button id="confirmServiceDoneBtn"
              style="padding:8px 16px; border:none; border-radius:6px;
                     background:#16a34a; color:white; cursor:pointer;">
        ‚úÖ Yes, Done
      </button>
    </div>
  </div>
</div>


<!-- ‚úÖ Success Modal (hidden by default) -->
<div id="successModal"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.6); z-index:8000; align-items:center; justify-content:center;">
  <div style="background:#fff; padding:20px; border-radius:10px; max-width:350px; width:90%; text-align:center;
              box-shadow:0 4px 12px rgba(0,0,0,0.3);">
    <h3 style="margin-bottom:12px; font-size:18px; font-weight:600; color:#27ae60;">
      ‚úÖ Success
    </h3>
    <p id="successMessage" style="color:#444; margin-bottom:20px;">
      Order cancelled successfully.
    </p>
    <button onclick="closeSuccessModal()"
            style="padding:8px 16px; border:none; border-radius:6px; background:#27ae60; color:white; cursor:pointer;">
      OK
    </button>
  </div>
</div>




<!-- üìÑ Service Order View Modal -->
<div id="serviceOrderViewModal"
     style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5);
            z-index:7000; align-items:center; justify-content:center;">
  <div style="background:#fff; padding:20px; border-radius:12px; max-width:500px; width:90%; box-shadow:0 4px 12px rgba(0,0,0,0.2);">
    <h3 style="margin-top:0; font-weight:600; color:#3498db;">üìë Service Order Details</h3>
    <div id="serviceOrderViewContent" style="margin-top:12px; color:#333;">
      <!-- details injected by JS -->
    </div>
    <div style="margin-top:16px; text-align:right;">
      <button onclick="closeServiceOrderView()"
              style="padding:6px 12px; border:none; border-radius:6px; background:#3498db; color:white; cursor:pointer;">
        ‚úñ Close
      </button>
    </div>
  </div>
</div>


<!-- ---------- Service Request Modal (client) ---------- -->
<div id="serviceRequestModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#fff; z-index:6600; overflow:auto;">
  <div style="display:flex; justify-content:flex-end; padding:10px; background:#f5f5f5;">
    <button onclick="closeServiceRequestModal()" style="font-size:20px;padding:5px 10px;cursor:pointer;">‚úñ</button>
  </div>

  <div style="padding:20px; max-width:720px; margin:0 auto;">
    <h2 style="font-size:1.25rem; font-weight:700; margin-bottom:8px;">üñ®Ô∏è Print Request</h2>

    <label style="font-weight:600;">Upload PDF</label>
    <input id="srFile" type="file" accept="application/pdf" style="display:block; margin:8px 0 14px;" />

    <label style="font-weight:600;">Message / Notes</label>
    <input id="srMessage" placeholder="e.g. Back to back page" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; margin-bottom:12px;" />

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
      <div>
        <label style="font-weight:600;">Paper Size</label>
        <select id="srSize" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px;">
          <option value="Short">Short</option>
          <option value="A4" selected>A4</option>
          <option value="Long">Long</option>
        </select>
      </div>

      <!-- üÜï Service Option instead of Color -->
      <div>
        <label style="font-weight:600;">Service Option</label>
        <select id="srServiceOption" onchange="serviceOptionChanged()" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px;">
          <option value="Pickup" selected>Pickup</option>
          <option value="Delivery">Delivery</option>
        </select>
      </div>
    </div>

    <!-- üÜï Delivery Time Slots (shown only when Delivery is chosen) -->
    <div id="srDeliveryRow" style="display:none; margin-bottom:12px;">
      <label style="font-weight:600;">Select Delivery Time</label>
      <select id="srDeliveryTime" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px;">
        <!-- Options will be dynamically populated from Google Sheet -->
      </select>
      <div style="font-size:12px; color:#666; margin-top:6px;">Additional ‚Ç±5.00 for delivery</div>
    </div>

    <!-- üÜï Pickup Time Input (shown only when Pickup is chosen) -->
    <div id="srPickupRow" style="display:block; margin-bottom:12px;">
      <label style="font-weight:600;">Preferred Pickup Time (10:00 AM ‚Äì 3:00 PM)</label>
      <input id="srPickupTime" type="time" min="10:00" max="15:00" value="10:00" 
             style="width:160px; padding:8px; border:1px solid #ccc; border-radius:6px; margin-top:6px;">
    </div>

    <div style="margin-top:10px; font-weight:700;">
      Estimated: <span id="srEstimate">‚Ç±0.00</span>
    </div>

    <div style="display:flex; gap:12px; margin-top:16px;">
      <!-- üÜï still with id for JS -->
      <button id="submitServiceBtn" onclick="submitServiceRequest()" style="flex:1; padding:12px; background:#27ae60; color:#fff; border:none; border-radius:8px; font-weight:700;">
        ‚úÖ Submit Request
      </button>
      <button onclick="closeServiceRequestModal()" style="flex:1; padding:12px; background:#c0392b; color:#fff; border:none; border-radius:8px; font-weight:700;">
        Cancel
      </button>
    </div>
    <div id="srStatus" style="margin-top:10px; color:#666; font-size:13px;"></div>
  </div>
</div>




<!-- Pasuyo Service Modal -->
<div id="pasuyoModal" 
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(255,255,255,0.98); z-index:9000; overflow-y:auto; pointer-events:auto;">

  <!-- Header -->
  <div style="display:flex; justify-content:flex-end; padding:10px; background:#f5f5f5;">
    <button onclick="closePasuyoModal()" 
            style="font-size:20px; padding:5px 10px; cursor:pointer; background:none; border:none;">‚úñ</button>
  </div>

  <!-- Content -->
  <div style="padding:24px; max-width:600px; margin:0 auto; font-family:sans-serif;">
    <h2 style="font-size:1.4rem; font-weight:700; color:#2c3e50; margin-bottom:14px;">
      üçî Pasuyo: Food Delivery Request
    </h2>

    <!-- Dynamic Food List -->
    <label style="font-weight:600; display:block; margin-bottom:6px;">Food to Buy (Canteen)</label>
    <div id="foodListContainer"></div>
    <button type="button" onclick="addFoodRow()" 
            style="margin-top:10px; padding:8px 12px; border:none; background:#3498db; color:#fff; 
                   border-radius:6px; cursor:pointer;">
      ‚ûï Add Food Item
    </button>

    <!-- Notes -->
    <label style="font-weight:600; margin-top:16px; display:block;">Additional Notes</label>
    <input id="pasuyoNotes" type="text" placeholder="e.g. no spicy, buy cold drinks"
           style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; margin-bottom:14px;">

    <!-- Preferred Pickup Time -->
<label style="font-weight:600; display:block;">
  Preferred Pickup Time <br>
  <span style="font-weight:normal; color:#666;">(10:00 AM ‚Äì 12:00 PM & 1:00 PM ‚Äì 3:00 PM)</span>
</label>
<input id="deliveryTime" type="time"
       style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; margin-bottom:14px;">


    <!-- Service Fee + Total -->
    <div id="pasuyoTotal" 
         style="margin-top:10px; font-weight:700; font-size:1.1rem; color:#e67e22;">
      Service Fee: ‚Ç±10.00 <br>Total: ‚Ç±10.00
    </div>

    <!-- Buttons -->
    <div style="margin-top:20px; display:flex; gap:10px;">
      <button onclick="submitPasuyo()" 
              style="flex:1; padding:12px; background:#27ae60; color:#fff; border:none; border-radius:8px; 
                     cursor:pointer; font-weight:600;">
        ‚úÖ Submit Request
      </button>
      <button onclick="closePasuyoModal()" 
              style="flex:1; padding:12px; background:#c0392b; color:#fff; border:none; border-radius:8px; 
                     cursor:pointer; font-weight:600;">
        ‚úñ Cancel
      </button>
    </div>
  </div>
</div>

<!-- Pasuyo Success Modal -->
<div id="pasuyoSuccessModal" 
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.6); z-index:10000; justify-content:center; align-items:center;">

  <div style="background:#fff; padding:24px; border-radius:12px; max-width:420px; text-align:center; font-family:sans-serif;">
    <h2 style="color:#27ae60; font-size:1.3rem; margin-bottom:12px;">‚úÖ Pasuyo Request Submitted</h2>
    <p style="color:#2c3e50; font-size:0.95rem; margin-bottom:16px; line-height:1.5;">
      üçî Your Pasuyo request has been submitted successfully!<br><br>
      <b>Reminder:</b> The staff will meet you <b>10 minutes before your chosen delivery time</b>.<br>
      Please prepare the fee ‚Äî <b>payment is required before delivery</b>.
    </p>
    <button onclick="closePasuyoSuccessModal()" 
            style="padding:10px 16px; background:#3498db; color:#fff; border:none; border-radius:6px; cursor:pointer;">
      OK
    </button>
  </div>
</div>

<!-- Print Request Confirmation Modal -->
<div id="printConfirmModal" 
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.4); z-index:7000; align-items:center; justify-content:center;">
  <div style="background:#fff; padding:24px 30px; border-radius:16px; 
              box-shadow:0 4px 10px rgba(0,0,0,0.2); max-width:360px; text-align:center; font-family:sans-serif;">
    
    <h3 style="margin:0 0 15px; font-size:18px; color:#2c3e50;">üñ®Ô∏è Confirm Print Request</h3>
    
    <p id="confirmDetails" style="margin:10px 0 20px; font-size:14px; color:#555;"></p>
    
    <!-- üîπ Loading text (hidden until processing starts) -->
    <p id="confirmLoading" style="display:none; font-size:13px; color:#27ae60; margin-top:10px;">
      ‚è≥ Processing order, please wait...
    </p>
    
    <div style="display:flex; justify-content:space-around; margin-top:20px;">
      <button onclick="closePrintConfirm()" 
              style="background:#ccc; color:#000; border:none; padding:8px 16px; border-radius:10px; font-size:14px; cursor:pointer;">
        Cancel
      </button>
      <button id="confirmPrintBtn" 
              style="background:#27ae60; color:#fff; border:none; padding:8px 16px; border-radius:10px; font-size:14px; cursor:pointer;">
        ‚úÖ Confirm
      </button>
    </div>
  </div>
</div>



<!-- Print Request Success Modal -->
<div id="printSuccessModal"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.4); z-index:7100; align-items:center; justify-content:center;">
  <div style="background:#fff; padding:24px 30px; border-radius:16px;
              box-shadow:0 4px 10px rgba(0,0,0,0.2); max-width:360px; text-align:center; font-family:sans-serif;">
    <h3 style="margin:0 0 15px; font-size:18px; color:#27ae60;">‚úÖ Print Request Submitted</h3>
    <p id="successDetails" style="margin:10px 0 20px; font-size:14px; color:#333;"></p>
    <div style="display:flex; justify-content:center; margin-top:20px;">
      <button onclick="closePrintSuccess()"
              style="background:#27ae60; color:#fff; border:none; padding:8px 16px; border-radius:10px; font-size:14px; cursor:pointer;">
        OK
      </button>
    </div>
  </div>
</div>





<!-- üîÑ Global Loading Overlay -->
<div id="loadingOverlay"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(255,255,255,0.85); z-index:9999; 
            align-items:center; justify-content:center; flex-direction:column;">
  <div class="spinner" 
       style="border:6px solid #f3f3f3; border-top:6px solid #3498db; border-radius:50%;
              width:50px; height:50px; animation: spin 1s linear infinite;"></div>
  <p style="margin-top:12px; font-weight:600; color:#2c3e50;">Processing your request...</p>
</div>


<!-- ‚ùå CANCEL ORDER MODAL -->
<div id="cancelOrderModal" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>Are you sure you want to cancel this order?</h3>
    <p>This action cannot be undone. The product stock will be restored.</p>
    <div class="modal-actions">
      <button onclick="closeCancelOrderModal()">No, Keep Order</button>
      <button id="confirmCancelOrderBtn" style="background:red; color:white;">
        ‚úÖ Yes, Cancel
      </button>
    </div>
  </div>
</div>





  <!-- Floating Subcategory Panel -->
  <div id="subcategoryPanel" class="subcategory-panel">
    <div class="subcategory-header">
      <span id="subcategoryTitle">Subcategories</span>
      <span style="cursor:pointer;" onclick="closeSubcategories()">‚úñ</span>
    </div>
    <div id="subcategoryList" class="subcategory-list"></div>
  </div>
</body>



<script>

function ensureLoggedIn() {
  const customerId = localStorage.getItem("customerId");
  const uniqueCode = localStorage.getItem("uniqueCode");

  // üîê Must have BOTH to be considered logged in
  if (!customerId || !uniqueCode) {
    console.log("‚ö†Ô∏è User not logged in, opening login modal");

    if (typeof openLoginModal === "function") {
      openLoginModal();
    } else {
      const modal = document.getElementById("loginModal");
      if (modal) {
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        modal.style.display = "flex";
      }
    }

    return false;
  }

  // ‚úÖ Only set currentCustomer when we really have login data
  if (!window.currentCustomer || !window.currentCustomer.id || !window.currentCustomer.uniqueCode) {
    window.currentCustomer = { id: customerId, uniqueCode };
  }

  return true;
}






function openLoginSignupModal() {
  const modal = document.getElementById("loginModal"); // ‚úÖ correct ID
  if (modal) {
    modal.classList.remove("hidden");
    modal.classList.add("flex");
  } else {
    alert("Please login or signup first.");
  }
}




document.addEventListener("DOMContentLoaded", () => {
  // ==============================
  // üöÄ SPLASH SCREEN QUICK HIDE
  // ==============================
  const splash = document.getElementById("splash");
  if (splash) {
    setTimeout(() => {
      splash.style.transition = "opacity 0.5s ease";
      splash.style.opacity = "0";
      setTimeout(() => splash.style.display = "none", 500);
    }, 3000);
  }

  // ==============================
  // üîê LOGIN STATUS SETUP
  // ==============================
  window.isUserLoggedIn = () => !!localStorage.getItem("customerId");

  window.logout = () => {
    // üîë Clear all saved session data
    localStorage.removeItem("customerId");
    localStorage.removeItem("uniqueCode");
    localStorage.removeItem("customerName");
    window.currentCustomer = null;

    console.log("üëã Logged out");

    // ‚úÖ Immediately update UI (no page reload)
    updateLoginStatusUI(false);
    if (typeof renderAuthControls === "function") {
      renderAuthControls();
    }

    // (Optional) clear user-specific sections if available
    if (typeof clearUserOrders === "function") clearUserOrders();
    if (typeof clearUserCart === "function") clearUserCart();
  };

  let savedCid = localStorage.getItem("customerId");
  let savedCode = localStorage.getItem("uniqueCode");

  if (savedCid && savedCode) {
    console.log("üîë Found saved session:", savedCid, savedCode);

    google.script.run.withSuccessHandler(function (isValid) {
      if (isValid) {
        window.currentCustomer = { id: savedCid, uniqueCode: savedCode };

        // ‚úÖ Immediately show logged-in UI
        updateLoginStatusUI(true);
        if (typeof renderAuthControls === "function") renderAuthControls();

        // ‚úÖ Fetch name and update UI once available
        google.script.run
          .withSuccessHandler(function (customerObj) {
            try {
              const name = customerObj && (customerObj.Name || customerObj["Customer Name"])
                ? (customerObj.Name || customerObj["Customer Name"])
                : "";
              localStorage.setItem("customerName", name);
              if (typeof renderAuthControls === "function") renderAuthControls();
            } catch (err) {
              console.warn("Could not extract customer name:", err);
            }
            console.log("‚úÖ Auto-login restored for:", savedCid);
          })
          .withFailureHandler(function (err) {
            console.warn("Failed to get customer info, leaving placeholder name:", err);
          })
          .getCustomerInfo(savedCid);

      } else {
        console.log("‚ö†Ô∏è Saved session invalid, clearing storage.");
        localStorage.removeItem("customerId");
        localStorage.removeItem("uniqueCode");
        localStorage.removeItem("customerName");
        window.currentCustomer = null;
        updateLoginStatusUI(false);
        if (typeof renderAuthControls === "function") renderAuthControls();
      }
    }).checkCustomerLogin(savedCid, savedCode);

  } else {
    console.log("üîí No saved login, user not logged in.");
    window.currentCustomer = null;
    updateLoginStatusUI(false);
    if (typeof renderAuthControls === "function") renderAuthControls();
  }

  // ==============================
  // ü§ñ BIZMART AI VISIBILITY SETUP
  // ==============================
  const aiWrapper = document.getElementById("aiButtonWrapper");
  const aiShowBtn = document.getElementById("aiShowBtn");

  if (aiWrapper && aiShowBtn) {
    if (localStorage.getItem("bizmartAIHidden") === "true") {
      aiWrapper.style.display = "none";
      aiShowBtn.style.display = "inline-block";
      if (typeof stopAIPopupLoop === "function") stopAIPopupLoop(true);
    } else {
      aiWrapper.style.display = "inline-block";
      aiShowBtn.style.display = "none";
      if (typeof startPopupLoop === "function") startPopupLoop();
    }
  }

  // ==============================
  // üì¶ Existing initialization
  // ==============================
  google.script.run.withSuccessHandler(renderCategories).getCategories();
  google.script.run.withSuccessHandler(renderNewArrivals).getNewArrivals();
  google.script.run.withSuccessHandler(renderOnSale).getOnSaleProducts();
  google.script.run.withSuccessHandler(renderFeatured).getFeaturedProducts();
  google.script.run.withSuccessHandler(renderBundles).getBundles();

  // ==============================
  // üì¢ Announcements
  // ==============================
  google.script.run.withSuccessHandler((data) => {
    if (Array.isArray(data) && data.length > 0) {
      announcements = data;
      currentAnnouncementIndex = 0;
      showAnnouncementModal();
      if (announcements.length > 1) {
        startAnnouncementSlideshow();
      }
    } else {
      console.log("‚ÑπÔ∏è No announcements available.");
    }
  }).getAnnouncements();

  // ==============================
  // üìã Orders Status Tabs
  // ==============================
  const statusTabs = document.querySelectorAll(".status-tab");
  statusTabs.forEach(btn => {
    btn.addEventListener("click", () => {
      const status = btn.dataset.status;
      statusTabs.forEach(t => {
        t.classList.remove("active");
        t.setAttribute("aria-pressed", "false");
      });
      btn.classList.add("active");
      btn.setAttribute("aria-pressed", "true");
      loadOrders(status);
    });
  });

  // ==============================
  // üì¶ Order Modal Handling
  // ==============================
  const om = document.getElementById("orderModal");
  if (om) {
    document.body.appendChild(om);
    om.style.zIndex = "10000";
    om.classList.add("hidden");
    om.style.display = "none";
  }

  // ==============================
  // üé® Nav Flash Animation
  // ==============================
  document.querySelectorAll(".bottom-nav .nav-item").forEach(item => {
    item.addEventListener("click", () => {
      item.classList.add("flash");
      setTimeout(() => item.classList.remove("flash"), 300);
    });
  });

  // ==============================
  // üöö Order Actions
  // ==============================
  document.addEventListener("click", (e) => {
    if (e.target.classList.contains("pickedUpBtn")) {
      const orderId = e.target.dataset.orderId;
      openPickupConfirm(orderId);
    }
  });

  document.getElementById("confirmPickupBtn").addEventListener("click", function () {
    if (!selectedOrderId) return;
    google.script.run
      .withSuccessHandler(() => {
        showPickedUpSuccessModal();
        closePickupConfirm();
        loadOrders("Ready");
      })
      .markOrderAsPickedUp(selectedOrderId);
  });

  document.getElementById("confirmCancelBtn").addEventListener("click", function () {
    if (!cancelOrderId) return;
    google.script.run
      .withSuccessHandler(() => {
        showCancelSuccessModal();
        closeCancelConfirm();
        loadOrders("Cancelled");
      })
      .cancelOrderById(cancelOrderId);
  });

  document.addEventListener("click", function (e) {
    if (e.target.classList.contains("deliverBtn")) {
      const orderId = e.target.dataset.orderId;
      showModalConfirm(
        "Confirm this order has been delivered?",
        () => {
          google.script.run
            .withSuccessHandler(res => {
              if (res.success) {
                showModalMessage("‚úÖ Order marked as Completed!");
                loadOrders();
              } else {
                showModalMessage("‚ö†Ô∏è Failed: " + res.message);
              }
            })
            .markOrderAsDelivered(orderId);
        }
      );
    }
  });

  // ==============================
  // üõ† Services Initialization
  // ==============================
  const servicesList = document.getElementById("servicesList");
  if (servicesList) {
    console.log("üîß Initializing services...");
    google.script.run.withSuccessHandler(renderServices).getServices();
  } else {
    console.warn("‚ö†Ô∏è servicesList not found yet. Will reload when modal opens.");
  }

  console.log("‚úÖ Page initialized: products, bundles, announcements, status tabs, nav flash, order modal, pickup confirm modal, cancel confirm modal, deliver confirm modal, and services ready.");
});
















// Render Categories
function renderCategories(categories) {
  const container = document.getElementById("categoryList");
  container.innerHTML = "";
  categories.forEach(cat => {
    const div = document.createElement("div");
    div.className = "circle-btn";
    div.setAttribute("data-name", cat.name);
    div.innerHTML = `<div class="circle-shape"><img src="${cat.icon || 'https://placehold.co/60'}" alt="${cat.name}"></div>`;
    div.onclick = () => renderSubcategories(cat);
    container.appendChild(div);
  });
}

let cachedServices = null;
let currentCancelOrderId = null; 
let aiAutoHideTimeout = null;
let isLoggedIn = false;
let cancelProductId = null;
let cancelOrderId = null;
let selectedOrderId = null;
let checkoutSubtotal = 0;
let checkoutDeliveryFee = 5;
let cartItems = [];
let productIntervals = [];
let activeCategoryId = null; 
let activeSubId = null;
let announcements = [];
let currentAnnouncementIndex = 0;
let announcementInterval;
let currentServiceDoneOrderId = null;

// Render Subcategories
function renderSubcategories(category) {
  const subHeader = document.getElementById("subHeader");
  const subContainer = document.getElementById("subCategoryList");
  const prodHeader = document.getElementById("prodHeader");
  const prodWrapper = document.getElementById("productsWrapper");

  if (activeCategoryId === category.id) {
    subHeader.style.display = "none";
    subContainer.style.display = "none";
    subContainer.innerHTML = "";
    activeCategoryId = null;

    prodHeader.style.display = "none";
    prodWrapper.style.display = "none";
    document.getElementById("productList").innerHTML = "";
    activeSubId = null;
    return;
  }

  subHeader.style.display = "flex";
  subContainer.style.display = "flex";
  subContainer.innerHTML = "";

  prodHeader.style.display = "none";
  prodWrapper.style.display = "none";
  document.getElementById("productList").innerHTML = "";

  activeCategoryId = category.id;
  activeSubId = null;

  category.subcategories.forEach(sub => {
    const div = document.createElement("div");
    div.className = "circle-btn";
    div.setAttribute("data-name", sub.name);
    div.innerHTML = `<div class="circle-shape"><img src="${sub.icon || 'https://via.placeholder.com/60'}" alt="${sub.name}"></div>`;

    div.onclick = () => {
      if (activeSubId === sub.id) {
        prodHeader.style.display = "none";
        prodWrapper.style.display = "none";
        document.getElementById("productList").innerHTML = "";
        activeSubId = null;
        return;
      }

      document.querySelector("#prodHeader .section-title").innerText = sub.name;
      prodHeader.style.display = "flex";
      loadProducts(category.id, sub.id);
      activeSubId = sub.id;
    };

    subContainer.appendChild(div);
  });
}




// Payment Modal
function openPaymentModal(productId) {
  if (!productId) { alert("Product ID missing!"); return; }

  const modal = document.getElementById("paymentModal");
  const iframe = document.getElementById("paymentFrame");

  iframe.srcdoc = `
    <!DOCTYPE html>
    <html>
      <body style="margin:0; height:100%;">
        <form id="paymentForm" method="GET" action="https://script.google.com/macros/s/AKfycbxNfKjDHIXbbjYyg1t7cqc5rPDRrHQmzV2XRUcYYXt3pfHp8hlFv_cpQRCqyOZ-SMxX8g/exec" style="display:none;">
          <input type="hidden" name="productId" value="${productId}">
        </form>
        <script>
          document.getElementById('paymentForm').submit();
        <\/script>
      </body>
    </html>
  `;

  modal.style.display = "block";
}

function closePaymentModal() {
  const modal = document.getElementById("paymentModal");
  const iframe = document.getElementById("paymentFrame");

  iframe.srcdoc = "about:blank";
  iframe.src = "about:blank";

  modal.style.display = "none";
}


// -----------------------------
// Helper function to create product card HTML
// -----------------------------
function createProductCardHTML(p) {
  const badgeList = [];
  if (p.onSale === "YES") badgeList.push('<div class="badge badge-sale">SALE</div>');
  if (p.newArrival === "YES") badgeList.push('<div class="badge badge-new">NEW</div>');
  if (p.bestSeller === "YES") badgeList.push('<div class="badge badge-hot">HOT</div>');
  if (p.featured === "YES") badgeList.push('<div class="badge badge-featured">FEATURED</div>');

  let imageURLs = p.image ? p.image.split(",").map(url => url.trim()) : ['https://via.placeholder.com/150'];

  let imageHtml = `<div class="product-img-wrapper" style="position:relative; height:140px;">`;
  imageURLs.forEach((url, idx) => {
    imageHtml += `<img src="${url}" alt="${p.name}" data-carousel
                   style="position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover;
                          transition:opacity 0.5s; ${idx === 0 ? 'opacity:1;' : 'opacity:0;'}">`;
  });

  // ‚úÖ Put badges + wishlist button together
  imageHtml += `
    <div class="badges-wrapper">
      ${badgeList.join("")}
      <button class="wishlist-btn" onclick="toggleWishlist(event, '${p.id}')">ü§ç</button>
    </div>
  </div>`;

  const infoHtml = `
    <div class="product-info">
      <div class="product-name">${p.name}</div>
      <div class="price">‚Ç±${p.price}</div>
    </div>
  `;

  return `
    <div class="product-card" data-id="${p.id}" style="position:relative;">
      ${imageHtml}
      ${infoHtml}
    </div>
  `;
}






// -----------------------------
// Carousel Setup
// -----------------------------
function setupCarousel(card, intervalArrayName) {
  const images = card.querySelectorAll('img[data-carousel]');
  if (images.length <= 1) return;

  let currentIndex = 0;
  const intervalId = setInterval(() => {
    images[currentIndex].style.opacity = 0;
    currentIndex = (currentIndex + 1) % images.length;
    images[currentIndex].style.opacity = 1;
  }, 3000);

  // Keep track of interval so it can be cleared later
  if (!window[intervalArrayName]) window[intervalArrayName] = [];
  window[intervalArrayName].push(intervalId);
}

// -----------------------------
// Render New Arrivals
// -----------------------------
function renderNewArrivals(products) {
  window.newArrivalProducts = products;
  const container = document.getElementById("newArrivalsList");
  container.innerHTML = "";

  if (!Array.isArray(products) || products.length === 0) {
    container.innerHTML = "<p style='padding:14px;'>No new arrivals.</p>";
    return;
  }

  // Clear previous intervals
  if (window.newArrivalIntervals) window.newArrivalIntervals.forEach(id => clearInterval(id));
  window.newArrivalIntervals = [];

  products.slice().reverse().forEach(p => {
    const card = document.createElement("div");
    card.className = "product-card";
    card.style.position = "relative"; // allow absolute positioning like OnSale

    // Product content
    const content = document.createElement("div");
    content.className = "card-content";
    content.innerHTML = createProductCardHTML(p);
    card.appendChild(content);

    // ‚úÖ Add wishlist button (same pattern as OnSale)
    const wishlistBtn = document.createElement("button");
    wishlistBtn.className = "wishlist-btn";
    wishlistBtn.innerText = "ü§ç";
    wishlistBtn.setAttribute("data-pid", p.id);
    wishlistBtn.onclick = (e) => toggleWishlist(e, p.id);
    card.appendChild(wishlistBtn);

    // ‚úÖ Card click opens details
    card.onclick = () => {
      if (p.id) openProductDetailModal(p);
      else alert("Product ID missing!");
    };

    container.appendChild(card);

    // ‚úÖ Carousel support
    setupCarousel(card, "newArrivalIntervals");
  });

  // ‚úÖ Update hearts according to wishlist state
  markWishlistButtons();
}




// -----------------------------
// Render On Sale
// -----------------------------
function renderOnSale(products) {
  window.onSaleProducts = products;
  const container = document.getElementById("onSaleList");
  container.innerHTML = "";

  if (!Array.isArray(products) || products.length === 0) {
    container.innerHTML = "<p style='padding:14px;'>No products on sale.</p>";
    return;
  }

  if (window.onSaleIntervals) window.onSaleIntervals.forEach(id => clearInterval(id));
  window.onSaleIntervals = [];

  products.slice().reverse().forEach(p => {
    const card = document.createElement("div");
    card.className = "product-card";
    card.style.position = "relative"; // allow absolute positioning

    // üî• Flame confetti canvas
    const canvas = document.createElement("canvas");
    canvas.className = "flame-confetti";
    card.appendChild(canvas);

    // Product content
    const content = document.createElement("div");
    content.className = "card-content";
    content.innerHTML = createProductCardHTML(p);
    card.appendChild(content);

    // ‚úÖ Add wishlist button directly to card (not inside content)
    const wishlistBtn = document.createElement("button");
    wishlistBtn.className = "wishlist-btn";
    wishlistBtn.innerText = "ü§ç";
    wishlistBtn.setAttribute("data-pid", p.id);
    wishlistBtn.onclick = (e) => toggleWishlist(e, p.id);
    card.appendChild(wishlistBtn);

    // Resize confetti canvas
    setTimeout(() => {
      canvas.width = card.offsetWidth + 8;
      canvas.height = card.offsetHeight + 8;
      if (typeof setupFlameConfetti === "function") {
        setupFlameConfetti(canvas);
      }
    }, 50);

    card.onclick = () => {
      if (p.id) openProductDetailModal(p);
      else alert("Product ID missing!");
    };

    container.appendChild(card);
    setupCarousel(card, "onSaleIntervals");
  });

  markWishlistButtons(); // ‚úÖ ensure hearts update
}







function setupFlameConfetti(canvas) {
  const ctx = canvas.getContext("2d");
  const N = 30;

  const parts = Array.from({ length: N }, () => ({
    x: Math.random() * canvas.width,
    y: Math.random() * canvas.height,
    r: 2,
    vx: (Math.random() - 0.5) * 1,
    vy: -0.5 - Math.random() * 1.5,
    life: 40 + Math.random() * 40
  }));

  function loop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    parts.forEach(p => {
      p.x += p.vx;
      p.y += p.vy;
      p.life--;

      if (p.life <= 0 || p.y < -5) {
        p.x = Math.random() * canvas.width;
        p.y = canvas.height + 5;
        p.life = 40 + Math.random() * 40;
      }

      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
      ctx.fillStyle = `hsla(${30 + Math.random() * 40}, 100%, 50%, 0.8)`;
      ctx.fill();
    });

    requestAnimationFrame(loop);
  }

  loop();
}






// -----------------------------
// Render Featured
// -----------------------------
function renderFeatured(products) {
  window.featuredProducts = products;
  const container = document.getElementById("featuredList");
  container.innerHTML = "";

  if (!products || !products.length) {
    container.innerHTML = "<p style='padding:14px;'>No featured products.</p>";
    return;
  }

  // Clear any existing carousel intervals
  if (window.featuredIntervals) {
    window.featuredIntervals.forEach(id => clearInterval(id));
  }
  window.featuredIntervals = [];

  products.slice().reverse().forEach(p => {
    const card = document.createElement("div");
    card.className = "product-card";
    card.style.position = "relative"; // ‚úÖ needed for heart absolute positioning

    // ‚úÖ Render product card with sale price check
    const content = document.createElement("div");
    content.className = "card-content";
    content.innerHTML = createProductCardHTML({
      ...p,
      displayPrice:
        p.onSale === "YES" && p.salePrice && p.salePrice.trim() !== ""
          ? `<span class="line-through text-gray-400 mr-2">‚Ç±${p.price}</span>
             <span class="text-red-600 font-bold">‚Ç±${p.salePrice}</span>`
          : `<span class="font-bold">‚Ç±${p.price}</span>`
    });
    card.appendChild(content);

    // ‚úÖ Wishlist button
    const wishlistBtn = document.createElement("button");
    wishlistBtn.className = "wishlist-btn";
    wishlistBtn.innerText = "ü§ç";
    wishlistBtn.setAttribute("data-pid", p.id);
    wishlistBtn.onclick = (e) => toggleWishlist(e, p.id);
    card.appendChild(wishlistBtn);

    // ‚úÖ Card click handler
    card.onclick = () => {
      if (p.id) {
        openProductDetailModal(p);
      } else {
        alert("Product ID missing!");
      }
    };

    container.appendChild(card);

    // ‚úÖ Setup carousel for multiple images
    setupCarousel(card, "featuredIntervals");
  });

  // ‚úÖ Update hearts to match wishlist
  markWishlistButtons();
}


function renderBundles(bundles) {
  window.bundleProducts = bundles || [];
  window.bundles = Array.isArray(bundles)
    ? bundles.filter(Boolean).map(b => ({
        ...b,
        sellerId: b.sellerId || ""   // ‚úÖ ensure sellerId always present
      }))
    : [];

  // ‚úÖ Prefer existing section if it exists
  let container = document.getElementById('bundlesList');
  let section = container?.closest('#bundlesSection') 
             || container?.closest('#bundlesWrapper') 
             || document.getElementById('bundlesSection');

  if (!container) {
    section = document.createElement('div');
    section.id = 'bundlesSection';
    section.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;padding:0 10px;margin-top:20px;">
        <h3 style="font-size:18px;display:flex;align-items:center;gap:6px;">üéí <span>Study Bundles</span></h3>
        <button id="seeAllBundlesBtn" style="background:none;border:none;color:#3b82f6;font-size:14px;cursor:pointer;">See All</button>
      </div>
      <div id="bundlesList" style="display:flex;overflow-x:auto;gap:16px;padding:15px;"></div>
    `;
    const featured = document.getElementById('featuredWrapper');
    const newArrivals = document.getElementById('newArrivalsWrapper');
    if (featured && featured.parentNode) {
      featured.parentNode.insertBefore(section, featured.nextSibling);
    } else if (newArrivals && newArrivals.parentNode) {
      newArrivals.parentNode.insertBefore(section, newArrivals);
    } else {
      document.body.appendChild(section);
    }
    container = section.querySelector('#bundlesList');
  } else {
    container.innerHTML = ''; // clear old cards
  }

  // ‚úÖ Render bundle cards
  (window.bundles || []).filter(b => b.active).forEach((b, i) => {
    const images = b.items?.flatMap(it => it.images || []).filter(Boolean) || [];
    if (images.length === 0 && b.image) images.push(b.image);

    const carouselId = `bundle-carousel-${i}`;

    const card = document.createElement('div');
    card.className = 'product-card';
    card.style.cssText = `
      flex:0 0 180px;
      border:2px solid #b3541e;   /* üî• Dark orange border */
      border-radius:12px;
      background:#fff;
      padding:14px;
      cursor:pointer;
      text-align:center;
      box-shadow:0 2px 5px rgba(0,0,0,0.05);
      position:relative;
    `;

    // ‚úÖ Handle badges (like products)
    const badges = [];
    if (String(b.onSale || '').toUpperCase() === 'YES') badges.push('<div class="badge badge-sale">SALE</div>');
    if (String(b.newArrival || '').toUpperCase() === 'YES') badges.push('<div class="badge badge-new">NEW</div>');
    if (String(b.bestSeller || '').toUpperCase() === 'YES') badges.push('<div class="badge badge-hot">HOT</div>');
    if (String(b.featured || '').toUpperCase() === 'YES') badges.push('<div class="badge badge-featured">FEATURED</div>');
    const badgeHtml = badges.length ? `<div class="badges-wrapper" style="position:absolute;top:6px;right:6px;display:flex;flex-direction:column;gap:4px;">${badges.join('')}</div>` : '';

    // ‚úÖ Handle bundle sale price formatting
    let priceHTML = "";
    if (b.salePrice && Number(b.salePrice) > 0) {
      priceHTML = `
        <div style="font-weight:700;color:#e67e22;">
          <span style="text-decoration:line-through;color:#999;margin-right:6px;">‚Ç±${b.price}</span>
          <span style="color:#d32f2f;">‚Ç±${b.salePrice}</span>
        </div>
      `;
    } else {
      priceHTML = `<div style="font-weight:700;color:#e67e22;">‚Ç±${b.price}</div>`;
    }

    card.innerHTML = `
      <div style="width:100%;height:120px;overflow:hidden;border-radius:8px;margin-bottom:10px;position:relative;">
        <img id="${carouselId}" src="${images[0] || ''}" style="width:100%;height:100%;object-fit:cover;border-radius:8px;">
        ${badgeHtml}
      </div>
      <div style="font-size:14px;font-weight:600;color:#374151;margin-bottom:4px;">${b.name}</div>
      ${priceHTML}
      <div style="font-size:12px;color:#555;">${(b.items || []).length} items</div>
    `;

    if (images.length > 1) {
      let idx = 0;
      setInterval(() => {
        idx = (idx + 1) % images.length;
        const img = document.getElementById(carouselId);
        if (img) img.src = images[idx];
      }, 3000);
    }

    // ‚úÖ Wishlist heart button
    const wishlistBtn = document.createElement("button");
    wishlistBtn.className = "wishlist-btn";
    wishlistBtn.innerText = "ü§ç";
    wishlistBtn.setAttribute("data-pid", b.id);
    wishlistBtn.onclick = (e) => toggleWishlist(e, b.id);
    card.appendChild(wishlistBtn);

    // ‚úÖ Open details modal
    card.addEventListener('click', () => openBundleDetails(b));

    container.appendChild(card);
  });

  // ‚úÖ Sync hearts with saved wishlist
  markWishlistButtons();
}






// Load & Render Products for selected category/subcategory
function loadProducts(categoryId, subId) {
  google.script.run.withSuccessHandler(renderProducts).getProductsByCategory(categoryId, subId);
}

// Render Products (subcategory)
function renderProducts(products) {
  const prodHeader = document.getElementById("prodHeader");
  const prodWrapper = document.getElementById("productsWrapper");
  const container = document.getElementById("productList");

  prodHeader.style.display = "flex";
  prodWrapper.style.display = "block";
  container.innerHTML = "";

  if (!products.length) {
    container.innerHTML = "<p style='padding:14px;'>No products available.</p>";
    return;
  }

  // Clear previous carousel intervals for categories
  if (window.categoryIntervals) window.categoryIntervals.forEach(id => clearInterval(id));
  window.categoryIntervals = [];

  // Reverse products so newest appear first
  products.slice().reverse().forEach(p => {
    const card = document.createElement("div");
    card.className = "product-card";

    // Use the existing helper to create product card HTML (handles multiple images + badges)
    card.innerHTML = createProductCardHTML(p);

    // Click handler for product detail modal
    card.onclick = () => {
      if (!p.id) {
        alert("Product ID missing!");
        return;
      }
      openProductDetailModal(p);
    };

    container.appendChild(card);

    // Setup carousel for multiple images
    setupCarousel(card, 'categoryIntervals');
  });
}






// Floating Subcategory Panel
function closeSubcategories() {
  document.getElementById("subcategoryPanel").classList.remove("active");
}

// PRODUCT DETAIL MODAL LOGIC WITH CAROUSEL
let currentProduct = null;
let productDetailInterval = null;
let currentDetailIndex = 0;

function openProductDetailModal(product) {
  currentProduct = product;

  // Clear previous carousel interval
  clearInterval(productDetailInterval);
  currentDetailIndex = 0;

  // Handle multiple images (comma-separated)
  let imageURLs = [];
  if (product.image) {
    imageURLs = product.image.split(",").map(url => url.trim());
  } else {
    imageURLs = ['https://via.placeholder.com/150'];
  }

  const detailImage = document.getElementById("detailImage");
  detailImage.src = imageURLs[0];

  // Start carousel if more than 1 image
  if (imageURLs.length > 1) {
    productDetailInterval = setInterval(() => {
      currentDetailIndex = (currentDetailIndex + 1) % imageURLs.length;
      detailImage.src = imageURLs[currentDetailIndex];
    }, 3000); // change image every 3 seconds
  }

  // ‚úÖ Handle price with sale price
  let priceHTML = "";
  if (product.salePrice && Number(product.salePrice) > 0) {
    priceHTML = `
      <span class="line-through text-gray-400 mr-2">‚Ç±${product.price}</span>
      <span class="text-red-600 font-bold">‚Ç±${product.salePrice}</span>
    `;
  } else {
    priceHTML = `‚Ç±${product.price}`;
  }

  // Set other product details
  document.getElementById("detailName").innerText = product.name;
  document.getElementById("detailPrice").innerHTML = priceHTML;  // ‚úÖ use innerHTML for formatted price
  document.getElementById("detailStock").innerText = `Stock: ${product.stock || 'N/A'}`;
  document.getElementById("detailBrand").innerText = `Brand: ${product.brand || 'N/A'}`;
  document.getElementById("detailDescription").innerText = `Description: ${product.description || 'N/A'}`;
  document.getElementById("detailWeight").innerText = `Weight: ${product.weight || 'N/A'}`;
  document.getElementById("detailDimensions").innerText = `Dimensions: ${product.dimensions || 'N/A'}`;
  document.getElementById("detailColor").innerText = `Color: ${product.color || 'N/A'}`;
  document.getElementById("detailMaterial").innerText = `Material: ${product.material || 'N/A'}`;

  document.getElementById("productDetailModal").style.display = "block";
}

function closeProductDetail() {
  document.getElementById("productDetailModal").style.display = "none";
  currentProduct = null;
  clearInterval(productDetailInterval); // stop carousel when modal closes
  currentDetailIndex = 0;
}


function buyNow() {
  if (!currentProduct || !currentProduct.id) {
    alert("‚ùå No product selected!");
    return;
  }

  // üîê Require login first
  if (!ensureLoggedIn()) return;

  // --- Pull from currentCustomer (session/local storage) ---
  const buyerName    = window.currentCustomer?.name || "";
  const buyerContact = window.currentCustomer?.contactNo || "";
  const buyerSection = window.currentCustomer?.section || "";
  const buyerGrade   = window.currentCustomer?.grade || "";
  const buyerId      = window.currentCustomer?.id || ""; // ‚úÖ CustomerID

  // Hide product detail modal (if open)
  const productModal = document.getElementById("productDetailModal");
  if (productModal) productModal.style.display = "none";

  // ‚úÖ Get quantity from detailQty input
  const qty = Number(document.getElementById("detailQty")?.value || 1);

  // ‚úÖ Use sale price if available, else fallback to regular price
  const unitPrice =
    currentProduct.salePrice && Number(currentProduct.salePrice) > 0
      ? Number(currentProduct.salePrice)
      : Number(currentProduct.price);

  const subtotal = unitPrice * qty;

  // --- Save product selection globally (both vars for compatibility) ---
  window.selectedBuyNow = {
    type: "product",
    product: currentProduct,
    quantity: qty
  };

  window.selectedBuyNowProduct = {
    id: currentProduct.id,
    name: currentProduct.name,
    price: unitPrice,
    image: currentProduct.image || "",
    sellerId: currentProduct.sellerId || "", // ‚úÖ ensure sellerId travels
    quantity: qty,
    items: currentProduct.items || null,     // üîπ for bundles
    customerId: buyerId                      // ‚úÖ pass CustomerID along
  };

  // Render product/bundle into modal
  const productContainer = document.getElementById("buyNowProductItem");
  if (productContainer) {
    let contentsHtml = "";
    if (currentProduct.items) {
      contentsHtml = `
        <div style="margin-top:6px;">
          Contents: 
          <button style="padding:2px 8px;font-size:12px;" 
                  onclick="openBundleDetails(window.selectedBuyNowProduct)">
            üëÄ View Details
          </button>
        </div>
      `;
    }

    productContainer.innerHTML = `
      <div style="display:flex; align-items:center; gap:12px;">
        <img src="${currentProduct.image || ''}" 
             alt="${currentProduct.name}" 
             style="width:80px;height:80px;object-fit:cover;border-radius:8px;">
        <div>
          <div style="font-weight:600;">${currentProduct.name}</div>
          ${
            currentProduct.salePrice && Number(currentProduct.salePrice) > 0
              ? `<div><span class="line-through text-gray-400 mr-2">‚Ç±${currentProduct.price}</span><span class="text-red-600 font-bold">‚Ç±${unitPrice}</span></div>`
              : `<div>‚Ç±${unitPrice}</div>`
          }
          <div>Qty: ${qty}</div>
          ${contentsHtml}
        </div>
      </div>
    `;
  }

  // Fill totals
  document.getElementById("buyNowSubtotal").textContent = `‚Ç±${subtotal}`;
  document.getElementById("buyNowDeliveryFee").textContent = "‚Ç±0.00";
  document.getElementById("buyNowTotal").textContent = `‚Ç±${subtotal}`;

  // Reset and pre-fill customer info
  document.getElementById("buyNowName").value = buyerName || "";
  document.getElementById("buyNowContact").value = buyerContact || "";
  document.getElementById("buyNowSection").value = buyerSection || "";
  document.getElementById("buyNowGrade").value = buyerGrade || "";

  // Reset delivery option
  document.getElementById("buyNowPickup").checked = true;
  document.getElementById("buyNowDelivery").checked = false;
  document.getElementById("buyNowDeliveryFields").style.display = "none";

  // üîÑ Load delivery times
  const timeSelect = document.getElementById("buyNowDeliveryTime");
  if (timeSelect) {
    timeSelect.innerHTML = `<option value="">Select delivery option first</option>`;
    google.script.run.withSuccessHandler(function(times) {
      timeSelect.innerHTML = `<option value="">Select Time</option>`;
      (times || []).forEach(t => {
        const optId = t?.id || t?.['Option ID'] || "";
        const optLabel = t?.label || t?.['Time Slot'] || "";
        const available = (t?.Available ?? t?.available) ?? null;

        const include =
          (optId && optLabel && available == null) || // server format {id,label}
          (String(available).toLowerCase() === "yes"); // sheet format

        if (include) {
          timeSelect.innerHTML += `<option value="${optId}">${optLabel}</option>`;
        }
      });

      if (timeSelect.options.length === 1) {
        timeSelect.innerHTML = `<option value="">No delivery slots available</option>`;
      }
    }).getAvailableDeliveryTimes();
  }

  // üîÑ Attach change listener to update total when delivery option changes
  const deliveryRadios = document.querySelectorAll("input[name='buyNowDeliveryOption']");
  deliveryRadios.forEach(radio => {
    radio.onchange = () => {
      const isDelivery = document.getElementById("buyNowDelivery").checked;
      const deliveryFee = isDelivery ? 5 : 0;
      document.getElementById("buyNowDeliveryFee").textContent = `‚Ç±${deliveryFee}`;
      document.getElementById("buyNowTotal").textContent = `‚Ç±${subtotal + deliveryFee}`;
      document.getElementById("buyNowDeliveryFields").style.display = isDelivery ? "block" : "none";

      if (!isDelivery && timeSelect) {
        timeSelect.value = "";
      }
    };
  });

  // Show Buy Now modal
  const buyNowModal = document.getElementById("buyNowModal");
  if (buyNowModal) buyNowModal.style.display = "block";
}











// Show modal when Account button is clicked
// Show modal when Account button is clicked
function switchTab(tab) {
  document.querySelectorAll("#homeSection, #wishlistSection, #cartModal, #purchasesModal")
    .forEach(sec => sec.style.display = "none");

  if (tab === "home") {
    document.getElementById("homeSection").style.display = "block";
  } else if (tab === "wishlist") {
    renderWishlist();
    document.getElementById("wishlistSection").style.display = "block";
  }
}


function openAccountModal() {
  document.getElementById('accountModal').style.display = "block";
  showLogin(); // default view
}
function closeAccountModal() {
  document.getElementById('accountModal').style.display = "none";
}
function showCreateAccount() {
  document.getElementById('loginForm').style.display = "none";
  document.getElementById('createForm').style.display = "block";
}
function showLogin() {
  document.getElementById('createForm').style.display = "none";
  document.getElementById('loginForm').style.display = "block";
}

// Generate Unique Code like CM-XXXXX
function generateUniqueCode() {
  return "CM-" + Math.floor(10000 + Math.random() * 90000);
}

// Create Account
function createCustomer() {
  const name = document.getElementById("createName").value;
  const contact = document.getElementById("createContact").value;
  const email = document.getElementById("createEmail").value;
  const grade = document.getElementById("createGrade").value;
  const section = document.getElementById("createSection").value;
  const uniqueCode = generateUniqueCode();

  if (!name || !contact || !email) {
    alert("‚ö†Ô∏è Please fill in all required fields.");
    return;
  }

  google.script.run.withSuccessHandler(function(customerId) {
    alert("‚úÖ Account created!\nCustomer ID: " + customerId + "\nUnique Code: " + uniqueCode);
    closeAccountModal();
  }).addCustomerToSheet(name, contact, email, grade, section, uniqueCode);
}

// Login
function loginCustomer() {
  const id = document.getElementById("loginCustomerId").value;
  const code = document.getElementById("loginUniqueCode").value;

  google.script.run.withSuccessHandler(function(success) {
    if (success) {
      alert("‚úÖ Login successful!");
      closeAccountModal();
    } else {
      alert("‚ùå Invalid Customer ID or Unique Code.");
    }
  }).checkCustomerLogin(id, code);
}

function createAccount() {
    const name = document.getElementById("name").value.trim();
    const contact = document.getElementById("contact").value.trim();
    const email = document.getElementById("email").value.trim();
    const grade = document.getElementById("grade").value.trim();
    const section = document.getElementById("section").value.trim();

    if (!name || !contact || !email || !grade || !section) {
      alert("‚ùå Please fill in all fields.");
      return;
    }

    // Generate a random unique code for the new customer
    const uniqueCode = Math.random().toString(36).substr(2, 6).toUpperCase();

    google.script.run
      .withSuccessHandler(function(res) {
        if (res.success) {
          alert("‚úÖ Account created successfully!\nYour Customer ID: " + res.customerId + "\nYour Code: " + uniqueCode);
          document.getElementById("signupModal").style.display = "none";
        } else {
          alert("‚ùå " + res.message);
        }
      })
      .addCustomerToSheet(name, contact, email, grade, section, uniqueCode);
  }

function showAnnouncementModal() {
  if (announcements.length === 0) return;
  document.getElementById("announcementImage").src = announcements[currentAnnouncementIndex];
  document.getElementById("announcementModal").style.display = "flex";
}

function closeAnnouncementModal() {
  document.getElementById("announcementModal").style.display = "none";
  clearInterval(announcementInterval);
}

function startAnnouncementSlideshow() {
  clearInterval(announcementInterval);
  announcementInterval = setInterval(() => {
    currentAnnouncementIndex = (currentAnnouncementIndex + 1) % announcements.length;
    document.getElementById("announcementImage").src = announcements[currentAnnouncementIndex];
  }, 4000); // 4 seconds per image (adjust as needed)
}

// --- Open Cart Modal ---
function openCartModal() {
  // üîê Require login first
  if (!ensureLoggedIn()) return;

  let modal = document.getElementById("cartModal");
  if (!modal) {
    // create modal dynamically
    modal = document.createElement("div");
    modal.id = "cartModal";
    modal.className = "hidden"; // start hidden, let Tailwind handle visibility
    modal.style.cssText = `
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:#fff;
      z-index:5000;
      overflow:auto;
    `;
    modal.innerHTML = `
      <div style="display:flex;justify-content:flex-end;padding:10px;background:#f5f5f5;box-shadow:0 2px 5px rgba(0,0,0,0.1);">
        <button onclick="closeCartModal()" style="font-size:20px;padding:5px 10px;cursor:pointer;">‚úñ</button>
      </div>
      <div id="cartContent" style="padding:20px;"></div>
    `;
    document.body.appendChild(modal);
  }

  // ‚úÖ Load cart items for logged-in user
  renderCart();

  // ‚úÖ Show modal (clear inline styles + use classes)
  modal.classList.remove("hidden");
  modal.classList.add("flex");
  modal.style.display = ""; // clear inline override if any
}

// --- Close Cart Modal ---
function closeCartModal() {
  const modal = document.getElementById("cartModal");
  if (modal) {
    modal.classList.add("hidden");
    modal.classList.remove("flex");
    modal.style.display = ""; // reset inline style
  }
}



// ‚úÖ Add to Cart
function addToCart() {
  if (!currentProduct) {
    showToast("‚ö†Ô∏è Please select a product first!");
    return;
  }

  // ‚úÖ Require login
  if (!ensureLoggedIn()) return;

  // ‚úÖ Get CustomerID from localStorage only
  const cid = localStorage.getItem("customerId");
  if (!cid) {
    openLoginSignupModal();
    return;
  }

  let qty = parseInt(document.getElementById("detailQty").value);
  if (isNaN(qty) || qty <= 0) qty = 1;

  // ‚úÖ Use sale price if available, else fallback to regular price
  const unitPrice =
    currentProduct.salePrice && Number(currentProduct.salePrice) > 0
      ? Number(currentProduct.salePrice)
      : Number(currentProduct.price);

  const newItem = {
    CustomerID: cid,  // ‚úÖ always a string, never an object
    ProductID: currentProduct.id,
    SellerID: currentProduct.sellerId || "",
    ProductName: currentProduct.name,
    Quantity: qty,
    UnitPrice: unitPrice,
    Subtotal: qty * unitPrice,
    DateAdded: new Date().toISOString(), // safe for server
    Status: "Active"
  };

  showToast("‚è≥ Adding to cart...");

  google.script.run
    .withSuccessHandler(function (res) {
      if (res && res.success) {
        showCartSuccessModal(`${qty} √ó ${currentProduct.name} added to cart!`);
        google.script.run
          .withSuccessHandler(renderCart)
          .getCartByCustomer(cid); // ‚úÖ cart lookup by string ID
        closeProductDetail();
      } else {
        showToast("‚ùå Failed to add item to cart.");
        console.error("addCartItems result:", res);
      }
    })
    .withFailureHandler(function (err) {
      console.error("Add to cart failed:", err);
      alert("‚ùå Error: Could not save to cart. See console for details.");
    })
    .addCartItems([newItem]);
}













// Simple toast function (can be replaced with better UI)
function showToast(message) {
  const toast = document.createElement("div");
  toast.className = "toast-message";
  toast.textContent = message;
  document.body.appendChild(toast);

  setTimeout(() => {
    toast.classList.add("show");
  }, 10);

  setTimeout(() => {
    toast.classList.remove("show");
    setTimeout(() => document.body.removeChild(toast), 300);
  }, 2000);
}


function updateCartModal() {
  const container = document.getElementById("cartItemsContainer");
  container.innerHTML = "";

  if (cartItems.length === 0) {
    container.innerHTML = "<p>Your cart is empty.</p>";
    document.getElementById("cartTotal").innerText = "";
    return;
  }

  let total = 0;

  cartItems.forEach((item, index) => {
    const subtotal = item.price * item.quantity;
    total += subtotal;

    const div = document.createElement("div");
    div.className = "cart-item";
    div.style.marginBottom = "10px";
    div.style.borderBottom = "1px solid #ccc";
    div.style.paddingBottom = "8px";

    div.innerHTML = `
      <strong>${item.name}</strong> <br>
      Quantity: ${item.quantity} <br>
      Unit Price: ‚Ç±${item.price.toFixed(2)} <br>
      Subtotal: ‚Ç±${subtotal.toFixed(2)} <br>
      <button class="remove-btn" data-index="${index}">Remove</button>
    `;
    container.appendChild(div);
  });

  document.getElementById("cartTotal").innerText = `Total: ‚Ç±${total.toFixed(2)}`;
  document.getElementById("cartModal").style.display = "block";

  // Add remove functionality
  document.querySelectorAll(".remove-btn").forEach(btn => {
    btn.addEventListener("click", function() {
      const idx = parseInt(this.getAttribute("data-index"));
      cartItems.splice(idx, 1);
      updateCartModal();
    });
  });
}

// Optional: function to close cart modal
function closeCartModal() {
  document.getElementById("cartModal").style.display = "none";
}


// ‚úÖ Render Cart Items
// ---------- REPLACE renderCart(serverRows) ----------
function renderCart(serverRows) {
  // If serverRows is an array, normalize it into client cartItems
  if (Array.isArray(serverRows)) {
    cartItems = serverRows.map(row => {
      const name = row["Product Name"] || row.ProductName || row.name || "";
      const qty = Number(row["Quantity"] || row.Quantity || row.quantity || 0);
      const price = Number(row["Unit Price (‚Ç±)"] || row["Unit Price"] || row.UnitPrice || row.price || 0);
      const subtotal = Number(row["Subtotal (‚Ç±)"] || row.Subtotal || qty * price || 0);
      return {
        // keep both canonical and original keys for backward compatibility
        name,
        quantity: qty,
        price,
        subtotal,
        productId: row["ProductID"] || row.ProductID || row.productId || "",
        // keep server-style keys used by other parts
        ProductName: name,
        Quantity: qty,
        UnitPrice: price,
        Subtotal: subtotal
      };
    });
  }

  // Now render using the normalized cartItems array
  const container = document.getElementById("cartItemsContainer");
  if (!container) return;
  container.innerHTML = "";
  let total = 0;

  cartItems.forEach((item) => {
    const name = item.ProductName || item.name || "";
    const qty = Number(item.Quantity || item.quantity || 0);
    const price = Number(item.UnitPrice || item.price || 0);
    const subtotal = Number(item.Subtotal || item.subtotal || qty * price || 0);
    total += subtotal;

    const div = document.createElement("div");
    div.style.borderBottom = "1px solid #ddd";
    div.style.padding = "8px 0";
    div.innerHTML = `
      <div><b>${escapeHtml(name)}</b></div>
      <div>Price: ‚Ç±${price}</div>
      <div>Quantity: ${qty}</div>
      <div>Subtotal: ‚Ç±${subtotal}</div>
    `;
    container.appendChild(div);
  });

  const totalEl = document.getElementById("cartTotal");
  if (totalEl) totalEl.innerText = "Total: ‚Ç±" + total;
}


function escapeHtml(str) {
  if (!str && str !== 0) return "";
  return String(str).replace(/[&<>"'`]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;',"`":'&#x60;'}[s]));
}

// ‚úÖ Open / Close Cart
function openCartModal() {
  document.getElementById("cartModal").style.display = "block";
}
function closeCartModal() {
  document.getElementById("cartModal").style.display = "none";
}

// Clear Cart
function clearCartItems() {
  cartItems = [];
  renderCart();
}

// ‚úÖ Checkout Function
function checkout() {
  if (cartItems.length === 0) {
    alert("‚ö†Ô∏è Your cart is empty.");
    return;
  }

  let summary = "üõí Checkout Summary:\n\n";
  let total = 0;

  cartItems.forEach(item => {
    let subtotal = item.price * item.quantity;
    total += subtotal;
    summary += `${item.name} - ‚Ç±${item.price} x ${item.quantity} = ‚Ç±${subtotal}\n`;
  });

  summary += `\nTOTAL: ‚Ç±${total}`;

  alert(summary);

  // Optional: clear cart after checkout
  // cartItems = [];
  // renderCart();
  // closeCartModal();
}


function saveCartToSheet() {
  // Instead of saving again, just reload from server
  const customerId = window.currentCustomer?.id;
  if (!customerId) return;

  google.script.run.withSuccessHandler(renderCart).getCartByCustomer(customerId);
  showToast("üîÑ Cart refreshed!");
}


// Clear Cart
function clearCartItems() {
  if (!confirm("Are you sure you want to clear the cart?")) return;
  cartItems = [];
  updateCartModal();
}


// üü¢ Telegram-based checkout (no device ID lookup)
function openCheckoutModal() {
  const existingCid = window.currentCustomer?.id || localStorage.getItem('customerId');

  // helper that prefills and loads cart for a known customerId
  const showForCustomer = (customerId) => {
    if (!customerId) {
      // If no customer (guest) ‚Äî prompt login/signup
      openLoginSignupModal();
      return;
    }

    // set currentCustomer safely
    window.currentCustomer = { id: customerId };

    // Prefill customer info from TelegramUsers sheet
    google.script.run.withSuccessHandler(function(customerObj) {
      if (customerObj) {
        document.getElementById("checkoutName").value    = customerObj["FullName"] || "";
        document.getElementById("checkoutContact").value = customerObj["Contact"] || "";
        const gradeSelect = document.getElementById("checkoutGrade");
        const gradeValue = customerObj["Grade"] || "";
        if (gradeSelect && gradeValue) gradeSelect.value = gradeValue;
        document.getElementById("checkoutSection").value = customerObj["Section"] || "";
      }
    }).getCustomerInfo(customerId);

    // Load authoritative cart data
    google.script.run.withSuccessHandler(renderCheckout).getCartItems(customerId);

    // Load delivery times
    google.script.run.withSuccessHandler(function(times) {
      const select = document.getElementById("checkoutDeliveryTime");
      if (!select) return;

      // Save times globally so we can re-populate if needed
      window.__availableDeliveryTimes = times;

      // Preserve previous selection if any
      const prev = window.__lastCheckoutTime || "";
      select.innerHTML = `<option value="">Select Time</option>`;
      times.forEach(t => {
        // ‚úÖ Only include if Available is Yes/true
        if (t["Available"] === true || t["Available"] === "Yes" || t["Available"] === "TRUE") {
          const opt = document.createElement("option");
          opt.value = t["Option ID"];
          opt.textContent = t["Time Slot"];
          if (t["Option ID"] === prev) opt.selected = true;
          select.appendChild(opt);
        }
      });

      // Save selection for later
      select.onchange = () => { window.__lastCheckoutTime = select.value; };
    }).getAvailableDeliveryTimes();

    // Default delivery fee (always 5 when Delivery is selected)
    const feeEl = document.getElementById("checkoutDeliveryFee");
    if (feeEl) {
      feeEl.dataset.fee = "5";       // ‚úÖ use 5 instead of 3
      feeEl.innerText = "‚Ç±0.00";     // stays 0 until Delivery option is chosen
    }

    // Show modal
    const modal = document.getElementById("checkoutModal");
    if (modal) {
      modal.style.display = "block";
      // ‚úÖ Lock background scroll
      document.body.style.overflow = "hidden";
    }
  };

  // ‚úÖ If user already logged in with Telegram
  if (existingCid) {
    showForCustomer(existingCid);
  } else {
    // No Telegram login yet ‚Üí force login/signup
    openLoginSignupModal();
  }
}








function closeCheckoutModal() {
  const modal = document.getElementById("checkoutModal");
  if (modal) modal.style.display = "none";

  // ‚úÖ Clear cart UI so old data isn‚Äôt shown next time
  document.getElementById("checkoutCartItems").innerHTML = "";
  document.getElementById("checkoutSubtotal").textContent = "‚Ç±0.00";
  document.getElementById("checkoutTotal").textContent = "‚Ç±0.00";

  // ‚úÖ Optionally clear customer fields too
  document.getElementById("checkoutName").value = "";
  document.getElementById("checkoutContact").value = "";
  document.getElementById("checkoutGrade").value = "";
  document.getElementById("checkoutSection").value = "";

  // ‚úÖ Restore page scroll
  document.body.style.overflow = "";
}



// Load data for checkout: prefill customer info and fetch cart items
function loadCheckoutData(customerId) {
  // Prefill customer info (if exists)
  google.script.run.withSuccessHandler(function(customerObj) {
    if (customerObj) {
      // try common header keys used in Customers sheet
      const name = customerObj["Name"] || customerObj.Name || customerObj["Customer Name"] || "";
      const contact = customerObj["Contact"] || customerObj.Contact || customerObj["ContactNo"] || "";
      const grade = customerObj["Grade"] || customerObj.Grade || "";
      const section = customerObj["Section"] || customerObj.Section || "";

      document.getElementById("checkoutName").value = name;
      document.getElementById("checkoutContact").value = contact;
      document.getElementById("checkoutGrade").value = grade;
      document.getElementById("checkoutSection").value = section;
    }
  }).getCustomerInfo(customerId);

  // Load cart items from server (authoritative)
  google.script.run.withSuccessHandler(renderCheckoutCartItems).getCartByCustomer(customerId);
}

// ---------- ADD new helper renderCheckoutCartItems ----------
function renderCheckoutCartItems(serverRows) {
  // serverRows is an array of cart-row objects (Cart sheet rows mapped to headers)
  const items = (Array.isArray(serverRows) ? serverRows.map(r => {
    const name = r["Product Name"] || r.ProductName || r.name || "";
    const qty = Number(r["Quantity"] || r.Quantity || r.quantity || 0);
    const price = Number(r["Unit Price (‚Ç±)"] || r.UnitPrice || r.price || 0);
    const subtotal = Number(r["Subtotal (‚Ç±)"] || r.Subtotal || (qty * price) || 0);
    return {
      name,
      quantity: qty,
      price,
      subtotal,
      productId: r["ProductID"] || r.ProductID || r.productId || ""
    };
  }) : []);

  const subtotal = items.reduce((s, it) => s + (it.subtotal || it.price * it.quantity), 0);
  const cartData = { items, subtotal, deliveryFee: 5, total: subtotal + 5 };

  // reuse existing renderCheckout which expects { items, subtotal, deliveryFee, total }
  renderCheckout(cartData);
}






function normalizeCartItem(it) {
  const name = it["Product Name"] || it.ProductName || it.name || it["ProductName"] || "";
  const qty = Number(it["Quantity"] || it.Quantity || it.quantity || 0);
  const unitPrice = Number(it["Unit Price (‚Ç±)"] || it.UnitPrice || it.price || it["Unit Price"] || 0);
  const subtotal = Number(it["Subtotal (‚Ç±)"] || it.Subtotal || qty * unitPrice || 0);
  return { name, qty, unitPrice, subtotal, raw: it };
}

function renderCheckout(cartData) {
  const cartItems = cartData.items || [];
  const container = document.getElementById("checkoutCartItems");
  container.innerHTML = "";

  // ‚úÖ set globals for subtotal
  window.__checkout_subtotal = cartData.subtotal || 0;
  const deliveryFee = cartData.deliveryFee || 5;

  if (cartItems.length === 0) {
    container.innerHTML = "<p class='text-gray-500'>Your cart is empty.</p>";
  } else {
    cartItems.forEach(item => {
      const row = document.createElement("div");
      row.className = "checkout-item";
      row.style.cssText = "display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #eee;";

      row.innerHTML = `
        <div>
          <p class="font-medium">${item.name}</p>
          <p class="text-sm text-gray-500">Qty: ${item.quantity} √ó ‚Ç±${item.price.toFixed(2)}</p>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <span class="font-semibold">‚Ç±${item.subtotal.toFixed(2)}</span>
          <button class="cancel-btn" data-id="${item.productId}" 
                  style="color:red;border:none;background:none;cursor:pointer;font-size:14px;">‚úñ</button>
        </div>
      `;

      container.appendChild(row);
    });

    // Attach cancel events
    container.querySelectorAll(".cancel-btn").forEach(btn => {
      btn.addEventListener("click", function () {
        const productId = this.getAttribute("data-id");
        const customerId = window.currentCustomer?.id;
        if (!customerId) return;

        if (confirm("Remove this item from your cart?")) {
          this.disabled = true;
          this.textContent = "‚Ä¶";

          google.script.run
            .withSuccessHandler(() => {
              google.script.run.withSuccessHandler(renderCheckout).getCartItems(customerId);
            })
            .withFailureHandler(() => {
              this.disabled = false;
              this.textContent = "‚úñ";
              alert("Failed to remove item. Please try again.");
            })
            .removeCartItem(customerId, productId);
        }
      });
    });
  }

  // ‚úÖ update summary
  document.getElementById("checkoutSubtotal").innerText = `‚Ç±${window.__checkout_subtotal.toFixed(2)}`;
  const feeEl = document.getElementById("checkoutDeliveryFee");
  feeEl.innerText = `‚Ç±${deliveryFee.toFixed(2)}`;
  feeEl.dataset.fee = deliveryFee;

  // ‚úÖ preserve selected option
  const pickupRadio = document.getElementById("deliveryOptionPickup");
  const deliveryRadio = document.getElementById("deliveryOptionDelivery");

  let selectedOption = "Pickup"; // default
  if (deliveryRadio && deliveryRadio.checked) selectedOption = "Delivery";

  // set fee global based on current selection
  if (selectedOption === "Delivery") {
    window.__checkout_fee = deliveryFee;
  } else {
    window.__checkout_fee = 0;
  }

  updateCheckoutTotal(selectedOption);

  // ‚úÖ bind radio events only once
  if (pickupRadio && !pickupRadio.dataset.bound) {
    pickupRadio.addEventListener("change", () => updateCheckoutTotal("Pickup"));
    pickupRadio.dataset.bound = "true";
  }
  if (deliveryRadio && !deliveryRadio.dataset.bound) {
    deliveryRadio.addEventListener("change", () => updateCheckoutTotal("Delivery"));
    deliveryRadio.dataset.bound = "true";
  }
}




function updateCheckoutTotal(option) {
  const subtotal = Number(window.__checkout_subtotal || 0);
  const feeEl = document.getElementById('checkoutDeliveryFee');
  if (!feeEl) return;

  let fee = 0;
  if (option === 'Delivery') {
    // prefer numeric dataset, fallback to global
    fee = Number(feeEl.dataset.fee || window.__checkout_fee || 0);
    if (isNaN(fee)) fee = 0;
    window.__checkout_fee = fee;
    feeEl.innerText = `‚Ç±${fee.toFixed(2)}`;
    // show delivery-specific fields
    const deliveryFields = document.getElementById('deliveryFields');
    if (deliveryFields) deliveryFields.style.display = 'block';
  } else {
    fee = 0;
    window.__checkout_fee = 0;
    feeEl.innerText = `‚Ç±0.00`;
    const deliveryFields = document.getElementById('deliveryFields');
    if (deliveryFields) deliveryFields.style.display = 'none';
  }

  const total = subtotal + fee;
  document.getElementById('checkoutTotal').innerText = `‚Ç±${total.toFixed(2)}`;
}



function onDeliveryOptionChange(option) {
  const feeEl = document.getElementById("checkoutDeliveryFee");
  if (!feeEl) return;

  if (option === "Delivery") {
    document.getElementById("deliveryFields").style.display = "block";

    // ‚úÖ Always use ‚Ç±5 as fallback delivery fee
    let fee = parseFloat(feeEl.dataset.fee);
    if (isNaN(fee) || fee <= 0) fee = 5;

    window.__checkout_fee = fee;
    feeEl.dataset.fee = fee;
    feeEl.innerText = `‚Ç±${fee.toFixed(2)}`;

    // ‚úÖ Re-populate delivery times if dropdown is empty
    const select = document.getElementById("checkoutDeliveryTime");
    if (select && window.__availableDeliveryTimes) {
      if (!select.options || select.options.length <= 1) {
        const prev = window.__lastCheckoutTime || "";
        select.innerHTML = `<option value="">Select Time</option>`;
        window.__availableDeliveryTimes.forEach(t => {
          const opt = document.createElement("option");
          opt.value = t.id;
          opt.textContent = t.label;
          if (t.id === prev) opt.selected = true;
          select.appendChild(opt);
        });
      }
    }

  } else {
    document.getElementById("deliveryFields").style.display = "none";
    window.__checkout_fee = 0;
    feeEl.dataset.fee = "0";
    feeEl.innerText = `‚Ç±0.00`;
  }

  recalcCheckoutTotals();
}




function recalcCheckoutTotals() {
  const subtotal = Number(window.__checkout_subtotal || 0);
  const fee = Number(window.__checkout_fee || 0);
  const total = subtotal + fee;

  document.getElementById("checkoutTotal").innerText = `‚Ç±${total.toFixed(2)}`;
}




// Submit checkout
function submitCheckout() {
  const customerId = window.currentCustomer?.id;
  if (!customerId) {
    alert("Customer not detected. Please login or try again.");
    return;
  }

  const name = document.getElementById("checkoutName").value.trim();
  const contact = document.getElementById("checkoutContact").value.trim();
  const grade = document.getElementById("checkoutGrade").value.trim();
  const section = document.getElementById("checkoutSection").value.trim();
  const deliveryOption = document.querySelector('input[name="deliveryOption"]:checked')?.value || "Pickup";
  const deliveryTime = document.getElementById("checkoutDeliveryTime").value || "";
  const deviceId = localStorage.getItem("deviceId") || "";

  const deliveryFee = Number(window.__checkout_fee || 0);

  if (!name || !contact) {
    alert("Please enter your Name and Contact number before checking out.");
    return;
  }

  const payload = {
    customerName: name,
    contactNo: contact,
    grade: grade,
    section: section,
    deliveryOption: deliveryOption,
    deliveryTime: deliveryTime,
    deliveryFee: deliveryFee,
    deviceId: deviceId
  };

  // ‚úÖ Show loading modal first
  showCheckoutLoading();

  google.script.run
    .withSuccessHandler(function(res) {
      hideCheckoutLoading(); // stop loading
      if (res && res.success) {
        showCheckoutSuccessModal("‚úÖ Order placed! Order IDs: " + (res.orderIds || []).join(", "));
        cartItems = [];
        if (typeof updateCartModal === "function") updateCartModal();
        closeCheckoutModal();
      } else {
        alert("‚ùå Checkout failed: " + (res && res.message ? res.message : "Unknown error"));
      }
    })
    .withFailureHandler(function(err) {
      hideCheckoutLoading();
      alert("‚ùå Error submitting order. Please try again.");
      console.error(err);
    })
    .checkoutCart(customerId, payload);
}




// Load available delivery times from backend
function loadDeliveryTimes() {
  google.script.run.withSuccessHandler(function(times) {
    const select = document.getElementById("checkoutDeliveryTime");
    select.innerHTML = `<option value="">Select Time</option>`;
    times.forEach(t => {
      select.innerHTML += `<option value="${t.id}">${t.label}</option>`;
    });
  }).getAvailableDeliveryTimes();
}

// show success modal with message
function showCartSuccessModal(message, duration = 1500) {
  const modal = document.getElementById('cartSuccessModal');
  const msg = document.getElementById('cartSuccessMessage');
  if (!modal || !msg) return;

  msg.textContent = message || 'Added to cart!';
  modal.style.display = 'flex';          // make visible
  // small timeout to allow CSS transition (force repaint)
  setTimeout(() => modal.classList.add('show'), 10);

  // auto-close
  setTimeout(() => {
    modal.classList.remove('show');
    // wait for animation to finish before hiding
    setTimeout(() => { modal.style.display = 'none'; }, 280);
  }, duration);
}

// improved toast (visible)
function showToast(message, duration = 1600) {
  const existing = document.querySelector('.toast-message');
  if (existing) existing.remove();

  const toast = document.createElement('div');
  toast.className = 'toast-message';
  toast.textContent = message || '';
  document.body.appendChild(toast);

  // show
  setTimeout(() => toast.classList.add('show'), 10);

  // hide
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 260);
  }, duration);
}

function showCheckoutSuccessModal(message, duration = 1800) {
  const modal = document.getElementById('checkoutSuccessModal');
  const msg = document.getElementById('checkoutSuccessMessage');
  if (!modal || !msg) return;

  msg.textContent = message || 'Your order has been placed!';
  modal.style.display = 'flex';
  setTimeout(() => modal.classList.add('show'), 10);

  setTimeout(() => {
    modal.classList.remove('show');
    setTimeout(() => { modal.style.display = 'none'; }, 280);
  }, duration);
}

function showCheckoutLoading() {
  const modal = document.getElementById('checkoutLoadingModal');
  if (modal) modal.style.display = 'flex';
}

function hideCheckoutLoading() {
  const modal = document.getElementById('checkoutLoadingModal');
  if (modal) modal.style.display = 'none';
}

function openPurchasesModal() {
  document.getElementById("purchasesModal").style.display = "block";
  loadOrders("Pending"); // will return both Pending + Pending Verification
}

function closePurchasesModal() {
  document.getElementById("purchasesModal").style.display = "none";
}

// Load orders by status (replace existing)
function loadOrders(status) {
  // ‚úÖ Always try both window.currentCustomer and localStorage
  const customerId =
    window.currentCustomer?.id ||
    window.currentCustomer?.CustomerID ||
    localStorage.getItem("customerId");

  const ordersList = document.getElementById("ordersList");

  console.log("loadOrders called with:", { customerId, status });

  if (!customerId) {
    ordersList.innerHTML = "<p>‚ö†Ô∏è Please log in first.</p>";
    return;
  }

  // Show loading state
  ordersList.innerHTML = "<p>‚è≥ Loading orders...</p>";

  google.script.run
    .withSuccessHandler(function(orders) {
      console.log("Orders returned:", orders);

      if (!orders || !orders.length) {
        ordersList.innerHTML = "<p>üì≠ No orders found.</p>";
        return;
      }

      // save globally for other handlers to update instantly
    window.ordersData = Array.isArray(orders) ? orders : [];
    renderOrders(window.ordersData, status);

    })
    .withFailureHandler(function(err) {
      console.error("getOrdersByStatus failed:", err);
      ordersList.innerHTML = "<p style='color:red;'>‚ùå Error retrieving orders. Please try again.</p>";
    })
    .getOrdersByStatus(customerId, status);
}




// Render orders
function renderOrders(orders) {
  const list = document.getElementById("ordersList");
  list.innerHTML = "";

  if (!orders || !orders.length) {
    list.innerHTML = "<p style='padding:10px;'>No purchases found.</p>";
    return;
  }

  orders.forEach((order, index) => {
    const orderId = order.OrderID || order.orderId || "N/A";
    const date = order.DateOrdered || order.Date || order.date || "N/A";
    const status = order.Status || order.status || "N/A";
    const deliveryOption = order.DeliveryOption || order.deliveryOption || "Pickup";
    const total = order["Total (‚Ç±)"] || order.Total || order.total || 0;

    let productName = "Unknown";
    let images = [];

    // --- üîπ Case 1: Normal product order ---
    if (order.ProductID) {
      const product = (window.products || []).find(p => String(p.id) === String(order.ProductID));
      productName = product ? product.name : (order.ProductName || "Unknown");
      if (product?.images?.length) images = product.images;
      else if (product?.image) images = [product.image];
      else if (order.ProductImage) images = [order.ProductImage];
    }
    // --- üîπ Case 2: Bundle order ---
    else {
      const bundleId =
        order["Bundle ID"] ||
        order.BundleID ||
        order.bundleId ||
        order.Bundle_Id ||
        "";

      if (bundleId) {
        let bundle = (window.bundles || []).find(b =>
          String(b.id) === String(bundleId) ||
          String(b["Bundle ID"]) === String(bundleId) ||
          String(b.BundleID) === String(bundleId)
        );

        // üåÄ If not found, fetch bundles then re-render
        if (!bundle && !window._bundleFetchAttempted) {
          window._bundleFetchAttempted = true;
          google.script.run.withSuccessHandler(serverBundles => {
            window.bundles = Array.isArray(serverBundles) ? serverBundles : [];
            renderOrders(orders);
          }).getBundles();
        }

        if (bundle) {
          productName = bundle.name || bundle["Bundle Name"] || "Unnamed Bundle";
          images = bundle.items?.flatMap(i => i.images || (i.image ? [i.image] : [])) || [];
          if (!images.length && bundle.image) images = [bundle.image];
        } else {
          productName = "Bundle " + bundleId;
        }
      }
    }

    // --- üì∏ Image/Carousel ---
    const carouselId = `order-carousel-${index}`;
    const imgHTML = images.length
      ? `<div style="width:70px;height:70px;overflow:hidden;border-radius:8px;border:1px solid #eee;">
           <img id="${carouselId}" src="${images[0]}" 
                style="width:100%;height:100%;object-fit:cover;border-radius:8px;">
         </div>`
      : `<div style="width:70px;height:70px;display:flex;align-items:center;justify-content:center;border-radius:8px;background:#f3f4f6;color:#9ca3af;font-size:12px;">No Image</div>`;

    // --- Action buttons ---
    const cancelBtnHTML =
      status === "Pending" || status === "Pending Verification"
        ? `<button class="cancel-order-btn"
             style="flex:1;padding:8px 0;border:1px solid #dc2626;background:#fff;color:#dc2626;border-radius:8px;font-size:14px;cursor:pointer;"
             onclick="openCancelConfirm('${orderId}')">
             ‚ùå Cancel Order
           </button>`
        : "";

    const pickedUpBtnHTML =
      status === "Ready"
        ? `<button class="pickedUpBtn" data-order-id="${orderId}"
                 style="flex:1;padding:8px 0;border:1px solid #16a34a;background:#fff;color:#16a34a;border-radius:8px;font-size:14px;cursor:pointer;">
           ‚úÖ Picked Up
         </button>`
        : "";

    const deliverBtnHTML =
      deliveryOption === "Delivery" && status === "Out for Delivery"
        ? `<button class="deliverBtn" data-order-id="${orderId}"
                 style="flex:1;padding:8px 0;border:1px solid #f59e0b;background:#fff;color:#f59e0b;border-radius:8px;font-size:14px;cursor:pointer;">
           üöö Confirm Delivery
         </button>`
        : "";

    const downloadBtnHTML =
      status === "Completed"
        ? `<button class="download-btn"
                 data-order-id="${orderId}"
                 style="flex:1;padding:8px 0;border:none;background:#10b981;color:#fff;border-radius:8px;font-size:14px;cursor:pointer;">
           üì• Download
         </button>`
        : "";

    // --- Build order card ---
    const card = document.createElement("div");
    card.className = "purchase-card";
    card.style.cssText =
      "border:1px solid #ddd;border-radius:10px;padding:16px;margin:12px 0;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,0.05);display:flex;gap:12px;align-items:flex-start;";

    card.innerHTML = `
      ${imgHTML}
      <div style="flex:1;font-size:14px;line-height:1.5;">
        <div><b>üÜî</b> ${orderId}</div>
        <div><b>Date:</b> ${date}</div>
        <div><b>Product:</b> ${productName}</div>
        <div><b>Status:</b> <span style="color:${statusColor(status)};">${status}</span></div>
        <div><b>Total:</b> <span style="color:#16a34a;">‚Ç±${total}</span></div>
        <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;">
          ${cancelBtnHTML}
          ${pickedUpBtnHTML}
          ${deliverBtnHTML}
          <button class="view-btn"
                  style="flex:1;padding:8px 0;border:none;background:#3b82f6;color:#fff;border-radius:8px;font-size:14px;cursor:pointer;">
            View
          </button>
          ${downloadBtnHTML}
        </div>
      </div>
    `;

    // --- üåÄ Start carousel ---
    if (images.length > 1) {
      let i = 0;
      setInterval(() => {
        i = (i + 1) % images.length;
        const img = document.getElementById(carouselId);
        if (img) img.src = images[i];
      }, 3000);
    }

    // --- Attach events ---
    const viewBtn = card.querySelector(".view-btn");
    viewBtn.dataset.order = JSON.stringify(order);
    viewBtn.addEventListener("click", () => {
      try {
        viewOrder(JSON.parse(viewBtn.dataset.order));
      } catch (e) {
        console.error("Failed to parse order data:", e);
      }
    });

    const downloadBtn = card.querySelector(".download-btn");
    if (downloadBtn) {
      downloadBtn.addEventListener("click", ev => {
        ev.stopPropagation();
        downloadReceipt(orderId);
      });
    }

    list.appendChild(card);
  });
}















function statusColor(status) {
  switch (status) {
    case "Pending Verification": return "#d97706"; // orange
    case "Ready for Pickup": return "#2563eb"; // blue
    case "Completed": return "#16a34a"; // green
    case "Cancelled": return "#dc2626"; // red
    default: return "#374151"; // gray
  }
}



// Show details for a single order
function viewOrderDetails(orderId) {
  console.log("viewOrderDetails called for:", orderId);

  // Find the order in the currently loaded list
  const order = window.currentOrders?.find(o => o["Order ID"] === orderId);
  if (!order) {
    alert("‚ùå Order not found.");
    return;
  }

  // Build detail HTML
  let html = `
    <h3>üÜî ${order["Order ID"]}</h3>
    <p><strong>Date:</strong> ${order["Date Ordered"]}</p>
    <p><strong>Status:</strong> ${order["Status"]}</p>
    <p><strong>Total:</strong> ‚Ç±${order["Total (‚Ç±)"]}</p>
    <p><strong>Delivery:</strong> ${order["Delivery Option"]} ${order["Delivery Time"] || ""}</p>
    <p><strong>Quantity:</strong> ${order["Quantity"]}</p>
    <p><strong>Unit Price:</strong> ‚Ç±${order["Unit Price (‚Ç±)"]}</p>
    <p><strong>Product ID:</strong> ${order["Product ID"]}</p>
    <p><strong>Seller ID:</strong> ${order["Seller ID"]}</p>
    <p><strong>Customer:</strong> ${order["Customer Name"]} (${order["Contact No."]})</p>
    <p><strong>Section:</strong> ${order["Section"]}</p>
  `;

  // Insert into modal
  document.getElementById("orderDetailsContent").innerHTML = html;
  document.getElementById("orderDetailsModal").style.display = "block";
}

// Close order details modal
function closeOrderDetails() {
  document.getElementById("orderDetailsModal").style.display = "none";
}

function viewOrder(order) {
  console.log("Opening order:", order);

  document.getElementById("orderModalId").textContent = order.OrderID || "N/A";
  document.getElementById("orderModalDate").textContent = order.Date || "N/A";
  document.getElementById("orderModalStatus").textContent = order.Status || "N/A";
  document.getElementById("orderModalTotal").textContent = order.Total || 0;

  document.getElementById("orderModalProduct").innerHTML = `
    <img src="${order.ProductImage || ""}" 
         alt="${order.ProductName || "Product"}" 
         style="max-width:80px; display:block; margin-bottom:8px;">
    ${order.ProductName || "Unknown Product"}
  `;

  // Show modal (remove Tailwind hidden + ensure display:block)
  const modal = document.getElementById("orderModal");
  modal.classList.remove("hidden");
  modal.style.display = "flex"; // ‚úÖ fallback for browsers without Tailwind
}

function closeOrderModal() {
  const modal = document.getElementById("orderModal");
  modal.classList.add("hidden");
  modal.style.display = "none";
}

function cancelOrder(orderId, productId) {
  if (!orderId || orderId === "N/A") {
    alert("Invalid order ID."); // keep this only for invalid cases
    return;
  }

  // Save IDs for use when user confirms
  cancelOrderId = orderId;
  cancelProductId = productId;

  // üîπ Show your Cancel Confirmation Modal instead of confirm()
  openCancelConfirm(orderId);
}

function changeQty(delta) {
  // update detailQty input if present
  const input = document.getElementById('detailQty');
  if (!input) return;
  let val = Number(input.value || 1) + delta;
  if (val < 1) val = 1;
  input.value = val;

  // Sync both selection objects (if exist)
  if (window.selectedBuyNow) {
    window.selectedBuyNow.quantity = val;
  }
  if (window.selectedBuyNowProduct) {
    window.selectedBuyNowProduct.quantity = val;
  }

  // Update subtotal/total UI
  let subtotal = 0;
  if (window.selectedBuyNow && window.selectedBuyNow.type === 'bundle') {
    subtotal = Number(window.selectedBuyNow.bundle.price || window.selectedBuyNowProduct.price || 0) * val;
    const totalEl = document.getElementById('buyNowTotal');
    document.getElementById('buyNowSubtotal').textContent = `‚Ç±${subtotal}`;
    if (totalEl) totalEl.textContent = `‚Ç±${subtotal}`; // delivery fee will adjust it later
    const qtyEl = document.getElementById('buyNowBundleQty');
    if (qtyEl) qtyEl.innerText = 'Qty: ' + val;
  } else if (window.selectedBuyNow && window.selectedBuyNow.type === 'product') {
    const unit = Number((window.selectedBuyNow.product && window.selectedBuyNow.product.price) || window.selectedBuyNowProduct.price || 0);
    subtotal = unit * val;
    document.getElementById('buyNowSubtotal').textContent = `‚Ç±${subtotal}`;
    document.getElementById('buyNowTotal').textContent = `‚Ç±${subtotal}`;
  } else if (window.selectedBuyNowProduct) {
    const unit = Number(window.selectedBuyNowProduct.price || 0);
    subtotal = unit * val;
    document.getElementById('buyNowSubtotal').textContent = `‚Ç±${subtotal}`;
    document.getElementById('buyNowTotal').textContent = `‚Ç±${subtotal}`;
  }
}



// ‚úÖ Picked Up Modals
function showPickedUpSuccessModal() {
  document.getElementById("pickedUpSuccessModal").style.display = "flex";
}
function closePickedUpSuccessModal() {
  document.getElementById("pickedUpSuccessModal").style.display = "none";
}

// ‚úÖ Pickup Confirm Modal
function openPickupConfirm(orderId) {
  selectedOrderId = orderId;
  document.getElementById("pickupConfirmModal").style.display = "flex";
}
function closePickupConfirm() {
  selectedOrderId = null;
  document.getElementById("pickupConfirmModal").style.display = "none";
}

// ‚úÖ Cancel Confirm Modal
function openCancelConfirm(orderId) {
  cancelOrderId = orderId;
  document.getElementById("cancelConfirmModal").style.display = "flex";
}
function closeCancelConfirm() {
  cancelOrderId = null;
  document.getElementById("cancelConfirmModal").style.display = "none";
}

// ‚úÖ Cancel Success Modal
function showCancelSuccessModal() {
  const modal = document.getElementById("cancelSuccessModal");
  if (modal) modal.style.display = "flex";
}
function closeCancelSuccessModal() {
  const modal = document.getElementById("cancelSuccessModal");
  if (modal) modal.style.display = "none";
}

// ===============================
// üîê LOGIN / SIGNUP SYSTEM
// ===============================

// Check if user is logged in
function isUserLoggedIn() {
  return !!localStorage.getItem('customerId');
}

// Save login info
function saveLogin(customerId) {
  localStorage.setItem('customerId', customerId);
  window.currentCustomer = { id: customerId };
}

function logout() {
  window.currentCustomer = null;

  // üîÑ Clear Telegram session values
  localStorage.removeItem("customerId");       // TelegramID
  localStorage.removeItem("uniqueCode");       // Session token
  localStorage.removeItem("customerName");     // Display name
  localStorage.removeItem("telegramUsername"); // Telegram @username

  console.log("üëã Logged out");

  // ‚úÖ Update UI
  if (typeof updateLoginStatusUI === "function") {
    updateLoginStatusUI(false);
  }

  // Optionally reopen modal or reload
  if (typeof openLoginSignupModal === "function") {
    openLoginSignupModal();
  } else {
    location.reload();
  }
}



// ‚úÖ LOGIN MODAL
function openLoginModal() {
  const modal = document.getElementById('loginModal');
  if (modal) {
    modal.classList.remove('hidden');
    modal.style.display = 'flex';
  }
}

function closeLoginModal() {
  const modal = document.getElementById('loginModal');
  if (modal) {
    modal.classList.add('hidden');
    modal.style.display = 'none';
  }
}




// ‚úÖ SIGNUP MODAL
function openSignup() {
  closeLoginModal();
  document.getElementById("signupModal").classList.remove("hidden");
  document.getElementById("signupModal").style.display = "flex";
}

function closeSignupModal() {
  document.getElementById("signupModal").classList.add("hidden");
  document.getElementById("signupModal").style.display = "none";
}

function backToLogin() {
  closeSignupModal();
  openLoginModal();
}

// ‚úÖ Add to Cart protection
function handleAddToCart(productId) {
  if (!isUserLoggedIn()) {
    openLoginModal(); // force login
    return;
  }

  const customerId = localStorage.getItem('customerId');
  // ‚ö° Your existing add to cart logic goes here
}

function handleSignup() {
  const contact = document.getElementById("signupContact").value.trim();
  const email = document.getElementById("signupEmail").value.trim();
  const grade = document.getElementById("signupGrade").value.trim();
  const section = document.getElementById("signupSection").value.trim();

  // üîë Ensure Telegram user is logged in first
  const telegramId = localStorage.getItem("customerId");
  const firstName = localStorage.getItem("customerName")?.split(" ")[0] || "";
  const lastName = localStorage.getItem("customerName")?.split(" ")[1] || "";
  const username = localStorage.getItem("telegramUsername") || "";
  const photoUrl = ""; // optional, Telegram widget already provided earlier

  if (!telegramId) {
    showMessageModal("‚ö†Ô∏è Please login with Telegram first.");
    return;
  }

  if (!contact || !email || !grade || !section) {
    showMessageModal("‚ö†Ô∏è Please fill out all required fields.");
    return;
  }

  google.script.run
    .withSuccessHandler(function(result) {
      if (result && result.customerId) {
        closeSignupModal();
        showMessageModal("‚úÖ Profile updated successfully.");
      } else {
        showMessageModal("‚ùå Profile update failed. Please try again.");
      }
    })
    .withFailureHandler(function(err){
      console.error("Signup error:", err);
      showMessageModal("‚ùå An error occurred. Please try again.");
    })
    .signupCustomer(
      telegramId,
      firstName,
      lastName,
      username,
      photoUrl,
      contact,
      email,
      grade,
      section
    );
}




// It will be triggered by Telegram Login Widget callback.
function handleLogin(user) {
  if (!user || !user.id) {
    showMessageModal("‚ö†Ô∏è Telegram login failed. No user data received.");
    return;
  }

  // üîë Call server to log in or create Telegram user
  google.script.run
    .withSuccessHandler(function(result) {
      if (result && result.customerId && result.uniqueCode) {
        // ‚úÖ Save session values
        localStorage.setItem("customerId", result.customerId);
        localStorage.setItem("uniqueCode", result.uniqueCode);

        // Save Telegram profile locally
        localStorage.setItem("telegramUsername", user.username || "");
        localStorage.setItem("telegramPhoto", user.photo_url || "");
        localStorage.setItem(
          "customerName",
          (user.first_name || "") + " " + (user.last_name || "")
        );

        // üÜï Fetch full Telegram user info from sheet
        google.script.run
          .withSuccessHandler(function(customerObj) {
            if (customerObj) {
              const realName =
                customerObj.FullName ||
                customerObj.FirstName ||
                customerObj.Name ||
                "";
              if (realName) {
                localStorage.setItem("customerName", realName);
              }
            }

            // ‚úÖ Instantly refresh header UI (Welcome + Logout button)
            if (typeof updateLoginStatusUI === "function")
              updateLoginStatusUI(true);
            if (typeof renderAuthControls === "function")
              renderAuthControls();

            console.log(
              "üë§ Logged in as:",
              localStorage.getItem("customerName") ||
                user.username ||
                user.id
            );
          })
          .getCustomerInfo(result.customerId);

        showMessageModal("‚úÖ Logged in successfully");
        if (typeof closeLoginModal === "function") closeLoginModal();
      } else {
        showMessageModal("‚ùå Telegram login failed.");
      }
    })
    .withFailureHandler(function(err) {
      console.error("Login error:", err);
      showMessageModal("‚ùå Login error, please try again.");
    })
    .loginCustomer(
      user.id,
      user.first_name,
      user.last_name,
      user.username,
      user.photo_url
    );
}








function showMessageModal(text) {
  const modal = document.getElementById("messageModal");
  const msg = document.getElementById("messageModalText");
  msg.textContent = text;
  modal.classList.remove("hidden");
  modal.style.display = "flex";
}

function closeMessageModal() {
  const modal = document.getElementById("messageModal");
  modal.classList.add("hidden");
  modal.style.display = "none";
}

function onLoginSuccess(customerObj) {
  // ‚úÖ Save to memory
  window.currentCustomer = {
    id: customerObj.CustomerID || customerObj.customerId,
    uniqueCode: customerObj.UniqueCode || customerObj.uniqueCode,
    name: customerObj.Name || customerObj.name
  };

  // ‚úÖ Save to localStorage for persistence
  localStorage.setItem("customerId", window.currentCustomer.id);
  localStorage.setItem("uniqueCode", window.currentCustomer.uniqueCode);

  console.log("‚úÖ Logged in as", window.currentCustomer.name, "(", window.currentCustomer.id, ")");

  // ‚úÖ Update UI
  updateLoginStatusUI(true);

  // ‚úÖ Hide login modal if present
  if (typeof closeLoginModal === "function") {
    closeLoginModal();
  }
}


// üîë Restore session on page load
function initCustomerSession() {
  const savedId = localStorage.getItem("customerId");
  const savedCode = localStorage.getItem("uniqueCode");

  if (savedId && savedCode) {
    console.log("üîë Found saved login:", savedId, savedCode);

    google.script.run
      .withSuccessHandler(valid => {
        if (valid) {
          console.log("‚úÖ Session restored for", savedId);
          window.currentCustomer = { id: savedId, uniqueCode: savedCode };
          updateLoginStatusUI(true);
        } else {
          console.log("‚ö†Ô∏è Saved session invalid, forcing login");
          localStorage.removeItem("customerId");
          localStorage.removeItem("uniqueCode");
          updateLoginStatusUI(false);
        }
      })
      .checkCustomerLogin(savedId, savedCode); // uses your backend check
  } else {
    console.log("‚ÑπÔ∏è No saved login");
    updateLoginStatusUI(false);
  }
}

// ‚úÖ Logout
function logoutCustomer() {
  localStorage.removeItem("customerId");
  localStorage.removeItem("uniqueCode");
  window.currentCustomer = null;
  updateLoginStatusUI(false);
}

// ‚úÖ Update login status in UI
function updateLoginStatusUI(isLoggedIn) {
  const statusEl = document.getElementById("loginStatus");
  if (!statusEl) return;

  if (isLoggedIn && window.currentCustomer) {
    statusEl.textContent = "Online (" + window.currentCustomer.id + ")";
  } else {
    statusEl.textContent = "Offline";
  }
}


function downloadReceipt(orderId) {
  if (!orderId) { alert("Order ID missing"); return; }

  // show spinner
  document.getElementById('receipt-spinner').style.display = 'flex';

  google.script.run
    .withSuccessHandler(function(order) {
      if (!order) {
        document.getElementById('receipt-spinner').style.display = 'none';
        alert("Order not found.");
        return;
      }
      try {
        fillReceiptTemplate(order);
        captureAndDownload(orderId);
      } catch (e) {
        console.error("Receipt error:", e);
        document.getElementById('receipt-spinner').style.display = 'none';
        alert("Failed to prepare receipt. See console.");
      }
    })
    .withFailureHandler(function(err) {
      document.getElementById('receipt-spinner').style.display = 'none';
      console.error("getOrderForReceipt failed:", err);
      alert("Server error fetching order.");
    })
    .getOrderForReceipt(orderId, true); // includeImageData = true
}

/** Fill the hidden receipt DOM with server-returned order object */
function fillReceiptTemplate(order) {
  // Basic fields: use whichever names your server returns
  document.getElementById('r-orderId').textContent = order.OrderID || order.OrderId || "";
  document.getElementById('r-date').textContent = order.FormattedDate || order.Date || "";
  document.getElementById('r-product').textContent = (order.ProductName || order.ProductID || "");
  const qty = order.Quantity || order.Quantity === 0 ? order.Quantity : 1;
  const unit = order.UnitPrice || order.UnitPrice === 0 ? Number(order.UnitPrice).toFixed(2) : "";
  document.getElementById('r-qty-price').textContent = `Qty: ${qty}${unit ? " ¬∑ ‚Ç±" + unit : ""}`;
  document.getElementById('r-total').textContent = (order.Total || order.Total === 0) ? Number(order.Total).toFixed(2) : "";

  document.getElementById('r-customer').textContent = order.CustomerName || order.Customer || "";
  document.getElementById('r-contact').textContent = order.ContactNo || order.Contact || "";

  // set image: prefer ProductImageData (base64) to avoid CORS; else try plain URL
  const img = document.getElementById('r-image');
  if (order.ProductImageData) {
    img.src = order.ProductImageData;
  } else if (order.ProductImage) {
    img.crossOrigin = 'anonymous';
    img.src = String(order.ProductImage).split(',')[0].trim();
  } else {
    img.src = ''; // hide if empty
  }
}

/** Ensure image loaded then capture & download */
function captureAndDownload(orderId) {
  const wrapper = document.getElementById('receipt-capture-wrapper');
  const receiptEl = document.getElementById('receipt-template');
  const img = document.getElementById('r-image');

  // Make sure the wrapper is rendered by placing it off-screen (already by CSS), and visible to layout
  wrapper.style.left = '-9999px';
  wrapper.style.top = '-9999px';
  wrapper.style.display = 'block';

  // Wait for image to load (if any)
  waitForImage(img, 3000).then(() => {
    // Capture with html2canvas. Use useCORS:true but base64 prevents CORS anyway.
    html2canvas(receiptEl, {useCORS:true, scale: 2, logging:false}).then(canvas => {
      try {
        const dataUrl = canvas.toDataURL('image/png');
        // Trigger download
        const link = document.createElement('a');
        link.href = dataUrl;
        link.download = `Receipt_${orderId}.png`;
        document.body.appendChild(link);
        link.click();
        link.remove();
      } catch (e) {
        console.error("Download error:", e);
        alert("Failed to generate receipt image.");
      } finally {
        // cleanup
        document.getElementById('receipt-spinner').style.display = 'none';
        wrapper.style.display = 'none';
        document.getElementById('r-image').src = '';
      }
    }).catch(err => {
      console.error("html2canvas failed:", err);
      document.getElementById('receipt-spinner').style.display = 'none';
      wrapper.style.display = 'none';
      alert("Failed to capture receipt.");
    });
  }).catch(() => {
    // image did not load in time ‚Äî still try capturing
    console.warn("Image load timed out, capturing anyway.");
    html2canvas(receiptEl, {useCORS:true, scale:2, logging:false}).then(canvas => {
      const dataUrl = canvas.toDataURL('image/png');
      const link = document.createElement('a');
      link.href = dataUrl;
      link.download = `Receipt_${orderId}.png`;
      document.body.appendChild(link);
      link.click();
      link.remove();

      document.getElementById('receipt-spinner').style.display = 'none';
      wrapper.style.display = 'none';
      document.getElementById('r-image').src = '';
    }).catch(err => {
      console.error("html2canvas failed after img timeout:", err);
      document.getElementById('receipt-spinner').style.display = 'none';
      wrapper.style.display = 'none';
      alert("Failed to capture receipt.");
    });
  });
}

/** Promise that resolves when <img> is loaded or rejects after timeout */
function waitForImage(img, timeoutMs) {
  timeoutMs = timeoutMs || 3000;
  return new Promise((resolve, reject) => {
    if (!img || !img.src) return resolve(); // nothing to wait for
    if (img.complete && img.naturalWidth !== 0) return resolve();

    let done = false;
    const onFinish = () => { if (!done) { done = true; cleanup(); resolve(); } };
    const onFail = () => { if (!done) { done = true; cleanup(); resolve(); } }; // resolve even on error; we still try to capture

    const cleanup = () => {
      img.removeEventListener('load', onFinish);
      img.removeEventListener('error', onFail);
      clearTimeout(timer);
    };

    img.addEventListener('load', onFinish);
    img.addEventListener('error', onFail);

    const timer = setTimeout(() => {
      if (!done) { done = true; cleanup(); reject(); }
    }, timeoutMs);
  });
}

function openBuyNowModal(product) {
  if (!ensureLoggedIn()) return;

  const qty = 1;

  window.selectedBuyNow = { type: product.type || 'product', product: product, quantity: qty };
  window.selectedBuyNowProduct = {
    id: product.id || product.ProductID || '',
    name: product.name || product['Product Name'] || product['Bundle Name'] || '',
    price: Number(product.price || product['Price (‚Ç±)'] || 0),
    image: product.image || product['Image URL'] || '',
    quantity: qty,
    sellerId: product.sellerId || product['Seller ID'] || ''
  };

  // ‚úÖ Build contents (support bundle.items OR product.contents)
  let contentsHtml = "";
  const list = product.items || product.contents;
  if (Array.isArray(list)) {
    contentsHtml = list
      .map(c => `${c.name || c.item} √ó ${c.qty}`)
      .join("<br>");
  }

  // Render inside modal
  const productContainer = document.getElementById("buyNowProductItem");
  if (productContainer) {
    productContainer.innerHTML = `
      <div style="font-weight:600; margin-bottom:6px;">${window.selectedBuyNowProduct.name}</div>
      <div>‚Ç±${window.selectedBuyNowProduct.price}</div>
      <div>Qty: ${window.selectedBuyNowProduct.quantity}</div>
      ${contentsHtml ? `<div style="margin-top:8px; font-size:14px;"><strong>Contents:</strong><br>${contentsHtml}</div>` : ""}
    `;
  }

  // Subtotals
  document.getElementById("buyNowSubtotal").textContent = `‚Ç±${window.selectedBuyNowProduct.price}`;
  document.getElementById("buyNowDeliveryFee").textContent = "‚Ç±0.00";
  document.getElementById("buyNowTotal").textContent = `‚Ç±${window.selectedBuyNowProduct.price}`;

  // ‚úÖ Reload delivery times
  const timeSelect = document.getElementById("buyNowDeliveryTime");
  if (timeSelect) {
    timeSelect.innerHTML = `<option value="">Select delivery option first</option>`;
    google.script.run.withSuccessHandler(function(times) {
      (times || []).forEach(t => {
        const optId = t?.id || t?.['Option ID'] || "";
        const optLabel = t?.label || t?.['Time Slot'] || "";
        const available = (t?.Available ?? t?.available) ?? null;

        const include =
          (optId && optLabel && available == null) || // server format {id,label}
          (String(available).toLowerCase() === "yes"); // sheet format

        if (include) {
          timeSelect.innerHTML += `<option value="${optId}">${optLabel}</option>`;
        }
      });

      if (timeSelect.options.length === 1) {
        timeSelect.innerHTML = `<option value="">No delivery slots available</option>`;
      }
    }).getAvailableDeliveryTimes();
  }

  // ‚úÖ Hook delivery option radios
  const pickupRadio = document.querySelector("input[name='buyNowDeliveryOption'][value='Pickup']");
  const deliveryRadio = document.querySelector("input[name='buyNowDeliveryOption'][value='Delivery']");
  const deliveryFields = document.getElementById("buyNowDeliveryFields");

  function recalcTotal() {
    const subtotal = window.selectedBuyNowProduct.price;
    let fee = 0;

    if (deliveryRadio && deliveryRadio.checked) {
      fee = 5; // flat fee
      if (timeSelect) timeSelect.disabled = false;
      if (deliveryFields) deliveryFields.style.display = "block";
    } else {
      if (timeSelect) {
        timeSelect.disabled = true;
        timeSelect.value = "";
      }
      if (deliveryFields) deliveryFields.style.display = "none";
    }

    document.getElementById("buyNowDeliveryFee").textContent = `‚Ç±${fee.toFixed(2)}`;
    document.getElementById("buyNowTotal").textContent = `‚Ç±${(subtotal + fee).toFixed(2)}`;
  }

  if (pickupRadio) pickupRadio.onchange = recalcTotal;
  if (deliveryRadio) deliveryRadio.onchange = recalcTotal;

  // Default: pickup
  recalcTotal();

  // ‚úÖ Show modal
  const modal = document.getElementById("buyNowModal");
  if (modal) {
    modal.classList.remove("hidden");
    modal.classList.add("flex");
    modal.style.display = "";
  }
}

// --- Close Buy Now Modal ---
function closeBuyNowModal() {
  const modal = document.getElementById("buyNowModal");
  if (modal) {
    modal.classList.add("hidden");
    modal.classList.remove("flex");
    modal.style.display = ""; // reset inline style
  }
}



function submitBuyNow() {
  const name = document.getElementById("buyNowName").value.trim();
  const contact = document.getElementById("buyNowContact").value.trim();
  const grade = document.getElementById("buyNowGrade").value;
  const section = document.getElementById("buyNowSection").value.trim();
  const deliveryOption =
    document.querySelector("input[name='buyNowDeliveryOption']:checked")?.value || "Pickup";
  const deliveryTime =
    deliveryOption === "Delivery"
      ? (document.getElementById("buyNowDeliveryTime")?.value || "")
      : ""; // ‚úÖ only if Delivery

  if (!name || !contact || !grade || !section) {
    alert("‚ö†Ô∏è Please fill out all customer details.");
    return;
  }

  // --- Accept both flows: product or bundle ---
  const selection = window.selectedBuyNow || null;
  let product = window.selectedBuyNowProduct || null;

  if (!product && selection && selection.type === "bundle") {
    const bundle = selection.bundle || {};
    product = {
      id: bundle.id || bundle["Bundle ID"] || "",
      name: bundle.name || bundle["Bundle Name"] || "",
      price: Number(bundle.price || 0),
      quantity: Number(selection.quantity || 1),
      items: (bundle.items || []).map(it => ({
        ...it,
        // ‚úÖ guarantee sellerId on each item
        sellerId: it.sellerId || bundle.sellerId || ""
      })),
      // ‚úÖ ensure bundle-level sellerId comes through
      sellerId: bundle.sellerId || ""
    };
  } else if (!product && selection && selection.type === "product") {
    const p = selection.product || {};
    product = {
      id: p.id || selection.productId || "",
      name: p.name || "",
      price: Number(p.price || 0),
      image: p.image || "",
      quantity: Number(selection.quantity || 1),
      sellerId: p.sellerId || selection.sellerId || ""
    };
  }

  if (!product) {
    alert("‚ùå No product selected for Buy Now.");
    return;
  }

  if (
    deliveryOption === "Delivery" &&
    (!deliveryTime || deliveryTime === "Loading..." || deliveryTime === "No slots available")
  ) {
    alert("‚ö†Ô∏è Please select a valid delivery time.");
    return;
  }

  const customerId =
    window.currentCustomer?.id || localStorage.getItem("customerId") || "";
  const uniqueCode =
    window.currentCustomer?.uniqueCode || localStorage.getItem("uniqueCode") || "";
  const deviceId = localStorage.getItem("deviceId") || "";

  const qty = Number(product.quantity || (selection && selection.quantity) || 1);
  const unitPrice = Number(product.price || 0);
  const subtotal = unitPrice * qty;
  const deliveryFee = deliveryOption === "Delivery" ? 5 : 0;
  const total = subtotal + deliveryFee;

  // --- Build payload ---
  const orderData = {
    type: selection?.type || "product",
    product: selection?.type === "product" ? {
      id: product.id,
      name: product.name,
      price: unitPrice,
      image: product.image || "",
      quantity: qty,
      sellerId: product.sellerId || ""
    } : null,

    // ‚úÖ flat identifiers always included
    productId: selection?.type === "product" ? (product.id || "") : "",
    bundleId: selection?.type === "bundle" ? product.id : "",
    bundleName: selection?.type === "bundle" ? product.name : "",
    items: selection?.type === "bundle" ? (product.items || []) : [],

    unitPrice,
    quantity: qty,
    subtotal,
    deliveryFee,
    total,

    customerId,
    // ‚úÖ sellerId always attached (works for both product & bundle)
    sellerId: product.sellerId || "",
    customer: { name, contact, grade, section, id: customerId, uniqueCode },
    deviceId,
    section,
    deliveryOption,
    deliveryTime,
    date: new Date().toISOString()
  };

  console.log("üõí Submitting Buy Now order:", orderData);

  // --- Loading UI ---
  const loadingModal = document.getElementById("checkoutLoadingModal");
  if (loadingModal) loadingModal.style.display = "flex";

  google.script.run
    .withSuccessHandler(res => {
      if (loadingModal) loadingModal.style.display = "none";
      const buyNowModal = document.getElementById("buyNowModal");
      if (buyNowModal) buyNowModal.style.display = "none";

      if (res && res.success) {
        const successModal = document.getElementById("checkoutSuccessModal");
        if (successModal) {
          document.getElementById("checkoutSuccessMessage").innerText =
            `‚úÖ Buy Now order placed!\nüÜî Order ID: ${res.orderId}\nüì¶ Status: ${res.status || "Pending"}\nüõí Qty: ${qty}\nüí∞ Total: ‚Ç±${total}`;
          successModal.style.display = "flex";
          setTimeout(() => (successModal.style.display = "none"), 3000);
        } else {
          alert(`‚úÖ Buy Now order placed!\nOrder ID: ${res.orderId}\nQty: ${qty}\nTotal: ‚Ç±${total}`);
        }
      } else {
        alert("‚ö†Ô∏è Something went wrong saving your order.");
      }
    })
    .withFailureHandler(err => {
      console.error("‚ùå Buy Now order failed:", err);
      if (loadingModal) loadingModal.style.display = "none";
      alert("‚ùå Failed to place order. Please try again.");
    })
    .buyNowOrder(orderData);
}




















// --- Open Bundle Details Modal ---
function openBundleDetails(bundle) {
  const container = document.getElementById("bundleDetailsList");
  const modal = document.getElementById("bundleDetailsModal");
  container.innerHTML = "";

  if (!bundle || !bundle.items || bundle.items.length === 0) {
    container.innerHTML = "<p class='text-gray-500 text-center py-4'>No items found in this bundle.</p>";
    showModal(modal);
    document.body.style.overflow = "hidden"; // üîí lock scroll
    return;
  }

  const frag = document.createDocumentFragment();

  // --- Header ---
  const header = document.createElement("div");
  header.className = "mb-6 text-center";
  header.innerHTML = `
    <h2 class="text-2xl font-bold text-gray-800">${bundle.name}</h2>
    <p class="text-lg text-orange-600 font-semibold">‚Ç±${bundle.price}</p>
    <p class="text-sm text-gray-500">${bundle.items.length} items included</p>
  `;
  frag.appendChild(header);

  let preloadUrls = [];

  // --- Items ---
  bundle.items.forEach((item, idx) => {
    const images = Array.isArray(item.images) ? item.images : [item.image || "https://via.placeholder.com/200"];
    preloadUrls.push(...images);

    const card = document.createElement("div");
    card.className = "bg-white border border-gray-200 rounded-xl shadow-md overflow-hidden hover:shadow-lg transition mb-6";

    // Carousel
    const carousel = document.createElement("div");
    carousel.className = "relative h-52 overflow-hidden rounded-xl group";
    images.forEach((img, i) => {
      const el = document.createElement("img");
      el.src = img;
      el.alt = item.name;
      el.className = `absolute inset-0 w-full h-full object-cover transition-opacity duration-700 ${i === 0 ? "opacity-100" : "opacity-0"}`;
      el.dataset.carousel = idx;
      carousel.appendChild(el);
    });
    card.appendChild(carousel);

    // Info
    const info = document.createElement("div");
    info.className = "p-4";
    info.innerHTML = `
      <div class="text-lg font-bold text-gray-800">${item.name}</div>
      <div class="text-sm text-gray-600">Qty: ${item.qty}</div>
    `;
    card.appendChild(info);

    frag.appendChild(card);
  });

  // --- Buy Now Button ---
  const btnWrap = document.createElement("div");
  btnWrap.className = "mt-6 flex justify-center";
  btnWrap.innerHTML = `
    <button id="bundleBuyNowBtn"
      class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-lg transition">
      ‚ö° Buy Now
    </button>
  `;
  frag.appendChild(btnWrap);

  container.appendChild(frag);

  // --- Preload images, then show modal ---
  preloadImages(preloadUrls, () => {
    showModal(modal);
    document.body.style.overflow = "hidden"; // üîí lock scroll

    // Activate carousels
    bundle.items.forEach((_, idx) => {
      const images = container.querySelectorAll(`[data-carousel="${idx}"]`);
      if (images.length > 1) {
        let active = 0;
        setInterval(() => {
          images[active].classList.replace("opacity-100", "opacity-0");
          active = (active + 1) % images.length;
          images[active].classList.replace("opacity-0", "opacity-100");
        }, 3000);
      }
    });

    // --- Buy Now button event ---
    document.getElementById("bundleBuyNowBtn").addEventListener("click", () => {
      if (!ensureLoggedIn()) return; // ‚úÖ stop if not logged in
      closeBundleDetails();          // close details modal first
      openBundleBuyNow(bundle);      // open Buy Now with bundle
    });
  });
}


// --- Close Bundle Details Modal ---
function closeBundleDetails() {
  const modal = document.getElementById("bundleDetailsModal");
  if (modal) {
    modal.style.display = "none";
    document.body.style.overflow = ""; // üîì restore scroll
  }
}



// Preload helper
function preloadImages(urls, callback) {
  let loaded = 0;
  if (urls.length === 0) return callback();

  urls.forEach(url => {
    const img = new Image();
    img.onload = img.onerror = () => {
      loaded++;
      if (loaded === urls.length) callback();
    };
    img.src = url;
  });
}

// Smooth modal show without flash
function showModal(modal) {
  document.body.style.overflow = "hidden"; // lock background scroll
  modal.classList.add("show");             // fade in via CSS
}




function openBundleBuyNow(bundle) {
  if (!bundle) return;

  const qty = 1;
  window.selectedBuyNow = { type: 'bundle', bundle: bundle, quantity: qty };

  const normalizedItems = (bundle.items || []).map(it => ({
    productId: it.productId || it.id || it.ProductID || it.pid || '',
    name: it.name || it.productName || it.ProductName || '',
    qty: Number(it.qty || it.quantity || it.Qty || it.Quantity || 1),
    image: (it.images && it.images[0]) || it.image || ''
  }));

  const firstImage = normalizedItems[0]?.image || bundle.image || '';

  window.selectedBuyNowProduct = {
    id: bundle.id || bundle['Bundle ID'] || '',
    name: bundle.name || bundle['Bundle Name'] || '',
    price: Number(bundle.price || bundle['Bundle Price (‚Ç±)'] || 0),
    image: firstImage,
    quantity: qty,
    items: normalizedItems,
    sellerId: bundle.sellerId || bundle['Seller ID'] || ''
  };

  // --- Render bundle preview ---
  const container = document.getElementById('buyNowProductItem');
  if (container) {
    const contentsHtml = (window.selectedBuyNowProduct.items || [])
      .map(it => `<li>${(it.name || it.productId || it.id || 'Item')} √ó ${it.qty}</li>`)
      .join('');

    container.innerHTML = `
      <div>
        <div style="font-weight:600">${window.selectedBuyNowProduct.name}</div>
        <div>‚Ç±${window.selectedBuyNowProduct.price}</div>
        <div id="buyNowBundleQty">Qty: ${window.selectedBuyNowProduct.quantity}</div>
        <div style="margin-top:8px; font-size:13px;">
          <strong>Contents:</strong>
          <ul>${contentsHtml}</ul>
        </div>
      </div>
    `;
  }

  // Reset totals
  document.getElementById('buyNowSubtotal').textContent = `‚Ç±${window.selectedBuyNowProduct.price}`;
  document.getElementById('buyNowDeliveryFee').textContent = '‚Ç±0.00';
  document.getElementById('buyNowTotal').textContent = `‚Ç±${window.selectedBuyNowProduct.price}`;

  // ‚úÖ Reload delivery times
  const timeSelect = document.getElementById("buyNowDeliveryTime");
  if (timeSelect) {
    timeSelect.innerHTML = `<option value="">Select Time</option>`;
    google.script.run.withSuccessHandler(function(times) {
      (times || []).forEach(t => {
        const optId = t?.id || t?.['Option ID'] || "";
        const optLabel = t?.label || t?.['Time Slot'] || "";
        const available = (t?.Available ?? t?.available) ?? null;

        const include =
          (optId && optLabel && available == null) || // server format {id,label}
          (String(available).toLowerCase() === "yes"); // sheet format

        if (include) {
          timeSelect.innerHTML += `<option value="${optId}">${optLabel}</option>`;
        }
      });

      if (timeSelect.options.length === 1) {
        timeSelect.innerHTML = `<option value="">No delivery slots available</option>`;
      }
    }).getAvailableDeliveryTimes();
  }

  // ‚úÖ Hook delivery option radios
  const pickupRadio = document.querySelector("input[name='buyNowDeliveryOption'][value='Pickup']");
  const deliveryRadio = document.querySelector("input[name='buyNowDeliveryOption'][value='Delivery']");
  const deliveryFields = document.getElementById("buyNowDeliveryFields");

  function recalcTotal() {
    const subtotal = window.selectedBuyNowProduct.price;
    let fee = 0;

    if (deliveryRadio && deliveryRadio.checked) {
      fee = 5; // flat fee
      if (timeSelect) timeSelect.disabled = false;
      if (deliveryFields) deliveryFields.style.display = "block";
    } else {
      if (timeSelect) {
        timeSelect.disabled = true;
        timeSelect.value = "";
      }
      if (deliveryFields) deliveryFields.style.display = "none";
    }

    document.getElementById('buyNowDeliveryFee').textContent = `‚Ç±${fee.toFixed(2)}`;
    document.getElementById('buyNowTotal').textContent = `‚Ç±${(subtotal + fee).toFixed(2)}`;
  }

  if (pickupRadio) pickupRadio.onchange = recalcTotal;
  if (deliveryRadio) deliveryRadio.onchange = recalcTotal;

  // Default: pickup
  recalcTotal();

  // Show Buy Now modal
  hideModal(document.getElementById("bundleDetailsModal"));
  showModal(document.getElementById('buyNowModal'));
  document.body.style.overflow = "hidden"; // lock scroll
}

// ‚úÖ Add close handler to restore scroll
function closeBuyNowModal() {
  const modal = document.getElementById("buyNowModal");
  if (modal) {
    modal.classList.add("hidden");
    modal.classList.remove("flex");
    modal.style.display = "";
  }
  document.body.style.overflow = ""; // restore scrolling
}



// ---------- Bundle normalizer (call before using bundles elsewhere) ----------
// ---------- safe normalizeBundle (idempotent, handles booleans) ----------
function normalizeBundle(raw) {
  if (!raw) return null;

  // if already normalized, return as-is (simple marker test)
  if (raw._normalized) return raw;

  const id = raw.id || raw['Bundle ID'] || raw.BundleID || raw['Bundle_Id'] || '';
  const name = raw.name || raw['Bundle Name'] || raw.BundleName || raw.Title || '';
  const price = Number(raw.price || raw['Bundle Price (‚Ç±)'] || raw['Bundle Price'] || 0);

  // handle booleans and strings safely
  let active;
  if (typeof raw.active === 'boolean') {
    active = raw.active;
  } else if (typeof raw.Active === 'boolean') {
    active = raw.Active;
  } else {
    active = String(raw.active || raw.Active || raw['Active'] || 'YES').toUpperCase() === 'YES';
  }

  // normalize items (support CSV or array)
  let items = raw.items || raw.Items || raw['Items'] || raw['ItemsList'] || [];
  if (typeof items === 'string') {
    items = items.trim() ? items.split(',').map(s => {
      const [pid, qty] = s.split(':');
      return { productId: (pid||'').trim(), qty: Number(qty || 1) };
    }) : [];
  } else if (!Array.isArray(items)) {
    items = [];
  } else {
    items = items.map(it => {
      if (typeof it === 'string') {
        const [pid, qty] = it.split(':');
        return { productId: (pid||'').trim(), qty: Number(qty || 1) };
      }
      return {
        productId: it.productId || it.ProductID || it.id || it.product || '',
        qty: Number(it.qty || it.quantity || 1),
        name: it.name || it.Name || ''
      };
    });
  }

  // enrich items with product metadata if available
  items = items.map(it => {
    const prod = (window.products || []).find(p => String(p.id) === String(it.productId) || String(p.ProductID) === String(it.productId));
    return {
      productId: it.productId,
      qty: Number(it.qty || 1),
      name: prod ? (prod.name || prod['Product Name'] || '') : (it.name || ''),
      image: prod ? (prod.image || prod.ImageURL || '') : (it.image || ''),
      images: prod ? (prod.images || []) : (it.images || [])
    };
  });

  const normalized = { id, name, price, active, items, raw };
  normalized._normalized = true; // marker to avoid double-normalizing
  return normalized;
}

function setModalVisible(modal, visible) {
  if (!modal) return;
  if (visible) {
    // Ensure inline style + classes are consistent so nothing blocks visibility
    modal.style.display = "flex";
    modal.classList.remove("hidden");
    modal.classList.add("flex", "show");
    document.body.style.overflow = "hidden";
  } else {
    modal.style.display = "";               // clear inline override
    modal.classList.remove("flex", "show");
    modal.classList.add("hidden");
    document.body.style.overflow = "";
  }
}

function showModal(modal) {
  setModalVisible(modal, true);
}

function hideModal(modal) {
  setModalVisible(modal, false);
}

window.addEventListener("load", () => {
    setTimeout(() => {
      const splash = document.getElementById("splash");
      if (splash) {
        splash.style.opacity = "0";
        splash.style.transition = "opacity 0.5s ease";
        setTimeout(() => splash.style.display = "none", 500);
      }
    }, 1000); // show for 1 second
  });

  // put this near top where helpers live (replace any previous version)
function createProductCardHTML(p) {
  p = p || {};

  // normalise flag names (handles different key variants)
  const onSale     = String(p.onSale || p.OnSale || p['On Sale'] || '').toUpperCase() === 'YES';
  const newArrival = String(p.newArrival || p.NewArrival || p['New Arrival'] || '').toUpperCase() === 'YES';
  const bestSeller = String(p.bestSeller || p.BestSeller || p['Best Seller'] || '').toUpperCase() === 'YES';
  const featured   = String(p.featured || p.Featured || p['Featured'] || '').toUpperCase() === 'YES';

  const salePriceRaw = p.salePrice || p['Sale Price (‚Ç±)'] || p['Sale Price'] || 0;
  const salePrice = Number(salePriceRaw) || 0;

  const badges = [];
  if (onSale) badges.push('<div class="badge badge-sale">SALE</div>');
  if (newArrival) badges.push('<div class="badge badge-new">NEW</div>');
  if (bestSeller) badges.push('<div class="badge badge-hot">HOT</div>');
  if (featured) badges.push('<div class="badge badge-featured">FEATURED</div>');
  const badgeHtml = badges.length ? `<div class="badges-wrapper">${badges.join('')}</div>` : '';

  // Images (support comma-separated image URLs)
  let images = (p.image || p.Image || p['Image URL'] || '').toString().split(',').map(s=>s.trim()).filter(Boolean);
  if (!images.length) images = ['https://via.placeholder.com/300'];

  let imageHtml = `<div class="product-img-wrapper" style="position:relative; height:140px;">`;
  images.forEach((url, idx) => {
    imageHtml += `<img src="${url}" alt="${(p.name||'')}" data-carousel
       style="position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover;
              transition:opacity 0.5s; ${idx===0 ? 'opacity:1;' : 'opacity:0;'}">`;
  });
  imageHtml += `${badgeHtml}</div>`;

  // price formatting: show crossed price + sale price if salePrice > 0
  let priceHtml = '';
  if (salePrice > 0) {
    priceHtml = `<div class="price"><span class="line-through" style="opacity:.6;margin-right:6px;">‚Ç±${Number(p.price||0)}</span><span class="sale-price" style="color:#e11d48;font-weight:700;">‚Ç±${salePrice}</span></div>`;
  } else {
    priceHtml = `<div class="price">‚Ç±${Number(p.price||0)}</div>`;
  }

  const infoHtml = `<div class="product-info"><div class="product-name">${(p.name||'')}</div>${priceHtml}</div>`;

  return imageHtml + infoHtml;
}

// Progressive blur-up loading for smoother experience
  window.addEventListener("load", () => {
    const banner = document.querySelector("#bannerContainer .banner");
    if (banner) {
      const highRes = banner.src; // same source for now (you can swap to WebP if available)
      const img = new Image();
      img.src = highRes;
      img.onload = () => {
        banner.src = highRes;
        banner.style.filter = "blur(0)";
      };
    }
  });

    // Prevent pinch zoom (gesture events)
    document.addEventListener('gesturestart', function (e) {
      e.preventDefault();
    });

    document.addEventListener('gesturechange', function (e) {
      e.preventDefault();
    });

    document.addEventListener('gestureend', function (e) {
      e.preventDefault();
    });

    // Prevent zoom on Ctrl + scroll (desktop fallback)
    document.addEventListener('wheel', function (e) {
      if (e.ctrlKey) e.preventDefault();
    }, { passive: false });



  function openSectionProductsModal(sectionId, title) {
  const modal = document.getElementById("sectionProductsModal");
  const listContainer = document.getElementById("sectionProductsList");
  const sectionTitle = document.getElementById("sectionProductsTitle");

  sectionTitle.innerText = title;
  listContainer.innerHTML = "";

  let products = [];
  if (sectionId === "onSaleWrapper") products = window.onSaleProducts || [];
  else if (sectionId === "newArrivalsWrapper") products = window.newArrivalProducts || [];
  else if (sectionId === "featuredWrapper") products = window.featuredProducts || [];
  else if (sectionId === "bundlesWrapper") products = window.bundleProducts || [];

  if (products.length === 0) {
    listContainer.innerHTML = "<p style='padding:14px;'>No products available.</p>";
  } else {
    products.forEach(p => {
      const card = document.createElement("div");
      card.className = "product-card";
      card.innerHTML = createProductCardHTML(p);

      // ‚úÖ If it's a bundle, show bundle details instead of product modal
      card.onclick = () => {
        closeSectionProductsModal();
        setTimeout(() => {
          if (sectionId === "bundlesWrapper") {
            openBundleDetails(p);   // <-- show bundle contents
          } else {
            openProductDetailModal(p); // <-- show product description
          }
        }, 200);
      };

      listContainer.appendChild(card);
    });
  }

  modal.style.display = "block";
}



function closeSectionProductsModal() {
  document.getElementById("sectionProductsModal").style.display = "none";
}



// ‚úÖ Delegated click handler for all product cards (main + modal)
document.addEventListener("click", function(e) {
  const card = e.target.closest(".product-card");
  if (card) {
    const pid = card.getAttribute("data-id");
    if (pid) {
      viewProduct(pid); // Opens your Product Detail Modal
    }
  }
});

// ‚úÖ Main search handler
function handleProductSearch(event) {
  let query = "";

  // If triggered by keyboard/input event
  if (event && event.target && event.target.value !== undefined) {
    query = event.target.value.trim().toLowerCase();
  }

  // If triggered manually (via button)
  if (typeof event === "string") {
    query = event.trim().toLowerCase();
  }

  if (!query || query.length < 2) return; // wait until at least 2 chars

  const allProducts = [
    ...(window.onSaleProducts || []),
    ...(window.newArrivalProducts || []),
    ...(window.featuredProducts || []),
    ...(window.bundleProducts || []),
  ];

  // Filter by name (case-insensitive, partial match)
  const results = allProducts.filter(p =>
    (p.name || "").toLowerCase().includes(query)
  );

  openSearchProductsModal(results, query);
}

// ‚úÖ Show search results in modal
function openSearchProductsModal(products, query) {
  const modal = document.getElementById("searchProductsModal");
  const listContainer = document.getElementById("searchProductsList");
  const searchTitle = document.getElementById("searchProductsTitle");

  searchTitle.innerText = `Search Results for "${query}"`;
  listContainer.innerHTML = "";

  if (products.length === 0) {
    listContainer.innerHTML = "<p style='padding:14px;'>No products found.</p>";
  } else {
    products.forEach(p => {
      const card = document.createElement("div");
      card.className = "product-card";
      card.innerHTML = createProductCardHTML(p);

      card.onclick = () => {
        closeSearchProductsModal();
        setTimeout(() => {
          if (p.items) openBundleDetails(p);
          else openProductDetailModal(p);
        }, 200);
      };

      listContainer.appendChild(card);
    });
  }

  // ‚úÖ Use modal utility (same as other modals)
  showModal(modal);
  document.body.style.overflow = "hidden"; // lock scroll
}

// ‚úÖ Close search modal
function closeSearchProductsModal() {
  const modal = document.getElementById("searchProductsModal");
  closeModal(modal); // same as other modals
  document.body.style.overflow = "auto";
}

// ‚úÖ Trigger search from button
function triggerSearch() {
  const input = document.getElementById("productSearchInput");
  const query = input.value.trim();
  if (query) handleProductSearch(query); // pass query directly
}

// ‚úÖ Allow pressing Enter to trigger search
document.addEventListener("DOMContentLoaded", () => {
  const searchInput = document.getElementById("productSearchInput");
  if (searchInput) {
    searchInput.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        triggerSearch();
      }
    });
  }
});

// ‚úÖ Local wishlist storage (for non-logged in users)
const WISHLIST_KEY = "bizmart_wishlist_v1";

function getWishlist() {
  return JSON.parse(localStorage.getItem(WISHLIST_KEY) || "[]");
}

function saveWishlist(list) {
  localStorage.setItem(WISHLIST_KEY, JSON.stringify(list));
}

function toggleWishlist(e, productId) {
  // Prevent parent click (don‚Äôt open product details when heart is clicked)
  if (e && e.stopPropagation) e.stopPropagation();

  // Ensure we‚Äôre targeting the correct button (supports multiple selectors)
  const btn = e?.target?.closest?.('.wishlist-btn, .wish-btn');
  if (!btn) return;

  // Get current wishlist
  let list = getWishlist() || [];

  const isInWishlist = list.includes(productId);

  if (isInWishlist) {
    // Remove from wishlist
    list = list.filter(id => id !== productId);
    btn.innerHTML = "ü§ç"; // use innerHTML to allow emoji/icons
    btn.classList.remove("active");
    showToast("Removed from Wishlist");
  } else {
    // Add to wishlist
    list.push(productId);
    btn.innerHTML = "‚ù§Ô∏è";
    btn.classList.add("active");
    showToast("Added to Wishlist");
  }

  // Save updated wishlist
  saveWishlist(list);

  // Refresh all wishlist buttons for consistency
  if (typeof markWishlistButtons === "function") {
    markWishlistButtons();
  }

  console.log(`üìå Wishlist updated: ${list.length} items`);
}



// ‚úÖ Highlight heart if already in wishlist
function markWishlistButtons() {
  const list = getWishlist();
  document.querySelectorAll(".wishlist-btn, .wish-btn").forEach(btn => {
    const pid = btn.dataset.pid || (btn.getAttribute("onclick") || '').match(/'(.+?)'/)?.[1];
    if (!pid) return;
    btn.innerText = list.includes(pid) ? "‚ù§Ô∏è" : "ü§ç";
    btn.classList.toggle('active', list.includes(pid));
  });
}


// Run this after rendering products
setInterval(markWishlistButtons, 1000);

function renderWishlist() {
  const container = document.getElementById("wishlistList");
  container.innerHTML = "";
  const ids = getWishlist();

  if (!ids.length) {
    container.innerHTML = "<p>Your wishlist is empty.</p>";
    return;
  }

  // 1. Collect ALL products from every category
  let allProducts = [];
  if (window.onSaleProducts) allProducts = allProducts.concat(window.onSaleProducts);
  if (window.newArrivalProducts) allProducts = allProducts.concat(window.newArrivalProducts);
  if (window.featuredProducts) allProducts = allProducts.concat(window.featuredProducts);
  if (window.bundleProducts) allProducts = allProducts.concat(window.bundleProducts);

  // 2. Build a map to ensure UNIQUE products by id
  const uniqueProducts = {};
  allProducts.forEach(p => {
    if (p && p.id) {
      uniqueProducts[p.id] = p; // ‚úÖ overwrite duplicates with the same id
    }
  });

  // 3. Only pick products that are in wishlist IDs
  const items = [];
  ids.forEach(id => {
    if (uniqueProducts[id]) {
      items.push(uniqueProducts[id]);
    }
  });

  // 4. If still empty
  if (items.length === 0) {
    container.innerHTML = "<p>Your wishlist is empty.</p>";
    return;
  }

  // 5. Render
  items.forEach(p => {
    const card = document.createElement("div");
    card.className = "product-card";
    card.innerHTML = createProductCardHTML(p);

    // ‚úÖ Open correct modal depending on type
    card.onclick = () => {
      if (p.isBundle || p.type === "bundle" || p.items) {
        openBundleDetails(p);  // üîπ Show bundle contents
      } else if (p.id) {
        openProductDetailModal(p); // üîπ Normal product
      } else {
        alert("Product ID missing!");
      }
    };

    container.appendChild(card);
  });

  markWishlistButtons();
}

function openWishlistModal() {
  renderWishlist();
  document.getElementById("wishlistModal").style.display = "block";
}

function closeWishlistModal() {
  document.getElementById("wishlistModal").style.display = "none";
}

function openAIChat() {
  const modal = document.getElementById("aiChatModal");
  const wrapper = document.getElementById("aiButtonWrapper");
  const chatBox = document.getElementById("aiChatBox");

  if (!modal || !wrapper) return;

  // Show modal with scale + fade
  modal.style.display = "flex";
  modal.style.transform = "translate(-50%, -50%) scale(0.95)";
  modal.style.opacity = "0";

  requestAnimationFrame(() => {
    modal.style.transform = "translate(-50%, -50%) scale(1)";
    modal.style.opacity = "1";
  });

  // Hide the entire wrapper (ü§ñ + ‚ùå)
  wrapper.style.transition = "opacity 0.25s ease";
  wrapper.style.opacity = "0";
  setTimeout(() => { wrapper.style.display = "none"; }, 250);

  if (typeof stopPopupLoop === "function") {
    stopPopupLoop();
  }

  // üÜï Auto-start conversation if chat is empty
  if (chatBox && chatBox.innerHTML.trim() === "") {
    addChatMessage("ai", "üëã Hi! I‚Äôm BizMart AI. How can I help you today?");
  }
}



function closeAIChat() {
  const modal = document.getElementById("aiChatModal");
  const wrapper = document.getElementById("aiButtonWrapper");

  if (!modal || !wrapper) return;

  // Smoothly hide modal
  modal.style.opacity = "0";
  modal.style.transform = "translate(-50%, -50%) scale(0.95)";
  setTimeout(() => {
    modal.style.display = "none";
  }, 250);

  // Smoothly show wrapper again
  wrapper.style.display = "inline-block";
  wrapper.style.opacity = "0";
  wrapper.style.transition = "opacity 0.25s ease";
  requestAnimationFrame(() => {
    wrapper.style.opacity = "1";
  });

  if (typeof startPopupLoop === "function") {
    startPopupLoop();
  }
}






function addChatMessage(sender, text) {
  const chatBox = document.getElementById("aiChatBox");
  const div = document.createElement("div");
  div.style.margin = "6px 0";

  if (sender === "user") {
    div.innerHTML = `
      <div style="text-align:right;">
        <span style="background:#3498db; color:#fff; padding:6px 10px; border-radius:12px; display:inline-block; max-width:80%;">
          ${text}
        </span>
      </div>`;
  } else {
    div.innerHTML = `
      <div style="text-align:left;">
        <span style="background:#eee; padding:6px 10px; border-radius:12px; display:inline-block; max-width:80%;">
          ${text}
        </span>
      </div>`;
  }

  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}

function addProductCard(prod) {
  const chatBox = document.getElementById("aiChatBox");
  const card = `
    <div style="margin:6px 0; padding:8px; border:1px solid #ddd; border-radius:10px; background:#fff; text-align:left;">
      <img src="${prod.image}" style="width:100%; border-radius:8px; margin-bottom:6px;">
      <div style="font-weight:600;">${prod.name}</div>
      <div style="color:#e67e22;">‚Ç±${prod.price}</div>
      
      <div style="margin-top:6px; display:flex; gap:6px;">
        <button onclick="addToCart('${prod.id}')" 
                style="flex:1; background:#27ae60; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer;">
          üõí Add to Cart
        </button>
        <button onclick="viewFromChat('${prod.id}')" 
                style="flex:1; background:#3498db; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer;">
          üîó View
        </button>
      </div>
    </div>`;
  chatBox.insertAdjacentHTML("beforeend", card);
  chatBox.scrollTop = chatBox.scrollHeight;
}



function sendAIMessage() {
  const input = document.getElementById("aiChatInput");
  const query = input.value.trim();
  if (!query) return;

  // Show user message immediately
  addChatMessage("user", query);
  input.value = "";

  const chatBox = document.getElementById("aiChatBox");

  // üÜï Show typing indicator
  const typingDiv = document.createElement("div");
  typingDiv.id = "aiTypingIndicator";
  typingDiv.style.cssText =
    "color:#888; font-size:13px; margin:6px 0; display:flex; align-items:center; gap:4px;";
  typingDiv.innerHTML = `
    <span>üí≠ BizMart AI is typing</span>
    <span class="dots" style="display:inline-block; width:16px; text-align:left;">...</span>
  `;
  chatBox.appendChild(typingDiv);
  chatBox.scrollTop = chatBox.scrollHeight;

  // Backend call
  google.script.run
    .withSuccessHandler(response => {
      // Remove typing indicator
      const oldTyping = document.getElementById("aiTypingIndicator");
      if (oldTyping) oldTyping.remove();

      // (Optional) Add slight delay for realism
      setTimeout(() => {
        // Show AI reply
        if (response.message) addChatMessage("ai", response.message);

        // Show product suggestions if any
        if (response.products && response.products.length) {
          response.products.forEach(prod => addProductCard(prod));
        }
      }, 400); // 400ms delay feels natural
    })
    .searchProductsAI(query); // backend call to Gemini + Sheets
}


function viewFromChat(productId) {
  // üîç Look for product in your global product list
  const product = allProducts.find(p => p.id === productId);

  if (product) {
    // Reuse your existing detail modal logic
    openProductDetailModal(product);
  } else {
    alert("‚ùå Product not found.");
  }
}

// Popup hint messages (English + Tagalog)
const aiMessages = [
  "üëã Kumusta! Ako ang BizMart AI.<br>I-click mo ako kung kailangan mo ng tulong.",
  "üõí Gusto mo bang malaman kung paano gamitin ang store?<br>I-click mo lang ako!",
];

let messageIndex = 0;
let popupInterval = null;

function showAIPopup() {
  // ‚úÖ Skip showing popup if AI is hidden
  if (localStorage.getItem("bizmartAIHidden") === "true") {
    console.log("‚è∏ Skipping popup because BizMart AI is hidden.");
    return;
  }

  const popup = document.getElementById("aiPopupMessage");
  const btn = document.getElementById("aiOpenBtn");

  if (!popup || !btn) return;
  if (btn.style.display === "none") return; // stop if button hidden

  // Set message
  popup.innerHTML = aiMessages[messageIndex];
  messageIndex = (messageIndex + 1) % aiMessages.length;

  popup.style.display = "block";
  requestAnimationFrame(() => { popup.style.opacity = "1"; });

  // Auto-hide after 5s
  setTimeout(() => {
    popup.style.opacity = "0";
    setTimeout(() => { popup.style.display = "none"; }, 500);
  }, 5000);
}

function startPopupLoop() {
  // ‚úÖ Don't start loop if AI is hidden
  if (localStorage.getItem("bizmartAIHidden") === "true") {
    console.log("‚è∏ Popup loop not started because BizMart AI is hidden.");
    return;
  }

  if (popupInterval) clearInterval(popupInterval);
  popupInterval = setInterval(showAIPopup, 15000); // show every 15s

  console.log("‚ñ∂Ô∏è Popup loop started (every 15s)");
}


function stopPopupLoop() {
  if (popupInterval) {
    clearInterval(popupInterval);
    popupInterval = null;
  }
}

// Run on page load
window.addEventListener("load", () => {
  // ‚úÖ Only show first popup if AI is not hidden
  if (localStorage.getItem("bizmartAIHidden") !== "true") {
    setTimeout(showAIPopup, 3000); // first one at 3s
    startPopupLoop();
  } else {
    console.log("‚è∏ Initial popup skipped because BizMart AI is hidden.");
  }
});



function restoreLoginSession() {
  const customerId = localStorage.getItem("customerId");
  const uniqueCode = localStorage.getItem("uniqueCode");

  // No saved session: show login button
  if (!customerId || !uniqueCode) {
    renderAuthControls();
    return false;
  }

  console.log("‚úÖ Auto-login attempt for:", customerId);

  // Validate / fetch name from server
  google.script.run
    .withSuccessHandler(function(customerObj) {
      console.log("getCustomerInfo ->", customerObj);
      if (customerObj && (customerObj.Name || customerObj["Customer Name"])) {
        const customerName = customerObj.Name || customerObj["Customer Name"];
        localStorage.setItem("customerName", customerName);
        // canonical renderer: removes login button and shows Welcome + Logout
        renderAuthControls();
        // also set window.currentCustomer so other parts can read it
        window.currentCustomer = { id: customerId, name: customerName };
      } else {
        // Server didn't find the customer ‚Üí clear stale session
        console.warn("restoreLoginSession: server did not find customer, clearing stored session");
        localStorage.removeItem("customerId");
        localStorage.removeItem("uniqueCode");
        localStorage.removeItem("customerName");
        renderAuthControls();
      }
    })
    .withFailureHandler(function(err) {
      console.error("restoreLoginSession: getCustomerInfo failed", err);
      // keep login button visible on error
      renderAuthControls();
    })
    .getCustomerInfo(customerId);

  return true;
}



function updateWelcomeUI(displayName) {
  const loginBtnContainer = document.getElementById("authControls");
  if (loginBtnContainer) {
    if (displayName && displayName.trim() !== "") {
      loginBtnContainer.innerHTML = `
        <div style="font-size:14px; font-weight:600; color:#2c3e50;">
          üë§ Welcome, ${displayName}
        </div>`;
    } else {
      hideWelcomeUI(); // hide if name is empty
    }
  }
}


// ---------- AUTH UI RENDERER ----------
function renderAuthControls() {
  const loginBtnContainer = document.getElementById("authControls");
  if (!loginBtnContainer) return;

  const customerId = localStorage.getItem("customerId");
  let customerName = localStorage.getItem("customerName");

  if (customerId) {
    // Shorten email for mobile if too long
    if (customerName && customerName.includes("@")) {
      const [namePart] = customerName.split("@");
      customerName = namePart; // show only part before @
    }

    const displayName = customerName && customerName.trim() !== "" ? customerName : "Customer";

    loginBtnContainer.innerHTML = `
      <div style="
        display:flex;
        align-items:center;
        gap:6px;
        flex-wrap:wrap;
        max-width:100%;
      ">
        <div style="
          font-size:13px;
          font-weight:600;
          color:#2c3e50;
          white-space:nowrap;
          overflow:hidden;
          text-overflow:ellipsis;
          max-width:140px;
        ">
          üë§ Welcome, ${displayName}
        </div>
        <button onclick="logout()" 
                style="
                  padding:3px 8px;
                  border-radius:6px;
                  border:none;
                  cursor:pointer;
                  background:#ef4444;
                  color:#fff;
                  font-size:12px;
                  font-weight:600;
                  line-height:1;
                ">
          Logout
        </button>
      </div>
    `;
  } else {
    loginBtnContainer.innerHTML = `
      <button id="loginBtn" onclick="openLoginModal()" 
              style="background:linear-gradient(135deg, #4facfe, #00f2fe);
                     color:#fff; border:none; padding:8px 16px; 
                     border-radius:30px; font-size:13px; font-weight:600; 
                     letter-spacing:0.5px; cursor:pointer; 
                     box-shadow:0 4px 12px rgba(0,0,0,0.2), inset 0 1px 2px rgba(255,255,255,0.4);">
        üîê Login / Sign Up
      </button>
    `;
  }
}

function closeLoginModal() {
  const modal = document.getElementById('loginModal');
  if (modal) {
    modal.classList.add('hidden');
    modal.style.display = 'none';
  }
  // If user did not log in, ensure header shows the login button again
  if (!localStorage.getItem('customerId')) {
    renderAuthControls();
  }
}


function hideAIBizmart() {
  const aiWrapper   = document.getElementById("aiButtonWrapper");    // ü§ñ main wrapper
  const aiShowBtn   = document.getElementById("aiShowBtn");          // "Show AI" button
  const aiPopup     = document.getElementById("aiPopupMessage");     // speech bubble
  const aiBubble    = document.getElementById("aiChatBubble");       // floating bubble (if exists)
  const aiIndicator = document.getElementById("aiTypingIndicator");  // dots popup (if exists)

  // ‚úÖ Hide all relevant UI elements
  if (aiWrapper)   aiWrapper.style.display = "none";
  if (aiPopup) {
    aiPopup.style.opacity = "0";
    aiPopup.style.display = "none";
    aiPopup.innerHTML = ""; // ‚úÖ clear any leftover message to avoid blank bubble when re-showed
  }
  if (aiBubble)    aiBubble.style.display = "none";
  if (aiIndicator) aiIndicator.style.display = "none";
  if (aiShowBtn)   aiShowBtn.style.display = "inline-block";

  // ‚úÖ Save hidden state
  localStorage.setItem("bizmartAIHidden", "true");

  // ‚úÖ Stop popup loop / animation timers
  if (typeof stopPopupLoop === "function") stopPopupLoop();
  if (typeof stopAIPopupLoop === "function") stopAIPopupLoop(true);

  // ‚úÖ Clear any pending auto-hide timeout if exists
  if (typeof aiAutoHideTimeout !== "undefined" && aiAutoHideTimeout) {
    clearTimeout(aiAutoHideTimeout);
    aiAutoHideTimeout = null;
  }

  console.log("ü§ñ BizMart AI widget hidden (UI, popup loop, and timers stopped).");
}


function showAIBizmart() {
  const aiWrapper   = document.getElementById("aiButtonWrapper");
  const aiShowBtn   = document.getElementById("aiShowBtn");
  const aiPopup     = document.getElementById("aiPopupMessage");
  const aiBubble    = document.getElementById("aiChatBubble");

  // Show all relevant UI
  if (aiWrapper) aiWrapper.style.display = "inline-block";
  if (aiShowBtn) aiShowBtn.style.display = "none";
  if (aiBubble)  aiBubble.style.display = "block";

  // Reset popup message state so it doesn't show blank
  if (aiPopup) {
    aiPopup.innerHTML = "";
    aiPopup.style.display = "none";
    aiPopup.style.opacity = "0";
  }

  // Save state
  localStorage.setItem("bizmartAIHidden", "false");

  // Restart popup loop + show first message after a short delay
  if (typeof startPopupLoop === "function") startPopupLoop();
  if (typeof showAIPopup === "function") {
    setTimeout(() => {
      showAIPopup();
    }, 800); // small delay for smooth appearance
  }

  console.log("ü§ñ BizMart AI widget shown again (popup loop restarted).");
}

// Restore preference after reload
document.addEventListener("DOMContentLoaded", () => {
  if (localStorage.getItem("bizmartAIHidden") === "true") {
    console.log("üîÑ Restoring hidden BizMart AI state...");

    const aiWrapper   = document.getElementById("aiButtonWrapper");
    const aiShowBtn   = document.getElementById("aiShowBtn");
    const aiPopup     = document.getElementById("aiPopupMessage");
    const aiBubble    = document.getElementById("aiChatBubble");
    const aiIndicator = document.getElementById("aiTypingIndicator");

    // Hide everything (same as hideAIBizmart)
    if (aiWrapper)   aiWrapper.style.display = "none";
    if (aiPopup)   { aiPopup.style.opacity = "0"; aiPopup.style.display = "none"; }
    if (aiBubble)    aiBubble.style.display = "none";
    if (aiIndicator) aiIndicator.style.display = "none";
    if (aiShowBtn)   aiShowBtn.style.display = "inline-block";

    // Stop popup loop to prevent speech bubble from reappearing
    if (typeof stopAIPopupLoop === "function") stopAIPopupLoop(true);
  }
});


function stopAIPopupLoop(stop) {
  if (stop) {
    if (typeof stopPopupLoop === "function") stopPopupLoop();
    if (typeof popupInterval !== "undefined" && popupInterval) {
      clearInterval(popupInterval);
      popupInterval = null;
    }
    if (typeof aiAutoHideTimeout !== "undefined" && aiAutoHideTimeout) {
      clearTimeout(aiAutoHideTimeout);
      aiAutoHideTimeout = null;
    }
    console.log("üõë BizMart AI popup loop and timers stopped.");
  } else {
    if (typeof startPopupLoop === "function") startPopupLoop();
    console.log("‚ñ∂Ô∏è BizMart AI popup loop restarted.");
  }
}




function startVoiceInput() {
  // Detect if user is inside Telegram / Messenger in-app browser
  const ua = navigator.userAgent.toLowerCase();
  if (ua.includes("telegram") || ua.includes("fb") || ua.includes("messenger")) {
    alert("‚ö†Ô∏è Voice input is not supported inside Telegram/Facebook in-app browser.\n\nPlease tap '‚ãÆ' ‚Üí 'Open in Chrome/Safari' to use the microphone.");
    return;
  }

  // Check browser support
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert("‚ùå Your browser does not support voice input. Please use Chrome or Safari.");
    return;
  }

  const recognition = new SpeechRecognition();
  recognition.lang = "en-US";   // or "fil-PH" for Filipino
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  try {
    recognition.start();
  } catch (err) {
    console.error("Recognition start error:", err);
    alert("‚ö†Ô∏è Voice input could not be started. Please try again in Chrome or Safari.");
    return;
  }

  recognition.onstart = () => {
    console.log("üé§ Voice input started...");
  };

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    console.log("Voice input:", transcript);

    const input = document.getElementById("aiChatInput");
    if (input) {
      input.value = transcript;
      // Auto-send to AI if you want:
      sendAIMessage();
    }
  };

  recognition.onerror = (event) => {
    console.error("Speech recognition error:", event.error);
    if (event.error === "not-allowed" || event.error === "permission-denied") {
      alert("‚ö†Ô∏è Microphone access was blocked. Please allow microphone permissions in your browser.");
    } else {
      alert("‚ö†Ô∏è Voice input error: " + event.error);
    }
  };

  recognition.onend = () => {
    console.log("üé§ Voice input ended.");
  };
}

function openServicesModal() {
  const modal = document.getElementById("servicesModal");
  if (!modal) {
    console.warn("‚ö†Ô∏è servicesModal not found in DOM.");
    return;
  }

  modal.style.display = "block";

  const container = document.getElementById("servicesList");
  if (!container) {
    console.warn("‚ö†Ô∏è servicesList container not found inside servicesModal.");
    return;
  }

  // ‚úÖ If already cached, render instantly
  if (cachedServices) {
    container.innerHTML = ""; // clear loading text if any
    renderServices(cachedServices);
    return;
  }

  // Show loading only on first load
  container.innerHTML = "<p>‚è≥ Loading services...</p>";

  // Fetch services from server once
  google.script.run.withSuccessHandler(function (data) {
    try {
      const services = Array.isArray(data) ? data : JSON.parse(data);
      cachedServices = services; // ‚úÖ save in cache
      renderServices(services);
    } catch (e) {
      console.error("‚ùå Failed to parse services:", e, data);
      renderServices([]);
    }
  }).getServices();
}

function closeServicesModal() {
  const modal = document.getElementById("servicesModal");
  if (modal) {
    modal.style.display = "none";
  }
}

// üîπ New function for Pasuyo
function openPasuyoModal() {
  if (!ensureLoggedIn()) return; // make sure user is logged in
  const modal = document.getElementById("pasuyoModal");
  modal.style.display = "block";

  // reset fields
  document.getElementById("foodListContainer").innerHTML = "";
  addFoodRow(); // add one row by default
  document.getElementById("pasuyoNotes").value = "";
  document.getElementById("pasuyoTotal").innerHTML = "Service Fee: ‚Ç±10.00 <br>Total: ‚Ç±10.00";

  // üîπ load delivery times from server
  loadDeliveryTimes();
}


function closePasuyoModal() {
  const modal = document.getElementById("pasuyoModal");
  if (modal) {
    modal.style.display = "none";
  }
}



  function renderServices(services) {
  console.log("üì¶ Services received:", services);

  // ‚úÖ Save globally so we can look up ServiceName later in renderMyServices
  window.availableServices = services;

  const container = document.getElementById("servicesList");
  if (!container) {
    console.warn("‚ö†Ô∏è servicesList container not found in DOM.");
    return;
  }

  container.innerHTML = "";

  // Handle invalid / empty services
  if (!services || !Array.isArray(services)) {
    container.innerHTML = "<p style='color:red;'>‚ö†Ô∏è Error: No services returned from server.</p>";
    return;
  }
  if (services.length === 0) {
    container.innerHTML = "<p>No services available right now.</p>";
    return;
  }

  // ‚úÖ Save in cache so openServicesModal can reuse instantly
  window.cachedServices = services;

  // Render each service card
  services.forEach(svc => {
    const card = document.createElement("div");
    card.className = "service-card"; // easier styling in CSS
    card.style.padding = "12px";
    card.style.border = "1px solid #ddd";
    card.style.borderRadius = "10px";
    card.style.cursor = "pointer";
    card.style.background = "#fff"; // keep cards white
    card.style.marginBottom = "10px";
    card.style.transition = "background 0.2s, transform 0.2s";

    card.innerHTML = `
      <h3 style="font-weight:600; font-size:16px; margin:0;">${svc.ServiceName}</h3>
      <p style="color:#555; margin:4px 0;">${svc.Description || ""}</p>
      <p style="color:#e67e22; font-weight:bold; margin:0;">
        ‚Ç±${svc.PricePerPage} / ‚Ç±${svc.BasePrice}
      </p>
    `;

    // ‚úÖ Add hover effect
    card.onmouseenter = () => {
      card.style.background = "#f9f9f9";
      card.style.transform = "scale(1.01)";
    };
    card.onmouseleave = () => {
      card.style.background = "#fff";
      card.style.transform = "scale(1)";
    };

    // ‚úÖ Different modal for Pasuyo (SVC003)
    card.onclick = () => {
      if (svc.ServiceID === "SVC003") {
        openPasuyoModal(); // open directly
      } else {
        openServiceRequestModal(svc.ServiceID); // Printing/Tutoring/etc.
      }
    };

    container.appendChild(card);
  });
}





  function openServiceOrdersModal(serviceId) {
  // Only run if user is admin
  if (!window.currentCustomer || !window.currentCustomer.isAdmin) {
    return;
  }

  google.script.run.withSuccessHandler(function(data) {
    try {
      const orders = JSON.parse(data);
      renderServiceOrders(orders);

      const modal = document.getElementById("serviceOrdersModal");
      if (modal) {
        modal.style.display = "block";
      }
    } catch (e) {
      console.error("‚ùå Failed to parse service orders:", e, data);
      renderServiceOrders([]);
    }
  }).getServiceOrders(serviceId);
}




  function closeServiceOrdersModal() {
    document.getElementById("serviceOrdersModal").style.display = "none";
  }

  function renderServiceOrders(data) {
  const container = document.getElementById("myServicesList");
  if (!container) return;

  let orders = [];
  try {
    if (typeof data === "string") {
      orders = JSON.parse(data); // server returns JSON string
    } else if (Array.isArray(data)) {
      orders = data;
    } else {
      console.warn("‚ö†Ô∏è Unexpected data type from server:", data);
    }
  } catch (e) {
    console.error("‚ùå Failed to parse service orders:", e, data);
  }

  container.innerHTML = "";

  if (!orders || orders.length === 0) {
    container.innerHTML = "<p>No service orders yet.</p>";
    return;
  }

  orders.forEach(o => {
    const div = document.createElement("div");
    div.style.border = "1px solid #ddd";
    div.style.padding = "12px";
    div.style.marginBottom = "12px";
    div.style.borderRadius = "8px";
    div.style.background = "#fff";

    // Build action buttons
    let actions = `
      <button onclick="viewServiceOrder('${o.OrderID}')" 
              style="padding:6px 10px; border:none; border-radius:6px; background:#3498db; color:#fff; cursor:pointer;">
        üîç View
      </button>
    `;

    if (o.Status === "Ready") {
      actions += `
        <button onclick="openServiceDoneModal('${o.OrderID}')" 
                style="padding:6px 10px; border:none; border-radius:6px; background:#16a34a; color:#fff; cursor:pointer;">
          ‚úÖ Service Done
        </button>
      `;
    }

    if (o.Status === "Pending" || o.Status === "Ready") {
      actions += `
        <button onclick="openCancelServiceModal('${o.OrderID}')" 
                style="padding:6px 10px; border:none; border-radius:6px; background:#e74c3c; color:#fff; cursor:pointer;">
          ‚ùå Cancel
        </button>
      `;
    }

    div.innerHTML = `
      <p><b>üÜî OrderID:</b> ${o.OrderID}</p>
      <p><b>üõ†Ô∏è Service:</b> ${o.Message}</p>
      <p><b>üìÑ Pages:</b> ${o.Pages}</p>
      <p><b>üìÖ Pickup Time:</b> ${o.PickupTime || "-"}</p>
      <p><b>üöö Delivery Time:</b> ${o.DeliveryTime || "-"}</p>
      <p><b>üí∞ Total:</b> ‚Ç±${o.TotalAmount}</p>
      <p><b>üìå Status:</b> ${o.Status}</p>
      <p><b>üìÜ Date Requested:</b> ${o.DateRequested}</p>
      <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
        ${actions}
      </div>
    `;
    container.appendChild(div);
  });
}





// show/hide helpers
function openServiceRequestModal() {
  const modal = document.getElementById('serviceRequestModal');
  if (!ensureLoggedIn()) return; // require login
  modal.style.display = 'block';
  // prefill estimate reset
  document.getElementById('srEstimate').innerText = '‚Ç±0.00';
  document.getElementById('srStatus').innerText = '';
}

function closeServiceRequestModal() {
  // ‚úÖ Fix: match the correct modal ID (adjust "srModal" if needed)
  const modal = document.getElementById('srModal') || 
                document.getElementById('serviceRequestModal') || 
                document.getElementById('printRequestModal');

  if (modal) {
    modal.style.display = 'none';
  }

  // clear file input safely
  const f = document.getElementById('srFile');
  if (f) f.value = '';

  const imgRow = document.getElementById('srImageCountRow');
  if (imgRow) imgRow.style.display = 'none';

  const imgCount = document.getElementById('srImageCount');
  if (imgCount) imgCount.value = 0;
}


function srColorChanged(){
  const color = document.getElementById('srColor').value;
  document.getElementById('srImageCountRow').style.display = color === 'With Image' ? 'block' : 'none';
  updateSrEstimate();
}

// estimate UI: compute using the rules: B/W ‚Ç±5/page; with-image pages ‚Ç±8/page, other pages ‚Ç±5/page
function updateSrEstimate(pages /*optional*/) {
  const pagesVal = (typeof pages === 'number' && pages>0) ? pages : 0;
  const color = document.getElementById('srColor').value;
  const imagesCount = Number(document.getElementById('srImageCount')?.value || 0);
  let total = 0;
  if (pagesVal <= 0) {
    // unknown: can't estimate
    document.getElementById('srEstimate').innerText = '‚Ç±‚Äî (pages unknown)';
    return;
  }
  if (color === 'Black and White') {
    total = pagesVal * 5.00;
  } else {
    const withImagePages = Math.min(imagesCount, pagesVal);
    const withoutImagePages = Math.max(0, pagesVal - withImagePages);
    total = withImagePages * 8.00 + withoutImagePages * 5.00;
  }
  document.getElementById('srEstimate').innerText = `‚Ç±${total.toFixed(2)}`;
}

// when user changes image count input, recompute estimate if pages known
document.addEventListener('input', function(e){
  if (e.target && e.target.id === 'srImageCount') {
    const pages = Number(document.getElementById('srEstimatedPages')?.value || 0);
    updateSrEstimate(pages);
  }
});

// MAIN submit
// ==============================
// Submit Service Request
// ==============================
async function analyzePdfFile(file) {
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
  const OPS = pdfjsLib.OPS;

  let totalPages = pdf.numPages;
  let imagePages = 0;

  for (let p = 1; p <= totalPages; p++) {
    const page = await pdf.getPage(p);
    const opList = await page.getOperatorList();
    const fnArray = opList.fnArray;

    let hasImage = false;
    for (let i = 0; i < fnArray.length; i++) {
      if (fnArray[i] === OPS.paintImageXObject || fnArray[i] === OPS.paintInlineImageXObject) {
        hasImage = true;
        break;
      }
    }
    if (hasImage) imagePages++;
  }

  return { pages: totalPages, imagePages, nonImagePages: totalPages - imagePages };
}

// ==============================
// Submit Service Request
// ==============================
async function submitServiceRequest() {
  if (!ensureLoggedIn()) return;

  const submitBtn = document.getElementById('submitServiceBtn') ||
                    document.querySelector('button[onclick="submitServiceRequest()"]');
  const fileEl = document.getElementById('srFile');
  const statusEl = document.getElementById('srStatus');

  if (!fileEl || !fileEl.files || fileEl.files.length === 0) {
    alert('Please upload the PDF file first.');
    return;
  }
  const file = fileEl.files[0];
  if (file.type !== 'application/pdf') {
    alert('Only PDF files are supported.');
    return;
  }

  // disable UI
  if (submitBtn) { 
    submitBtn.disabled = true; 
    submitBtn._origText = submitBtn._origText || submitBtn.innerText; 
    submitBtn.innerText = '‚è≥ Analyzing...'; 
  }
  fileEl.disabled = true;
  statusEl.innerText = 'Analyzing PDF...';
  showLoading('Analyzing PDF...');

  try {
    // analyze using pdf.js
    const analysis = await analyzePdfFile(file);
    const pages = analysis.pages;
    const imagePages = analysis.imagePages;
    const nonImagePages = analysis.nonImagePages;

    // base total
    let total = (imagePages * 8.00) + (nonImagePages * 5.00);

    // ‚úÖ Service Option logic (fixed)
    const serviceOption = document.getElementById('srServiceOption').value;
    let deliveryTime = '';
    let pickupTime = '';

    if (serviceOption === 'Delivery') {
      const sel = document.getElementById('srDeliveryTime');
      if (sel) {
        if (sel.selectedIndex >= 0 && sel.options[sel.selectedIndex]) {
          deliveryTime = sel.options[sel.selectedIndex].text || sel.value || '';
        } else {
          deliveryTime = sel.value || '';
        }
      }
      total += 5.00; // add delivery fee
    } else {
      const timeInput = document.getElementById('srPickupTime');
      if (timeInput) {
        pickupTime = timeInput.value || '';
      }
    }

    // update estimate display
    document.getElementById('srEstimate').innerText = `‚Ç±${total.toFixed(2)}`;
    statusEl.innerText = `Pages: ${pages} (with images: ${imagePages}) ‚Äî Estimated: ‚Ç±${total.toFixed(2)}`;

    // update UI to uploading state
    if (submitBtn) { submitBtn.innerText = '‚è≥ Uploading...'; }
    showLoading('Uploading file...');

    // read file as base64
    const base64 = await new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result.split(',')[1]);
      reader.onerror = (err) => reject(err);
      reader.readAsDataURL(file);
    });

    // call server to upload file (only upload, no save to ServiceOrders yet)
    const uploadRes = await new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .uploadServiceFile(base64, file.name, pages, imagePages);
    });
    hideLoading();

    if (!uploadRes || !uploadRes.success) {
      throw new Error((uploadRes && uploadRes.error) ? uploadRes.error : 'Upload failed');
    }

    // Prepare pending print order (but don‚Äôt save yet)
    const order = {
      ServiceID: 'SVC001',
      SellerID: 'S001',
      CustomerID: window.currentCustomer?.id || localStorage.getItem('customerId') || '',
      FileID: uploadRes.fileId,
      Message: document.getElementById('srMessage').value || '',
      FileSize: document.getElementById('srSize').value || 'A4',
      Color: 'Black and White',
      ServiceOption: serviceOption,
      DeliveryTime: deliveryTime,
      PickupTime: pickupTime,
      Pages: pages,
      ImagePages: imagePages,
      NonImagePages: nonImagePages,
      PricePerPage: '‚Ç±5.00/‚Ç±8.00',
      TotalAmount: total.toFixed(2),
      Status: 'Pending'
    };

    // store temporarily
    window.__pendingPrintOrder = order;

    // show confirmation modal
    document.getElementById("confirmDetails").innerText =
      `File: ${file.name}\nPages: ${pages}\nWith Images: ${imagePages}\nPaper: ${order.FileSize}\nOption: ${serviceOption}${serviceOption === 'Delivery' ? '\nDelivery Time: ' + deliveryTime : '\nPickup Time: ' + pickupTime}\nEstimated: ‚Ç±${total.toFixed(2)}`;
    document.getElementById("printConfirmModal").style.display = "flex";

  } catch (err) {
    console.error('‚ùå submitServiceRequest failed:', err);
    statusEl.innerText = 'Failed to prepare print request: ' + (err && err.message ? err.message : err);
    alert('Error: ' + (err && err.message ? err.message : String(err)));
  } finally {
    fileEl.disabled = false;
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.innerText = submitBtn._origText || '‚úÖ Submit Request';
    }
    hideLoading();
  }
}









// -------------------------
// Confirm & Submit Order (single consolidated handler)
// -------------------------
(function initConfirmHandler() {
  const confirmBtn = document.getElementById("confirmPrintBtn");
  if (!confirmBtn) return;

  // clear any previous handlers to avoid duplicates
  confirmBtn.onclick = null;

  confirmBtn.addEventListener('click', function () {
    if (!window.__pendingPrintOrder) return;

    const orderObj = window.__pendingPrintOrder; // capture at click time
    const statusEl = document.getElementById('srStatus');
    const confirmLoading = document.getElementById('confirmLoading');

    // UI: show loading state
    confirmLoading && (confirmLoading.style.display = "block");
    confirmBtn.disabled = true;
    confirmBtn._origText = confirmBtn._origText || confirmBtn.innerText;
    confirmBtn.innerText = "‚è≥ Processing...";

    statusEl.innerText = 'Processing order, please wait...';
    showLoading("Processing order...");

    // call server
    google.script.run
      .withSuccessHandler(function (finalRes) {
        hideLoading();
        // restore button
        confirmBtn.disabled = false;
        confirmBtn.innerText = confirmBtn._origText || "‚úÖ Confirm";
        confirmLoading && (confirmLoading.style.display = "none");

        if (finalRes && finalRes.success) {
          statusEl.innerText = 'Request submitted successfully!';
          // show success modal
          document.getElementById("successDetails").innerText =
            `Your print request has been submitted.\n\nOrder ID: ${finalRes.orderId}\nTotal: ‚Ç±${orderObj.TotalAmount}`;
          document.getElementById("printSuccessModal").style.display = "flex";

          // close confirm modal and service modal
          closePrintConfirm();
          closeServiceRequestModal();

          // clear pending order only after success
          window.__pendingPrintOrder = null;
        } else {
          statusEl.innerText = 'Failed to submit order.';
          alert('‚ùå Failed to submit order: ' + (finalRes && finalRes.error ? finalRes.error : 'unknown'));
        }
      })
      .withFailureHandler(function (err) {
        hideLoading();
        confirmBtn.disabled = false;
        confirmBtn.innerText = confirmBtn._origText || "‚úÖ Confirm";
        confirmLoading && (confirmLoading.style.display = "none");

        console.error("‚ùå submitServiceOrder failed:", err);
        statusEl.innerText = 'Failed to submit order (server error).';
        alert('Server error while submitting order. Please try again.');
      })
      .submitServiceOrder(orderObj);
  });
})();



// -------------------------
// Close confirmation modal (keeps pending order so user can re-open if needed)
// -------------------------
function closePrintConfirm() {
  const modal = document.getElementById("printConfirmModal");
  if (modal) modal.style.display = "none";
  // Do not clear window.__pendingPrintOrder here ‚Äî keep it until order is submitted successfully
}

// -------------------------
// Helpful fallback show/hide loading (only if you don't already have them)
// -------------------------
function showLoading(msg) {
  try {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
      overlay.style.display = 'flex';
      const text = document.getElementById('loadingOverlayText');
      if (text && msg) text.innerText = msg;
    } else {
      // no overlay present; optional console fallback
      console.log('Loading...', msg || '');
    }
  } catch (e) { console.log('showLoading fallback', e); }
}
function hideLoading() {
  try {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) overlay.style.display = 'none';
  } catch (e) { console.log('hideLoading fallback', e); }
}



// üÜï Close success modal
function closePrintSuccess() {
  document.getElementById("printSuccessModal").style.display = "none";
  window.__pendingPrintOrder = null;
}

function showLoading(msg = "Processing...") {
  const overlay = document.getElementById("loadingOverlay");
  if (!overlay) return;
  overlay.style.display = "flex";
  overlay.querySelector("p").innerText = msg;
}

function hideLoading() {
  const overlay = document.getElementById("loadingOverlay");
  if (!overlay) return;
  overlay.style.display = "none";
}

function serviceOptionChanged() {
  const option = document.getElementById("srServiceOption").value;
  const deliveryRow = document.getElementById("srDeliveryRow");
  const pickupRow = document.getElementById("srPickupRow");

  if (option === "Delivery") {
    deliveryRow.style.display = "block";
    pickupRow.style.display = "none";

    // ‚úÖ Load available delivery times
    const select = document.getElementById("srDeliveryTime");
    select.innerHTML = `<option value="">Loading...</option>`;

    google.script.run.withSuccessHandler(function(times) {
      select.innerHTML = `<option value="">Select Time</option>`;

      (times || []).forEach(t => {
        const optId = t?.id || t?.["Option ID"] || "";
        const optLabel = t?.label || t?.["Time Slot"] || "";
        const available = (t?.Available ?? t?.available) ?? null;

        const include =
          (optId && optLabel && available == null) ||
          (String(available).toLowerCase() === "yes");

        if (include) {
          select.innerHTML += `<option value="${optId}">${optLabel}</option>`;
        }
      });

      // If no slots
      if (select.options.length === 1) {
        select.innerHTML = `<option value="">No delivery slots available</option>`;
      }
    }).getAvailableDeliveryTimes();

  } else {
    deliveryRow.style.display = "none";
    pickupRow.style.display = "block";
  }
}




let serviceOrdersInterval; // global tracker

function showServicesTab() {
  document.getElementById("servicesSection").style.display = "block";
  document.getElementById("myServicesSection").style.display = "none";

  document.getElementById("servicesTab").classList.add("active");
  document.getElementById("myServicesTab").classList.remove("active");

  // ‚úÖ Stop auto-refresh when leaving My Service Orders
  if (serviceOrdersInterval) {
    clearInterval(serviceOrdersInterval);
    serviceOrdersInterval = null;
  }

  const container = document.getElementById("servicesList");
  if (container) {
    container.innerHTML = "<p>‚è≥ Loading services...</p>";
  }

  // ‚úÖ getServices returns JSON string ‚Üí must parse
  google.script.run
    .withSuccessHandler(data => {
      let services = [];
      try {
        services = JSON.parse(data);
      } catch (e) {
        console.error("‚ùå Failed to parse services:", e, data);
      }
      renderServices(services);
    })
    .getServices();
}

function showMyServicesTab() {
  document.getElementById("servicesSection").style.display = "none";
  document.getElementById("myServicesSection").style.display = "block";

  document.getElementById("servicesTab").classList.remove("active");
  document.getElementById("myServicesTab").classList.add("active");

  const container = document.getElementById("myServicesList");
  if (container) {
    container.innerHTML = "<p>‚è≥ Loading your service orders...</p>";
  }

  const customerId = window.currentCustomer?.id || localStorage.getItem("customerId");
  if (!customerId) {
    container.innerHTML = "<p style='color:red;'>‚ö†Ô∏è You must log in to see service orders.</p>";
    return;
  }

  // ‚úÖ Load once immediately
  loadServiceOrders(customerId);

  // ‚úÖ Clear old interval if exists
  if (serviceOrdersInterval) clearInterval(serviceOrdersInterval);

  // ‚úÖ Auto-refresh every 15 seconds
  serviceOrdersInterval = setInterval(() => {
    loadServiceOrders(customerId);
  }, 15000);
}

function loadServiceOrders(customerId) {
  // ‚úÖ getServiceOrders returns array directly ‚Üí no JSON.parse
  google.script.run
    .withSuccessHandler(orders => {
      if (!Array.isArray(orders)) {
        console.error("‚ùå Invalid orders data:", orders);
        renderMyServices([]);
        return;
      }
      renderMyServices(orders);
    })
    .getServiceOrders(customerId);
}






// Helper: find service name by ID from your services catalog
function getServiceNameById(id) {
  const svc = (window.availableServices || []).find(s => s.ServiceID === id);
  return svc ? svc.ServiceName : id; // fallback to ID if not found
}

function renderMyServices(orders) {
  const container = document.getElementById("myServicesList");
  if (!container) return;

  // Save globally so filter buttons can access later
  window.myServiceOrders = Array.isArray(orders) ? orders : [];

  if (!Array.isArray(orders) || orders.length === 0) {
    container.innerHTML = "<p style='padding:10px; color:#777;'>No service orders yet.</p>";
    return;
  }

  // ‚úÖ Check which filter button is active
  const activeBtn = document.querySelector(".serviceFilterBtn.active");
  const currentFilter = activeBtn ? activeBtn.getAttribute("data-status") : "Pending";

  // ‚úÖ Render using current filter (not always Pending)
  filterServiceOrders(currentFilter);
}


function renderOrderCard(o) {
  return `
    <div style="border:1px solid #ddd; padding:12px; margin-bottom:10px; border-radius:10px;
                background:#fff; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
      <div style="font-weight:600; margin-bottom:6px;">üÜî ${o.OrderID}</div>
      <div style="font-size:14px; color:#2c3e50; margin-bottom:4px;">üõ†Ô∏è ${getServiceNameById(o.ServiceID)}</div>
      <div style="color:#555; font-size:14px;">üìÖ ${o.DateRequested}</div>
      <div style="margin-top:6px;">üñ®Ô∏è <b>${o.ServiceOption}</b></div>
      <div style="font-size:14px; color:#555;">üìÑ ${o.Pages} pages (üñºÔ∏è ${o.ImagePages} with images)</div>
      <div style="margin-top:4px;">üìå Status:
        <span style="font-weight:600; color:${
          o.Status === 'Pending' ? '#e67e22' :
          o.Status === 'Ready' ? '#3498db' :
          o.Status === 'Completed' ? 'green' : 'red'
        };">
          ${o.Status}
        </span>
      </div>
      <div style="margin-top:6px; font-weight:bold; color:#27ae60;">üí∞ Total: ${o.TotalAmount}</div>
      
      <div style="margin-top:8px;">
        <button onclick="viewServiceOrder('${o.OrderID}')"
                style="padding:6px 12px; border:none; border-radius:6px; background:#3498db; color:white; cursor:pointer;">
          üîç View
        </button>

        ${ o.Status === 'Ready' ? `
          <button onclick="openServiceDoneModal('${o.OrderID}')"
                  style="margin-left:6px; padding:6px 12px; border:none; border-radius:6px; background:#16a34a; color:white; cursor:pointer;">
            ‚úÖ Service Done
          </button>` : '' }

        ${ o.Status === 'Pending' ? `
          <button onclick="confirmCancelServiceOrder('${o.OrderID}')"
                  style="margin-left:6px; padding:6px 12px; border:none; border-radius:6px; background:#e74c3c; color:white; cursor:pointer;">
            ‚ùå Cancel
          </button>` : '' }
      </div>
    </div>
  `;
}


function filterServiceOrders(status) {
  const container = document.getElementById("myServicesList");
  if (!container) return;

  // Highlight active button
  document.querySelectorAll(".serviceFilterBtn").forEach(btn => btn.classList.remove("active"));
  const activeBtn = document.querySelector(`.serviceFilterBtn[data-status="${status}"]`);
  if (activeBtn) activeBtn.classList.add("active");

  const orders = (window.myServiceOrders || []).filter(o => o.Status === status);

  if (orders.length === 0) {
    container.innerHTML = `<p style="padding:10px; color:#777;">No ${status.toLowerCase()} service orders.</p>`;
    return;
  }

  // ‚úÖ Use renderOrderCard so Pending gets the ‚ùå Cancel button
  container.innerHTML = orders.map(renderOrderCard).join("");
}


function confirmCancelServiceOrder(orderId) {
  cancelOrderId = orderId;
  document.getElementById("cancelReasonInput").value = ""; // clear textarea
  document.getElementById("cancelServiceModal").style.display = "flex";
}

// ‚úÖ Close cancel modal
function closeCancelServiceModal() {
  cancelOrderId = null;
  document.getElementById("cancelServiceModal").style.display = "none";
}

// ‚úÖ Handle "Yes, Cancel" button
document.getElementById("confirmCancelServiceBtn").onclick = function () {
  if (!cancelOrderId) return;

  const reason =
    document.getElementById("cancelReasonInput")?.value.trim() ||
    "No reason provided";

  // Show loading spinner (if defined)
  showLoading && showLoading("Cancelling order...");

  google.script.run
    .withSuccessHandler(function (res) {
      hideLoading && hideLoading();
      if (res && res.success) {
        showSuccessModal("‚úÖ Order cancelled successfully.");
        closeCancelServiceModal();

        // üîÑ Reload service orders for current customer
        const customerId =
          window.currentCustomer?.id || localStorage.getItem("customerId");
        if (customerId) {
          loadServiceOrders(customerId);
        }
      } else {
        const err = res?.error || "Unknown error";
        alert("‚ùå Failed to cancel order: " + err);
        console.error("cancelServiceOrder failed:", res);
      }
    })
    .withFailureHandler(function (err) {
      hideLoading && hideLoading();
      console.error("cancelServiceOrder failed:", err);
      alert("‚ùå Failed to cancel order (network/server error).");
    })
    .cancelServiceOrder(cancelOrderId, reason); // ‚úÖ pass reason to backend
};

function viewServiceOrder(orderId) {
  const order = (window.myServiceOrders || []).find(o => o.OrderID === orderId);
  if (!order) {
    alert("‚ùå Order not found.");
    return;
  }

  const serviceName = getServiceNameById(order.ServiceID);

  // Build details HTML
  const html = `
    <p><b>üÜî Order ID:</b> ${order.OrderID}</p>
    <p><b>üìÖ Date:</b> ${order.DateRequested}</p>
    <p><b>üõ†Ô∏è Service:</b> ${serviceName}</p>
    <p><b>üñ®Ô∏è Option:</b> ${order.ServiceOption}</p>
    <p><b>üìÑ Pages:</b> ${order.Pages} (üñºÔ∏è ${order.ImagePages} with images)</p>
    <p><b>üìå Status:</b> ${order.Status}</p>
    <p><b>üí∞ Total:</b> ${order.TotalAmount}</p>
    ${order.DeliveryTime ? `<p><b>üöö Delivery Time:</b> ${order.DeliveryTime}</p>` : ""}
    ${order.PickupTime ? `<p><b>üè¨ Pickup Time:</b> ${order.PickupTime}</p>` : ""}
    ${order.Message ? `<p><b>üìù Message:</b> ${order.Message}</p>` : ""}
  `;

  // ‚úÖ Match the modal element IDs in your HTML
  document.getElementById("serviceOrderViewContent").innerHTML = html;
  document.getElementById("serviceOrderViewModal").style.display = "flex";
}

function closeServiceOrderView() {
  document.getElementById("serviceOrderViewModal").style.display = "none";
}

function showSuccessModal(message, autoClose = true) {
  document.getElementById("successMessage").textContent = message || "Success!";
  const modal = document.getElementById("successModal");
  modal.style.display = "flex";

  // Auto-close after 3 seconds unless disabled
  if (autoClose) {
    setTimeout(() => {
      closeSuccessModal();
    }, 3000);
  }
}

function closeSuccessModal() {
  document.getElementById("successModal").style.display = "none";
}

function markServiceDone(orderId) {
  google.script.run.withSuccessHandler(res => {
    if (res.success) {
      alert("‚úÖ Service marked as Done!");
      closeServiceDoneModal();

      // Refresh list so it moves to Completed tab
      filterServiceOrders("Completed");
    } else {
      alert("‚ùå Error: " + res.error);
    }
  }).markServiceDone(orderId);
}

// üîì Open the Service Done modal
function openServiceDoneModal(orderId) {
  currentServiceDoneOrderId = orderId;
  document.getElementById("serviceDoneModal").style.display = "flex";

  // bind the confirm button to call the handler
  const btn = document.getElementById("confirmServiceDoneBtn");
  btn.onclick = () => confirmServiceDone();
}

// üîí Close the Service Done modal
function closeServiceDoneModal() {
  currentServiceDoneOrderId = null;
  document.getElementById("serviceDoneModal").style.display = "none";
}

// ‚úÖ Confirm service completion
function confirmServiceDone() {
  if (!currentServiceDoneOrderId) return;

  const btn = document.getElementById("confirmServiceDoneBtn");
  if (btn) {
    btn.disabled = true;
    btn._origText = btn._origText || btn.innerText;
    btn.innerText = "‚è≥ Processing...";
  }

  // Show global loading overlay (if present)
  try { showLoading && showLoading("Marking service as done..."); } catch(e){console.warn(e)}

  google.script.run
    .withSuccessHandler(function (res) {
      try { hideLoading && hideLoading(); } catch(e){console.warn(e)}
      if (btn) {
        btn.disabled = false;
        btn.innerText = btn._origText || "‚úÖ Yes, Done";
      }

      if (res && res.success) {
        // Update local cache if available for instant UI update
        try {
          if (Array.isArray(window.myServiceOrders)) {
            const idx = window.myServiceOrders.findIndex(o => String(o.OrderID) === String(currentServiceDoneOrderId));
            if (idx > -1) {
              window.myServiceOrders[idx].Status = "Completed";
            }
          }
        } catch (e) { console.warn("Failed to update local cache:", e); }

        // Use the existing site success modal (falls back to alert if missing)
        if (typeof showSuccessModal === "function") {
          showSuccessModal("‚úÖ Service order marked as Done!");
        } else {
          alert("‚úÖ Service order marked as Done!");
        }

        // Close confirmation modal and re-render current filter (keeps user context)
        try { closeServiceDoneModal(); } catch(e){console.warn(e)}

        const activeBtn = document.querySelector(".serviceFilterBtn.active");
        const currentFilter = activeBtn ? activeBtn.getAttribute("data-status") : "Ready";
        try { filterServiceOrders(currentFilter); } catch(e){ console.warn("filterServiceOrders failed:", e); }

      } else {
        alert("‚ùå Failed to mark service as done: " + (res && res.error ? res.error : "Unknown error"));
      }
    })
    .withFailureHandler(function (err) {
      try { hideLoading && hideLoading(); } catch(e){console.warn(e)}
      if (btn) {
        btn.disabled = false;
        btn.innerText = btn._origText || "‚úÖ Yes, Done";
      }
      console.error("markServiceDone failed:", err);
      alert("‚ùå Failed to mark service as done (network/server error).");
    })
    .markServiceDone(currentServiceDoneOrderId);
}

function openCancelOrderModal(orderId) {
  currentCancelOrderId = orderId;
  const modal = document.getElementById("cancelOrderModal");
  if (modal) {
    modal.style.display = "flex";
  } else {
    // fallback to the unified confirm modal
    openCancelConfirm(orderId);
    return;
  }

  const btn = document.getElementById("confirmCancelOrderBtn");
  if (btn) {
    btn.onclick = confirmCancelOrder;
  } else {
    // fallback to safer confirm path
    console.warn("confirmCancelOrderBtn not found ‚Äî using openCancelConfirm fallback");
    openCancelConfirm(orderId);
  }
}


function closeCancelOrderModal() {
  currentCancelOrderId = null;
  document.getElementById("cancelOrderModal").style.display = "none";
}


function confirmCancelOrder() {
  if (!currentCancelOrderId) return;

  const btn = document.getElementById("confirmCancelOrderBtn");
  if (btn) {
    btn.disabled = true;
    btn.innerText = "‚è≥ Cancelling...";
  }

  try { showLoading && showLoading("Cancelling order..."); } catch (e) {}

  google.script.run
    .withSuccessHandler(function (res) {
      try { hideLoading && hideLoading(); } catch (e) {}
      if (btn) {
        btn.disabled = false;
        btn.innerText = "‚úÖ Yes, Cancel";
      }

      if (res === true || (res && res.success)) {
        // ‚úÖ Update local cache so UI updates instantly
        if (Array.isArray(window.ordersData)) {
          const idx = window.ordersData.findIndex(
            o => String(o.OrderID) === String(currentCancelOrderId)
          );
          if (idx > -1) window.ordersData[idx].Status = "Cancelled";
        }

        closeCancelOrderModal();

        if (typeof showSuccessModal === "function") {
          showSuccessModal("‚úÖ Order has been cancelled!");
        } else {
          alert("‚úÖ Order has been cancelled!");
        }

        // ‚úÖ Re-render using renderOrders (not renderMyPurchases)
        try {
          renderOrders(window.ordersData || []);
        } catch (e) {
          console.warn("renderOrders failed:", e);
        }

      } else {
        alert("‚ùå Failed to cancel order: " + (res.error || "Unknown error"));
      }
    })
    .withFailureHandler(function (err) {
      try { hideLoading && hideLoading(); } catch (e) {}
      if (btn) {
        btn.disabled = false;
        btn.innerText = "‚úÖ Yes, Cancel";
      }
      console.error("cancelOrderById failed:", err);
      alert("‚ùå Failed to cancel order (server error).");
    })
    .cancelOrderById(currentCancelOrderId); // ‚úÖ call your Apps Script function
}

function submitPasuyo() {
  if (!ensureLoggedIn()) return; // üîê must be logged in

  const notes = document.getElementById("pasuyoNotes").value.trim();
  const deliveryTime = document.getElementById("deliveryTime").value;

  // collect food list + qty
  const foodNames = [...document.querySelectorAll("#foodListContainer .foodName")]
    .map(el => el.value.trim())
    .filter(Boolean);

  const foodQtys = [...document.querySelectorAll("#foodListContainer .foodQty")]
    .map(el => parseInt(el.value) || 0);

  if (foodNames.length === 0) {
    alert("Please add at least one food item.");
    return;
  }
  if (!deliveryTime) {
    alert("Please select a delivery time.");
    return;
  }

  // compute total
  const serviceFee = 10;
  const totalQty = foodQtys.reduce((a, b) => a + b, 0);
  const totalAmount = serviceFee + totalQty;

  // ‚úÖ Ensure CustomerID is passed
  const customerId = window.currentCustomer?.id || localStorage.getItem("customerId") || "";
  const uniqueCode = window.currentCustomer?.uniqueCode || localStorage.getItem("uniqueCode") || "";

  // payload for backend
  const orderData = {
    ServiceID: "SVC003",             // Pasuyo
    SellerID: "S003",                // Pasuyo Seller from Services sheet
    CustomerID: customerId,          // ‚úÖ always include CustomerID
    UniqueCode: uniqueCode,          // ‚úÖ keep UniqueCode for consistency
    Message: notes,
    FoodList: foodNames.join("; "),
    FoodAmounts: foodQtys.join("; "),
    TotalAmount: totalAmount,
    ServiceOption: "Delivery",
    DeliveryTime: deliveryTime
  };

  // üîπ Change button state
  const btn = document.querySelector("#pasuyoModal button[onclick='submitPasuyo()']");
  if (btn) {
    btn.disabled = true;
    btn.innerText = "‚è≥ Processing...";
    btn.style.background = "#999";
  }

  google.script.run.withSuccessHandler(() => {
    closePasuyoModal();

    // reset button
    if (btn) {
      btn.disabled = false;
      btn.innerText = "‚úÖ Submit Request";
      btn.style.background = "#27ae60";
    }

    // üîπ Show dedicated Pasuyo success modal
    if (typeof showPasuyoSuccessModal === "function") {
      showPasuyoSuccessModal();
    } else {
      alert("‚úÖ Pasuyo request submitted!\n\nReminder: The staff will meet you 10 minutes before your chosen delivery time. Please prepare the fee, payment is required before delivery.");
    }

    // refresh My Orders list
    if (typeof loadMyServiceOrders === "function") {
      loadMyServiceOrders();
    }
  }).withFailureHandler(err => {
    console.error("‚ùå submitPasuyo failed:", err);

    if (btn) {
      btn.disabled = false;
      btn.innerText = "‚ùå Try Again";
      btn.style.background = "#c0392b";
    } else {
      alert("Failed to submit Pasuyo request. Please try again.");
    }
  }).submitServiceOrder(orderData); // üîπ same backend entry point as Printing
}








// Add new food row
function addFoodRow() {
  const container = document.getElementById("foodListContainer");
  const row = document.createElement("div");
  row.style.marginBottom = "14px";
  row.style.padding = "10px";
  row.style.border = "1px solid #ddd";
  row.style.borderRadius = "8px";
  row.style.background = "#fafafa";

  row.innerHTML = `
    <label style="font-weight:600; display:block; margin-bottom:4px;">Food Item & Qty</label>
    <input type="text" class="foodName" placeholder="e.g. Siopao x1, Juice x1" 
           style="width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; margin-bottom:10px;">

    <label style="font-weight:600; display:block; margin-bottom:4px;">‚Ç± Amount</label>
    <input type="number" class="foodQty" placeholder="Enter amount" min="0"
           style="width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; margin-bottom:10px;">

    <div style="text-align:right;">
      <button type="button"
              style="padding:6px 12px; background:#e74c3c; color:#fff; border:none; border-radius:6px; cursor:pointer;">
        ‚úñ Remove
      </button>
    </div>
  `;

  // add delete handler
  row.querySelector("button").onclick = function() {
    row.remove();
    updatePasuyoTotal();
  };

  // üîπ recalc total whenever amount changes
  row.querySelector(".foodQty").addEventListener("input", updatePasuyoTotal);

  container.appendChild(row);

  // run once to include new row
  updatePasuyoTotal();
}



// Update total (service fee + qty)
function updatePasuyoTotal() {
  const qtys = [...document.querySelectorAll("#foodListContainer .foodQty")];
  let totalItems = qtys.reduce((sum, input) => sum + (parseInt(input.value) || 0), 0);

  const serviceFee = 10;
  const total = serviceFee + totalItems; // example: ‚Ç±1 per qty item + service fee

  document.getElementById("pasuyoTotal").innerHTML =
    `Service Fee: ‚Ç±${serviceFee.toFixed(2)} <br>Total: ‚Ç±${total.toFixed(2)}`;
}

// Load delivery times from server
function loadDeliveryTimes() {
  google.script.run.withSuccessHandler(function(times) {
    const select = document.getElementById("deliveryTime");
    select.innerHTML = ""; // clear old options

    times.forEach(t => {
      if (t.Available === "Yes") {
        let opt = document.createElement("option");
        opt.value = t.OptionID;
        opt.textContent = t.TimeSlot;
        select.appendChild(opt);
      }
    });

    if (!select.options.length) {
      select.innerHTML = "<option value=''>No slots available</option>";
    }
  }).getDeliveryTimes(); // <-- implement in code.gs to fetch Delivery Times sheet
}

function showPasuyoSuccessModal() {
  const modal = document.getElementById("pasuyoSuccessModal");
  if (modal) modal.style.display = "flex";
}

function closePasuyoSuccessModal() {
  const modal = document.getElementById("pasuyoSuccessModal");
  if (modal) modal.style.display = "none";
}

// Preload services via Apps Script
document.addEventListener("DOMContentLoaded", () => {
  google.script.run.withSuccessHandler(function(data) {
    try {
      const services = Array.isArray(data) ? data : JSON.parse(data);
      window.cachedServices = services;  // ‚úÖ cache for later use
      console.log("‚úÖ Services preloaded", services);
    } catch (e) {
      console.error("‚ö†Ô∏è Failed to parse services during preload:", e, data);
    }
  }).getServices();
});

function onTelegramAuth(user) {
  // user contains: id, first_name, last_name, username, photo_url, auth_date, hash

  google.script.run
    .withSuccessHandler(function(result) {
      if (result && result.customerId && result.uniqueCode) {
        // Save session locally
        localStorage.setItem("customerId", result.customerId);
        localStorage.setItem("uniqueCode", result.uniqueCode);

        // Store Telegram info for UI
        localStorage.setItem("customerName", user.first_name + " " + (user.last_name || ""));
        localStorage.setItem("telegramUsername", user.username || "");
        localStorage.setItem("telegramPhoto", user.photo_url || "");

        console.log("‚úÖ Logged in via Telegram:", user);

        // Refresh header UI instantly
        if (typeof updateLoginStatusUI === "function") updateLoginStatusUI(true);

        // Close modal
        closeLoginModal();

        // Reload UI (optional if you already refresh header)
        location.reload();
      } else {
        alert("‚ùå Login failed. Please try again.");
      }
    })
    .withFailureHandler(function(err) {
      console.error("Telegram login error:", err);
      alert("‚ùå Login error. Please try again.");
    })
    .loginCustomer(
      user.id, 
      user.first_name, 
      user.last_name, 
      user.username, 
      user.photo_url
    );
}




  </script>

</body>
</html>
